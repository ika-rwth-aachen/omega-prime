
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://ika-rwth-aachen.github.io/omega-prime/api/">
      
      
        <link rel="prev" href="../cli/">
      
      
      
        
      
      
      <link rel="icon" href="../logo/omega-prime-no-text.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>API - Omega-Prime</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#api" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Omega-Prime" class="md-header__button md-logo" aria-label="Omega-Prime" data-md-component="logo">
      
  <img src="../logo/omega-prime-no-text.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Omega-Prime
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              API
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Omega-Prime" class="md-nav__button md-logo" aria-label="Omega-Prime" data-md-component="logo">
      
  <img src="../logo/omega-prime-no-text.svg" alt="logo">

    </a>
    Omega-Prime
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    omega-prime
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../omega_prime_specification/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Data Model & Specification
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Python Library
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Python Library
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../library/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../map_segmentation/map_segmentation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Map Segmentation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Tutorials
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tutorials
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/tutorial/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Inroduction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/tutorial_locator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Locator
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/tutorial_metrics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Metrics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/tutorial_map/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Map Segmentation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CLI
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    API
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    API
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#omega_prime.recording" class="md-nav__link">
    <span class="md-ellipsis">
      
        recording
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.recording.Recording" class="md-nav__link">
    <span class="md-ellipsis">
      
        Recording
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Recording">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#omega_prime.recording.Recording.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.recording.Recording.apply_projections" class="md-nav__link">
    <span class="md-ellipsis">
      
        apply_projections
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.recording.Recording.from_file" class="md-nav__link">
    <span class="md-ellipsis">
      
        from_file
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.recording.Recording.interpolate" class="md-nav__link">
    <span class="md-ellipsis">
      
        interpolate
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.recording.Recording.plot" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.recording.Recording.plot_altair" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_altair
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.recording.Recording.plot_frame" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_frame
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.recording.Recording.plot_mvs" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_mvs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.recording.Recording.plot_tl" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_tl
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.recording.Recording.to_file" class="md-nav__link">
    <span class="md-ellipsis">
      
        to_file
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.recording.Recording.to_mcap" class="md-nav__link">
    <span class="md-ellipsis">
      
        to_mcap
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.recording.Recording.to_parquet" class="md-nav__link">
    <span class="md-ellipsis">
      
        to_parquet
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.map" class="md-nav__link">
    <span class="md-ellipsis">
      
        map
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.map.Map" class="md-nav__link">
    <span class="md-ellipsis">
      
        Map
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Map">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#omega_prime.map.Map.align_predecessor_and_successor_relations" class="md-nav__link">
    <span class="md-ellipsis">
      
        align_predecessor_and_successor_relations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.map.Map.from_file" class="md-nav__link">
    <span class="md-ellipsis">
      
        from_file
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.map.Map.map_to_centerline_mcap" class="md-nav__link">
    <span class="md-ellipsis">
      
        map_to_centerline_mcap
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.map.MapOsi" class="md-nav__link">
    <span class="md-ellipsis">
      
        MapOsi
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.map.MapOsiCenterline" class="md-nav__link">
    <span class="md-ellipsis">
      
        MapOsiCenterline
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.map.split_linestring" class="md-nav__link">
    <span class="md-ellipsis">
      
        split_linestring
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.map_odr" class="md-nav__link">
    <span class="md-ellipsis">
      
        map_odr
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.map_odr.MapOdr" class="md-nav__link">
    <span class="md-ellipsis">
      
        MapOdr
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MapOdr">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#omega_prime.map_odr.MapOdr.to_file" class="md-nav__link">
    <span class="md-ellipsis">
      
        to_file
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.locator" class="md-nav__link">
    <span class="md-ellipsis">
      
        locator
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.locator.Locator" class="md-nav__link">
    <span class="md-ellipsis">
      
        Locator
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Locator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#omega_prime.locator.Locator.get_single_lane_association" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_single_lane_association
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.locator.Locator.query_centerlines" class="md-nav__link">
    <span class="md-ellipsis">
      
        query_centerlines
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.locator.get_lane_centerline" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_lane_centerline
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.converters.converter" class="md-nav__link">
    <span class="md-ellipsis">
      
        converter
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.converters.converter.DatasetConverter" class="md-nav__link">
    <span class="md-ellipsis">
      
        DatasetConverter
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DatasetConverter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#omega_prime.converters.converter.DatasetConverter.get_recording_name" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_recording_name
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.converters.converter.DatasetConverter.get_recordings" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_recordings
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.converters.converter.DatasetConverter.get_source_recordings" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_source_recordings
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.converters.converter.DatasetConverter.to_omega_prime_recording" class="md-nav__link">
    <span class="md-ellipsis">
      
        to_omega_prime_recording
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        metrics
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.metrics.Metric" class="md-nav__link">
    <span class="md-ellipsis">
      
        Metric
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Metric">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#omega_prime.metrics.Metric.compute_func" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_func
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.metrics.Metric.computes_columns" class="md-nav__link">
    <span class="md-ellipsis">
      
        computes_columns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.metrics.Metric.computes_intermediate_columns" class="md-nav__link">
    <span class="md-ellipsis">
      
        computes_intermediate_columns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.metrics.Metric.computes_intermediate_properties" class="md-nav__link">
    <span class="md-ellipsis">
      
        computes_intermediate_properties
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.metrics.Metric.computes_properties" class="md-nav__link">
    <span class="md-ellipsis">
      
        computes_properties
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.metrics.Metric.requires_columns" class="md-nav__link">
    <span class="md-ellipsis">
      
        requires_columns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.metrics.Metric.requires_properties" class="md-nav__link">
    <span class="md-ellipsis">
      
        requires_properties
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.metrics.MetricManager" class="md-nav__link">
    <span class="md-ellipsis">
      
        MetricManager
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MetricManager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#omega_prime.metrics.MetricManager.exclude_columns" class="md-nav__link">
    <span class="md-ellipsis">
      
        exclude_columns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.metrics.MetricManager.exclude_properties" class="md-nav__link">
    <span class="md-ellipsis">
      
        exclude_properties
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.metrics.MetricManager.metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        metrics
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.metrics.distance_traveled" class="md-nav__link">
    <span class="md-ellipsis">
      
        distance_traveled
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.metrics.metric" class="md-nav__link">
    <span class="md-ellipsis">
      
        metric
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.metrics.p_timegaps_and_min_p_timgaps" class="md-nav__link">
    <span class="md-ellipsis">
      
        p_timegaps_and_min_p_timgaps
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.metrics.timegaps_and_min_timgaps" class="md-nav__link">
    <span class="md-ellipsis">
      
        timegaps_and_min_timgaps
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.metrics.vel" class="md-nav__link">
    <span class="md-ellipsis">
      
        vel
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.mapsegment" class="md-nav__link">
    <span class="md-ellipsis">
      
        mapsegment
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.mapsegment.MapSegmentType" class="md-nav__link">
    <span class="md-ellipsis">
      
        MapSegmentType
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.mapsegment.MapSegmentation" class="md-nav__link">
    <span class="md-ellipsis">
      
        MapSegmentation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MapSegmentation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#omega_prime.mapsegment.MapSegmentation.check_if_all_lanes_are_on_segment" class="md-nav__link">
    <span class="md-ellipsis">
      
        check_if_all_lanes_are_on_segment
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.mapsegment.MapSegmentation.create_lane_dict" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_lane_dict
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.mapsegment.MapSegmentation.get_lane_successors_and_predecessors" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_lane_successors_and_predecessors
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.mapsegment.Segment" class="md-nav__link">
    <span class="md-ellipsis">
      
        Segment
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Segment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#omega_prime.mapsegment.Segment.add_lane" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_lane
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.mapsegment.Segment.create_segment_polygon" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_segment_polygon
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.mapsegment.Segment.get_center_point" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_center_point
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.mapsegment.Segment.get_timeinterval_on_segment" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_timeinterval_on_segment
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.mapsegment.Segment.set_trafficlight" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_trafficlight
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.mapsegment.Segment.update_polygon" class="md-nav__link">
    <span class="md-ellipsis">
      
        update_polygon
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation" class="md-nav__link">
    <span class="md-ellipsis">
      
        maposicenterlinesegmentation
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.ConnectionSegment" class="md-nav__link">
    <span class="md-ellipsis">
      
        ConnectionSegment
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ConnectionSegment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.ConnectionSegment.plot" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation" class="md-nav__link">
    <span class="md-ellipsis">
      
        MapOsiCenterlineSegmentation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MapOsiCenterlineSegmentation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.add_non_intersecting_lanes_to_intersection" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_non_intersecting_lanes_to_intersection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.combine_intersection_on_polygon" class="md-nav__link">
    <span class="md-ellipsis">
      
        combine_intersection_on_polygon
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.combine_intersections" class="md-nav__link">
    <span class="md-ellipsis">
      
        combine_intersections
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.combine_isolated_connections" class="md-nav__link">
    <span class="md-ellipsis">
      
        combine_isolated_connections
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.create_intersection_dict" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_intersection_dict
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.create_lane_segment_dict" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_lane_segment_dict
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.create_non_intersecting_lane_graph" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_non_intersecting_lane_graph
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.create_parallel_lane_dict" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_parallel_lane_dict
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.find_isolated_connections" class="md-nav__link">
    <span class="md-ellipsis">
      
        find_isolated_connections
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.get_intersecting_lanes" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_intersecting_lanes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.graph_intersection_detection" class="md-nav__link">
    <span class="md-ellipsis">
      
        graph_intersection_detection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.init_intersections" class="md-nav__link">
    <span class="md-ellipsis">
      
        init_intersections
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.intersections_overlap" class="md-nav__link">
    <span class="md-ellipsis">
      
        intersections_overlap
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.plot" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.plot_intersections" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_intersections
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.set_intersection_idx" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_intersection_idx
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.set_lane_intersection_relation" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_lane_intersection_relation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.set_lane_trafficlights" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_lane_trafficlights
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.trajectory_segment_detection" class="md-nav__link">
    <span class="md-ellipsis">
      
        trajectory_segment_detection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.update_road_ids" class="md-nav__link">
    <span class="md-ellipsis">
      
        update_road_ids
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.update_segment_ids" class="md-nav__link">
    <span class="md-ellipsis">
      
        update_segment_ids
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.SegmentOsiCenterline" class="md-nav__link">
    <span class="md-ellipsis">
      
        SegmentOsiCenterline
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.add_lanexy_to_graph" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_lanexy_to_graph
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.plot_graph" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_graph
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#omega_prime.recording" class="md-nav__link">
    <span class="md-ellipsis">
      
        recording
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.recording.Recording" class="md-nav__link">
    <span class="md-ellipsis">
      
        Recording
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Recording">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#omega_prime.recording.Recording.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.recording.Recording.apply_projections" class="md-nav__link">
    <span class="md-ellipsis">
      
        apply_projections
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.recording.Recording.from_file" class="md-nav__link">
    <span class="md-ellipsis">
      
        from_file
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.recording.Recording.interpolate" class="md-nav__link">
    <span class="md-ellipsis">
      
        interpolate
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.recording.Recording.plot" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.recording.Recording.plot_altair" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_altair
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.recording.Recording.plot_frame" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_frame
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.recording.Recording.plot_mvs" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_mvs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.recording.Recording.plot_tl" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_tl
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.recording.Recording.to_file" class="md-nav__link">
    <span class="md-ellipsis">
      
        to_file
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.recording.Recording.to_mcap" class="md-nav__link">
    <span class="md-ellipsis">
      
        to_mcap
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.recording.Recording.to_parquet" class="md-nav__link">
    <span class="md-ellipsis">
      
        to_parquet
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.map" class="md-nav__link">
    <span class="md-ellipsis">
      
        map
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.map.Map" class="md-nav__link">
    <span class="md-ellipsis">
      
        Map
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Map">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#omega_prime.map.Map.align_predecessor_and_successor_relations" class="md-nav__link">
    <span class="md-ellipsis">
      
        align_predecessor_and_successor_relations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.map.Map.from_file" class="md-nav__link">
    <span class="md-ellipsis">
      
        from_file
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.map.Map.map_to_centerline_mcap" class="md-nav__link">
    <span class="md-ellipsis">
      
        map_to_centerline_mcap
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.map.MapOsi" class="md-nav__link">
    <span class="md-ellipsis">
      
        MapOsi
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.map.MapOsiCenterline" class="md-nav__link">
    <span class="md-ellipsis">
      
        MapOsiCenterline
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.map.split_linestring" class="md-nav__link">
    <span class="md-ellipsis">
      
        split_linestring
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.map_odr" class="md-nav__link">
    <span class="md-ellipsis">
      
        map_odr
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.map_odr.MapOdr" class="md-nav__link">
    <span class="md-ellipsis">
      
        MapOdr
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MapOdr">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#omega_prime.map_odr.MapOdr.to_file" class="md-nav__link">
    <span class="md-ellipsis">
      
        to_file
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.locator" class="md-nav__link">
    <span class="md-ellipsis">
      
        locator
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.locator.Locator" class="md-nav__link">
    <span class="md-ellipsis">
      
        Locator
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Locator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#omega_prime.locator.Locator.get_single_lane_association" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_single_lane_association
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.locator.Locator.query_centerlines" class="md-nav__link">
    <span class="md-ellipsis">
      
        query_centerlines
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.locator.get_lane_centerline" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_lane_centerline
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.converters.converter" class="md-nav__link">
    <span class="md-ellipsis">
      
        converter
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.converters.converter.DatasetConverter" class="md-nav__link">
    <span class="md-ellipsis">
      
        DatasetConverter
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DatasetConverter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#omega_prime.converters.converter.DatasetConverter.get_recording_name" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_recording_name
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.converters.converter.DatasetConverter.get_recordings" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_recordings
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.converters.converter.DatasetConverter.get_source_recordings" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_source_recordings
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.converters.converter.DatasetConverter.to_omega_prime_recording" class="md-nav__link">
    <span class="md-ellipsis">
      
        to_omega_prime_recording
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        metrics
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.metrics.Metric" class="md-nav__link">
    <span class="md-ellipsis">
      
        Metric
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Metric">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#omega_prime.metrics.Metric.compute_func" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_func
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.metrics.Metric.computes_columns" class="md-nav__link">
    <span class="md-ellipsis">
      
        computes_columns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.metrics.Metric.computes_intermediate_columns" class="md-nav__link">
    <span class="md-ellipsis">
      
        computes_intermediate_columns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.metrics.Metric.computes_intermediate_properties" class="md-nav__link">
    <span class="md-ellipsis">
      
        computes_intermediate_properties
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.metrics.Metric.computes_properties" class="md-nav__link">
    <span class="md-ellipsis">
      
        computes_properties
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.metrics.Metric.requires_columns" class="md-nav__link">
    <span class="md-ellipsis">
      
        requires_columns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.metrics.Metric.requires_properties" class="md-nav__link">
    <span class="md-ellipsis">
      
        requires_properties
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.metrics.MetricManager" class="md-nav__link">
    <span class="md-ellipsis">
      
        MetricManager
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MetricManager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#omega_prime.metrics.MetricManager.exclude_columns" class="md-nav__link">
    <span class="md-ellipsis">
      
        exclude_columns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.metrics.MetricManager.exclude_properties" class="md-nav__link">
    <span class="md-ellipsis">
      
        exclude_properties
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.metrics.MetricManager.metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        metrics
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.metrics.distance_traveled" class="md-nav__link">
    <span class="md-ellipsis">
      
        distance_traveled
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.metrics.metric" class="md-nav__link">
    <span class="md-ellipsis">
      
        metric
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.metrics.p_timegaps_and_min_p_timgaps" class="md-nav__link">
    <span class="md-ellipsis">
      
        p_timegaps_and_min_p_timgaps
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.metrics.timegaps_and_min_timgaps" class="md-nav__link">
    <span class="md-ellipsis">
      
        timegaps_and_min_timgaps
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.metrics.vel" class="md-nav__link">
    <span class="md-ellipsis">
      
        vel
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.mapsegment" class="md-nav__link">
    <span class="md-ellipsis">
      
        mapsegment
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.mapsegment.MapSegmentType" class="md-nav__link">
    <span class="md-ellipsis">
      
        MapSegmentType
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.mapsegment.MapSegmentation" class="md-nav__link">
    <span class="md-ellipsis">
      
        MapSegmentation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MapSegmentation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#omega_prime.mapsegment.MapSegmentation.check_if_all_lanes_are_on_segment" class="md-nav__link">
    <span class="md-ellipsis">
      
        check_if_all_lanes_are_on_segment
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.mapsegment.MapSegmentation.create_lane_dict" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_lane_dict
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.mapsegment.MapSegmentation.get_lane_successors_and_predecessors" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_lane_successors_and_predecessors
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.mapsegment.Segment" class="md-nav__link">
    <span class="md-ellipsis">
      
        Segment
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Segment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#omega_prime.mapsegment.Segment.add_lane" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_lane
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.mapsegment.Segment.create_segment_polygon" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_segment_polygon
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.mapsegment.Segment.get_center_point" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_center_point
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.mapsegment.Segment.get_timeinterval_on_segment" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_timeinterval_on_segment
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.mapsegment.Segment.set_trafficlight" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_trafficlight
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.mapsegment.Segment.update_polygon" class="md-nav__link">
    <span class="md-ellipsis">
      
        update_polygon
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation" class="md-nav__link">
    <span class="md-ellipsis">
      
        maposicenterlinesegmentation
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.ConnectionSegment" class="md-nav__link">
    <span class="md-ellipsis">
      
        ConnectionSegment
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ConnectionSegment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.ConnectionSegment.plot" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation" class="md-nav__link">
    <span class="md-ellipsis">
      
        MapOsiCenterlineSegmentation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MapOsiCenterlineSegmentation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.add_non_intersecting_lanes_to_intersection" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_non_intersecting_lanes_to_intersection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.combine_intersection_on_polygon" class="md-nav__link">
    <span class="md-ellipsis">
      
        combine_intersection_on_polygon
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.combine_intersections" class="md-nav__link">
    <span class="md-ellipsis">
      
        combine_intersections
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.combine_isolated_connections" class="md-nav__link">
    <span class="md-ellipsis">
      
        combine_isolated_connections
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.create_intersection_dict" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_intersection_dict
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.create_lane_segment_dict" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_lane_segment_dict
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.create_non_intersecting_lane_graph" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_non_intersecting_lane_graph
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.create_parallel_lane_dict" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_parallel_lane_dict
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.find_isolated_connections" class="md-nav__link">
    <span class="md-ellipsis">
      
        find_isolated_connections
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.get_intersecting_lanes" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_intersecting_lanes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.graph_intersection_detection" class="md-nav__link">
    <span class="md-ellipsis">
      
        graph_intersection_detection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.init_intersections" class="md-nav__link">
    <span class="md-ellipsis">
      
        init_intersections
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.intersections_overlap" class="md-nav__link">
    <span class="md-ellipsis">
      
        intersections_overlap
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.plot" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.plot_intersections" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_intersections
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.set_intersection_idx" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_intersection_idx
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.set_lane_intersection_relation" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_lane_intersection_relation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.set_lane_trafficlights" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_lane_trafficlights
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.trajectory_segment_detection" class="md-nav__link">
    <span class="md-ellipsis">
      
        trajectory_segment_detection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.update_road_ids" class="md-nav__link">
    <span class="md-ellipsis">
      
        update_road_ids
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.update_segment_ids" class="md-nav__link">
    <span class="md-ellipsis">
      
        update_segment_ids
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.SegmentOsiCenterline" class="md-nav__link">
    <span class="md-ellipsis">
      
        SegmentOsiCenterline
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.add_lanexy_to_graph" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_lanexy_to_graph
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omega_prime.maposicenterlinesegmentation.plot_graph" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_graph
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="api">API</h1>


<div class="doc doc-object doc-module">



<a id="omega_prime.recording"></a>
    <div class="doc doc-contents first">










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="omega_prime.recording.Recording" class="doc doc-heading">
            <code>Recording</code>


</h2>


    <div class="doc doc-contents ">



        <p>Class representing a continuous traffic observation. Usually corresponds to one omega-prime file.</p>
<p>Internally, the Recording uses a Polars DataFrame to store moving object data. Each row in the DataFrame
represents the state of a moving object at a specific timestamp.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="omega_prime.recording.Recording.df">df</span></code></td>
            <td>
                  <code><span title="polars.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Polars DataFrame containing the moving object data.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="omega_prime.recording.Recording.map">map</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" href="#omega_prime.map.MapOsi">MapOsi</a> | <a class="autorefs autorefs-internal" href="#omega_prime.map.MapOsiCenterline">MapOsiCenterline</a> | <a class="autorefs autorefs-internal" href="#omega_prime.map_odr.MapOdr">MapOdr</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Map associated with the recording.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="omega_prime.recording.Recording.projections">projections</span></code></td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Projection metadata with structure
<code>{"proj_string": str | None, None: ProjectionOffset | None, int: ProjectionOffset | None}</code>.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="omega_prime.recording.Recording.traffic_light_states">traffic_light_states</span></code></td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping timestamps to traffic light states.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="omega_prime.recording.Recording.host_vehicle_idx">host_vehicle_idx</span></code></td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Index of the host vehicle, if applicable.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>omega_prime/recording.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 107</span>
<span class="normal"> 108</span>
<span class="normal"> 109</span>
<span class="normal"> 110</span>
<span class="normal"> 111</span>
<span class="normal"> 112</span>
<span class="normal"> 113</span>
<span class="normal"> 114</span>
<span class="normal"> 115</span>
<span class="normal"> 116</span>
<span class="normal"> 117</span>
<span class="normal"> 118</span>
<span class="normal"> 119</span>
<span class="normal"> 120</span>
<span class="normal"> 121</span>
<span class="normal"> 122</span>
<span class="normal"> 123</span>
<span class="normal"> 124</span>
<span class="normal"> 125</span>
<span class="normal"> 126</span>
<span class="normal"> 127</span>
<span class="normal"> 128</span>
<span class="normal"> 129</span>
<span class="normal"> 130</span>
<span class="normal"> 131</span>
<span class="normal"> 132</span>
<span class="normal"> 133</span>
<span class="normal"> 134</span>
<span class="normal"> 135</span>
<span class="normal"> 136</span>
<span class="normal"> 137</span>
<span class="normal"> 138</span>
<span class="normal"> 139</span>
<span class="normal"> 140</span>
<span class="normal"> 141</span>
<span class="normal"> 142</span>
<span class="normal"> 143</span>
<span class="normal"> 144</span>
<span class="normal"> 145</span>
<span class="normal"> 146</span>
<span class="normal"> 147</span>
<span class="normal"> 148</span>
<span class="normal"> 149</span>
<span class="normal"> 150</span>
<span class="normal"> 151</span>
<span class="normal"> 152</span>
<span class="normal"> 153</span>
<span class="normal"> 154</span>
<span class="normal"> 155</span>
<span class="normal"> 156</span>
<span class="normal"> 157</span>
<span class="normal"> 158</span>
<span class="normal"> 159</span>
<span class="normal"> 160</span>
<span class="normal"> 161</span>
<span class="normal"> 162</span>
<span class="normal"> 163</span>
<span class="normal"> 164</span>
<span class="normal"> 165</span>
<span class="normal"> 166</span>
<span class="normal"> 167</span>
<span class="normal"> 168</span>
<span class="normal"> 169</span>
<span class="normal"> 170</span>
<span class="normal"> 171</span>
<span class="normal"> 172</span>
<span class="normal"> 173</span>
<span class="normal"> 174</span>
<span class="normal"> 175</span>
<span class="normal"> 176</span>
<span class="normal"> 177</span>
<span class="normal"> 178</span>
<span class="normal"> 179</span>
<span class="normal"> 180</span>
<span class="normal"> 181</span>
<span class="normal"> 182</span>
<span class="normal"> 183</span>
<span class="normal"> 184</span>
<span class="normal"> 185</span>
<span class="normal"> 186</span>
<span class="normal"> 187</span>
<span class="normal"> 188</span>
<span class="normal"> 189</span>
<span class="normal"> 190</span>
<span class="normal"> 191</span>
<span class="normal"> 192</span>
<span class="normal"> 193</span>
<span class="normal"> 194</span>
<span class="normal"> 195</span>
<span class="normal"> 196</span>
<span class="normal"> 197</span>
<span class="normal"> 198</span>
<span class="normal"> 199</span>
<span class="normal"> 200</span>
<span class="normal"> 201</span>
<span class="normal"> 202</span>
<span class="normal"> 203</span>
<span class="normal"> 204</span>
<span class="normal"> 205</span>
<span class="normal"> 206</span>
<span class="normal"> 207</span>
<span class="normal"> 208</span>
<span class="normal"> 209</span>
<span class="normal"> 210</span>
<span class="normal"> 211</span>
<span class="normal"> 212</span>
<span class="normal"> 213</span>
<span class="normal"> 214</span>
<span class="normal"> 215</span>
<span class="normal"> 216</span>
<span class="normal"> 217</span>
<span class="normal"> 218</span>
<span class="normal"> 219</span>
<span class="normal"> 220</span>
<span class="normal"> 221</span>
<span class="normal"> 222</span>
<span class="normal"> 223</span>
<span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Recording</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class representing a continuous traffic observation. Usually corresponds to one omega-prime file.</span>

<span class="sd">    Internally, the Recording uses a Polars DataFrame to store moving object data. Each row in the DataFrame</span>
<span class="sd">    represents the state of a moving object at a specific timestamp.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        df (pl.DataFrame): Polars DataFrame containing the moving object data.</span>
<span class="sd">        map (MapOsi | MapOsiCenterline | MapOdr | None): Map associated with the recording.</span>
<span class="sd">        projections (dict): Projection metadata with structure</span>
<span class="sd">            `{&quot;proj_string&quot;: str | None, None: ProjectionOffset | None, int: ProjectionOffset | None}`.</span>
<span class="sd">        traffic_light_states (dict): Dictionary mapping timestamps to traffic light states.</span>
<span class="sd">        host_vehicle_idx (int | None): Index of the host vehicle, if applicable.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_MovingObjectClass</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">ClassVar</span> <span class="o">=</span> <span class="n">MovingObject</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_offset_components</span><span class="p">(</span>
        <span class="n">offset</span><span class="p">:</span> <span class="n">ProjectionOffset</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="s2">&quot;Extract components from a ProjectionOffset, returning zeros if the offset is None.&quot;</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="n">offset</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">offset</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">offset</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">offset</span><span class="o">.</span><span class="n">yaw</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_encode_projections</span><span class="p">(</span>
        <span class="n">projections</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="s2">&quot;Encode projection metadata into a JSON string and then to bytes&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">projections</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_serialize_offset</span><span class="p">(</span><span class="n">offset</span><span class="p">:</span> <span class="n">ProjectionOffset</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">offset</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">offset</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">offset</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="s2">&quot;yaw&quot;</span><span class="p">:</span> <span class="n">offset</span><span class="o">.</span><span class="n">yaw</span><span class="p">}</span>

        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;proj_string&quot;</span><span class="p">:</span> <span class="n">projections</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;proj_string&quot;</span><span class="p">),</span>
            <span class="s2">&quot;offsets&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;total_nanos&quot;</span><span class="p">:</span> <span class="n">ts</span><span class="p">,</span>
                    <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="n">_serialize_offset</span><span class="p">(</span><span class="n">offset</span><span class="p">),</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">ts</span><span class="p">,</span> <span class="n">offset</span> <span class="ow">in</span> <span class="n">projections</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">ts</span> <span class="o">!=</span> <span class="s2">&quot;proj_string&quot;</span>
            <span class="p">],</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_decode_projections</span><span class="p">(</span>
        <span class="n">raw</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]:</span>
        <span class="s2">&quot;Decode projection metadata from bytes or string to a dictionary.&quot;</span>
        <span class="k">if</span> <span class="n">raw</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="n">result</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;proj_string&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;proj_string&quot;</span><span class="p">)}</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;offsets&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">offset_data</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;offset&quot;</span><span class="p">)</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">ProjectionOffset</span><span class="p">(</span><span class="o">**</span><span class="n">offset_data</span><span class="p">)</span> <span class="k">if</span> <span class="n">offset_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">ts</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_projections_schema</span><span class="p">(</span>
        <span class="n">projections</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate the schema of the projections dictionary, ensuring correct types and structure.</span>
<span class="sd">        Projection metadata with structure:</span>
<span class="sd">            `{&quot;proj_string&quot;: str | None, None: ProjectionOffset | None, int: ProjectionOffset | None}`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">projections</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">projections</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;`projections` must be a dictionary.&quot;</span><span class="p">)</span>

        <span class="n">validated</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s2">&quot;proj_string&quot;</span> <span class="ow">in</span> <span class="n">projections</span><span class="p">:</span>
            <span class="n">validated</span><span class="p">[</span><span class="s2">&quot;proj_string&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">projections</span><span class="p">[</span><span class="s2">&quot;proj_string&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">projections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;proj_string&quot;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Projection keys must be integers, `None`, or `proj_string`.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ProjectionOffset</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Projection values must be `ProjectionOffset` or `None`.&quot;</span><span class="p">)</span>

            <span class="n">validated</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">return</span> <span class="n">validated</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_projection_for_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">total_nanos</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ProjectionOffset</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="n">source_proj_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projections</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;proj_string&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">source_proj_string</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">source_proj_string</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span> <span class="s2">&quot;proj_string&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">total_nanos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">projections</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projections</span><span class="p">[</span><span class="n">total_nanos</span><span class="p">]</span>
        <span class="k">elif</span> <span class="kc">None</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">projections</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projections</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">source_proj_string</span><span class="p">,</span> <span class="n">offset</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_moving_object_ground_truth</span><span class="p">(</span>
        <span class="n">nanos</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">host_vehicle_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">validate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">betterosi</span><span class="o">.</span><span class="n">GroundTruth</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
            <span class="n">recording_moving_object_schema</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_object</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">betterosi</span><span class="o">.</span><span class="n">MovingObject</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">betterosi</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">]),</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">betterosi</span><span class="o">.</span><span class="n">MovingObjectType</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]),</span>
                <span class="n">base</span><span class="o">=</span><span class="n">betterosi</span><span class="o">.</span><span class="n">BaseMoving</span><span class="p">(</span>
                    <span class="n">dimension</span><span class="o">=</span><span class="n">betterosi</span><span class="o">.</span><span class="n">Dimension3D</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;length&quot;</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">],</span> <span class="n">height</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]),</span>
                    <span class="n">position</span><span class="o">=</span><span class="n">betterosi</span><span class="o">.</span><span class="n">Vector3D</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]),</span>
                    <span class="n">orientation</span><span class="o">=</span><span class="n">betterosi</span><span class="o">.</span><span class="n">Orientation3D</span><span class="p">(</span><span class="n">roll</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;roll&quot;</span><span class="p">],</span> <span class="n">pitch</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">],</span> <span class="n">yaw</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;yaw&quot;</span><span class="p">]),</span>
                    <span class="n">velocity</span><span class="o">=</span><span class="n">betterosi</span><span class="o">.</span><span class="n">Vector3D</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;vel_x&quot;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;vel_y&quot;</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;vel_z&quot;</span><span class="p">]),</span>
                    <span class="n">acceleration</span><span class="o">=</span><span class="n">betterosi</span><span class="o">.</span><span class="n">Vector3D</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;acc_x&quot;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;acc_y&quot;</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;acc_z&quot;</span><span class="p">]),</span>
                <span class="p">),</span>
                <span class="n">vehicle_classification</span><span class="o">=</span><span class="n">betterosi</span><span class="o">.</span><span class="n">MovingObjectVehicleClassification</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;subtype&quot;</span><span class="p">],</span> <span class="n">role</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="n">mvs</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_object</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iter_rows</span><span class="p">(</span><span class="n">named</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
        <span class="n">gt</span> <span class="o">=</span> <span class="n">betterosi</span><span class="o">.</span><span class="n">GroundTruth</span><span class="p">(</span>
            <span class="n">version</span><span class="o">=</span><span class="n">betterosi</span><span class="o">.</span><span class="n">InterfaceVersion</span><span class="p">(</span><span class="n">version_major</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">version_minor</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">version_patch</span><span class="o">=</span><span class="mi">9</span><span class="p">),</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">betterosi</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">nanos</span> <span class="o">//</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e9</span><span class="p">)),</span> <span class="n">nanos</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">nanos</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e9</span><span class="p">))),</span>
            <span class="n">host_vehicle_id</span><span class="o">=</span><span class="p">(</span>
                <span class="n">betterosi</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">host_vehicle_idx</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="n">betterosi</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">host_vehicle_idx</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="n">moving_object</span><span class="o">=</span><span class="n">mvs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">gt</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_polars_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="s2">&quot;Ensure that the input data is a Polars DataFrame with the correct schema, converting if necessary.&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">df</span>
        <span class="k">return</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">schema_overrides</span><span class="o">=</span><span class="n">polars_schema</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_build_frame_mapping</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
        <span class="s2">&quot;Build a mapping from `total_nanos` to frame numbers and return both the mapping and a DataFrame for joining.&quot;</span>
        <span class="n">nanos2frame</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())}</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;total_nanos&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">nanos2frame</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                <span class="s2">&quot;frame&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">nanos2frame</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="p">},</span>
            <span class="n">schema</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">total_nanos</span><span class="o">=</span><span class="n">polars_schema</span><span class="p">[</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">],</span> <span class="n">frame</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">UInt32</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">nanos2frame</span><span class="p">,</span> <span class="n">mapping</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_attach_frame_column</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">mapping</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;frame&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;frame&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_motion_norm_columns</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">exprs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s2">&quot;vel&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">exprs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vel_x&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vel_y&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;vel&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="s2">&quot;acc&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">exprs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;acc_x&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;acc_y&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;acc&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">exprs</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="o">*</span><span class="n">exprs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="nb">map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">projections</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">host_vehicle_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">traffic_light_states</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="s2">&quot;Initialize a Recording instance.&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_polars_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;total_nanos&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;df must contain column `total_nanos`.&quot;</span><span class="p">)</span>
        <span class="n">nanos2frame</span><span class="p">,</span> <span class="n">mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_frame_mapping</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attach_frame_column</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_polars_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
            <span class="n">recording_moving_object_schema</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nanos2frame</span> <span class="o">=</span> <span class="n">nanos2frame</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_motion_norm_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_projections_schema</span><span class="p">(</span><span class="n">projections</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">traffic_light_states</span> <span class="o">=</span> <span class="n">traffic_light_states</span> <span class="k">if</span> <span class="n">traffic_light_states</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">bbx_to_polygon</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="n">df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="nb">map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_moving_objects</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host_vehicle_idx</span> <span class="o">=</span> <span class="n">host_vehicle_idx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapsegment</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">df</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">host_vehicle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">moving_objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host_vehicle_idx</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">moving_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_moving_objects</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mv_df</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;length&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;subtype&quot;</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;frame&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;birth&quot;</span><span class="p">),</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;frame&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">),</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;t_birth&quot;</span><span class="p">),</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;t_end&quot;</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">map_elements</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">betterosi</span><span class="o">.</span><span class="n">MovingObjectType</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">return_dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">),</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;subtype&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">map_elements</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">betterosi</span><span class="o">.</span><span class="n">MovingObjectVehicleClassificationType</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),</span>
                        <span class="n">return_dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">map_elements</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">betterosi</span><span class="o">.</span><span class="n">MovingObjectVehicleClassificationRole</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),</span>
                        <span class="n">return_dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_moving_objects</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MovingObjectClass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()}</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_moving_objects</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_df_with_original_pose_for_export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a DataFrame with original pose columns (`x_original`, `y_original`, `z_original`, `yaw_original`)</span>
<span class="sd">        for export, if they exist. This is used to ensure that the original pose information is preserved when</span>
<span class="sd">        exporting to formats like Parquet or MCAP,</span>
<span class="sd">        even if the main `x`, `y`, `z`, and `yaw` columns have been modified by projections.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df_export</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">df</span>
        <span class="n">original_to_base</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;x_original&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span>
            <span class="s2">&quot;y_original&quot;</span><span class="p">:</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span>
            <span class="s2">&quot;z_original&quot;</span><span class="p">:</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span>
            <span class="s2">&quot;yaw_original&quot;</span><span class="p">:</span> <span class="s2">&quot;yaw&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">overwrite_exprs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">original_col</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">base_col</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">original_col</span><span class="p">,</span> <span class="n">base_col</span> <span class="ow">in</span> <span class="n">original_to_base</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">original_col</span> <span class="ow">in</span> <span class="n">df_export</span><span class="o">.</span><span class="n">columns</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">overwrite_exprs</span><span class="p">:</span>
            <span class="n">df_export</span> <span class="o">=</span> <span class="n">df_export</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="o">*</span><span class="n">overwrite_exprs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df_export</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_osi_gts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">betterosi</span><span class="o">.</span><span class="n">GroundTruth</span><span class="p">]:</span>
        <span class="n">first_iteration</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">df_export</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df_with_original_pose_for_export</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">[</span><span class="n">nanos</span><span class="p">],</span> <span class="n">group_df</span> <span class="ow">in</span> <span class="n">df_export</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">,</span> <span class="n">maintain_order</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">gt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_moving_object_ground_truth</span><span class="p">(</span>
                <span class="n">nanos</span><span class="p">,</span> <span class="n">group_df</span><span class="p">,</span> <span class="n">host_vehicle_idx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host_vehicle_idx</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">source_proj_string</span><span class="p">,</span> <span class="n">proj_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_projection_for_timestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nanos</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">source_proj_string</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">gt</span><span class="o">.</span><span class="n">proj_string</span> <span class="o">=</span> <span class="n">source_proj_string</span>
            <span class="k">if</span> <span class="n">proj_offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">gt</span><span class="o">.</span><span class="n">proj_frame_offset</span> <span class="o">=</span> <span class="n">betterosi</span><span class="o">.</span><span class="n">GroundTruthProjFrameOffset</span><span class="p">(</span>
                    <span class="n">position</span><span class="o">=</span><span class="n">betterosi</span><span class="o">.</span><span class="n">Vector3D</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">proj_offset</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">proj_offset</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">proj_offset</span><span class="o">.</span><span class="n">z</span><span class="p">),</span>
                    <span class="n">yaw</span><span class="o">=</span><span class="n">proj_offset</span><span class="o">.</span><span class="n">yaw</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">first_iteration</span><span class="p">:</span>
                <span class="n">first_iteration</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span> <span class="n">MapOsi</span> <span class="o">|</span> <span class="n">MapOsiCenterline</span><span class="p">):</span>
                    <span class="n">gt</span><span class="o">.</span><span class="n">lane_boundary</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">_osi</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">lane_boundaries</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
                    <span class="n">gt</span><span class="o">.</span><span class="n">lane</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">_osi</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
            <span class="k">if</span> <span class="n">nanos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">traffic_light_states</span><span class="p">:</span>
                <span class="n">gt</span><span class="o">.</span><span class="n">traffic_light</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traffic_light_states</span><span class="p">[</span><span class="n">nanos</span><span class="p">]</span>
            <span class="k">yield</span> <span class="n">gt</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_osi_gts</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">gts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">betterosi</span><span class="o">.</span><span class="n">GroundTruth</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">projs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;proj_string&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="n">traffic_light_states</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">gts</span><span class="p">,</span> <span class="n">tmp_gts</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">tee</span><span class="p">(</span><span class="n">gts</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">first_gt</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">tmp_gts</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">first_gt</span><span class="o">.</span><span class="n">host_vehicle_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">host_vehicle_idx</span> <span class="o">=</span> <span class="n">first_gt</span><span class="o">.</span><span class="n">host_vehicle_id</span><span class="o">.</span><span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">host_vehicle_idx</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_gts</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">gt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gts</span><span class="p">):</span>
                <span class="n">total_nanos</span> <span class="o">=</span> <span class="n">gt</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">seconds</span> <span class="o">*</span> <span class="mi">1_000_000_000</span> <span class="o">+</span> <span class="n">gt</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">nanos</span>
                <span class="k">if</span> <span class="n">gt</span><span class="o">.</span><span class="n">proj_frame_offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">gt</span><span class="o">.</span><span class="n">proj_frame_offset</span><span class="o">.</span><span class="n">position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Offset of </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">th ground truth message (total_nanos=</span><span class="si">{</span><span class="n">total_nanos</span><span class="si">}</span><span class="s2">) is set without position.&quot;</span>
                    <span class="p">)</span>

                <span class="n">projs</span><span class="p">[</span><span class="n">total_nanos</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">ProjectionOffset</span><span class="p">(</span>
                        <span class="n">x</span><span class="o">=</span><span class="n">gt</span><span class="o">.</span><span class="n">proj_frame_offset</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                        <span class="n">y</span><span class="o">=</span><span class="n">gt</span><span class="o">.</span><span class="n">proj_frame_offset</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                        <span class="n">z</span><span class="o">=</span><span class="n">gt</span><span class="o">.</span><span class="n">proj_frame_offset</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                        <span class="n">yaw</span><span class="o">=</span><span class="n">gt</span><span class="o">.</span><span class="n">proj_frame_offset</span><span class="o">.</span><span class="n">yaw</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">gt</span><span class="o">.</span><span class="n">proj_frame_offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="k">else</span> <span class="kc">None</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">gt</span><span class="o">.</span><span class="n">proj_string</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">normalized_proj_string</span> <span class="o">=</span> <span class="n">gt</span><span class="o">.</span><span class="n">proj_string</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">normalized_proj_string</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">projs</span><span class="p">[</span><span class="s2">&quot;proj_string&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">projs</span><span class="p">[</span><span class="s2">&quot;proj_string&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">normalized_proj_string</span>
                        <span class="k">elif</span> <span class="n">projs</span><span class="p">[</span><span class="s2">&quot;proj_string&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">normalized_proj_string</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Conflicting projection strings: </span><span class="si">{</span><span class="n">projs</span><span class="p">[</span><span class="s1">&#39;proj_string&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">normalized_proj_string</span><span class="si">}</span><span class="s2"> at gt index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> (total_nanos=</span><span class="si">{</span><span class="n">total_nanos</span><span class="si">}</span><span class="s2">).&quot;</span>
                            <span class="p">)</span>

                <span class="n">traffic_light_states</span><span class="p">[</span><span class="n">total_nanos</span><span class="p">]</span> <span class="o">=</span> <span class="n">gt</span><span class="o">.</span><span class="n">traffic_light</span>

                <span class="k">for</span> <span class="n">mv</span> <span class="ow">in</span> <span class="n">gt</span><span class="o">.</span><span class="n">moving_object</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="nb">dict</span><span class="p">(</span>
                        <span class="n">total_nanos</span><span class="o">=</span><span class="n">total_nanos</span><span class="p">,</span>
                        <span class="n">idx</span><span class="o">=</span><span class="n">mv</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                        <span class="n">x</span><span class="o">=</span><span class="n">mv</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                        <span class="n">y</span><span class="o">=</span><span class="n">mv</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                        <span class="n">z</span><span class="o">=</span><span class="n">mv</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                        <span class="n">vel_x</span><span class="o">=</span><span class="n">mv</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">velocity</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                        <span class="n">vel_y</span><span class="o">=</span><span class="n">mv</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">velocity</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                        <span class="n">vel_z</span><span class="o">=</span><span class="n">mv</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">velocity</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                        <span class="n">acc_x</span><span class="o">=</span><span class="n">mv</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">acceleration</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                        <span class="n">acc_y</span><span class="o">=</span><span class="n">mv</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">acceleration</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                        <span class="n">acc_z</span><span class="o">=</span><span class="n">mv</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">acceleration</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                        <span class="n">length</span><span class="o">=</span><span class="n">mv</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">dimension</span><span class="o">.</span><span class="n">length</span><span class="p">,</span>
                        <span class="n">width</span><span class="o">=</span><span class="n">mv</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">dimension</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                        <span class="n">height</span><span class="o">=</span><span class="n">mv</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">dimension</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
                        <span class="n">roll</span><span class="o">=</span><span class="n">mv</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">roll</span><span class="p">,</span>
                        <span class="n">pitch</span><span class="o">=</span><span class="n">mv</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">pitch</span><span class="p">,</span>
                        <span class="n">yaw</span><span class="o">=</span><span class="n">mv</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">yaw</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="n">mv</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                        <span class="n">role</span><span class="o">=</span><span class="p">(</span>
                            <span class="n">mv</span><span class="o">.</span><span class="n">vehicle_classification</span><span class="o">.</span><span class="n">role</span> <span class="k">if</span> <span class="n">mv</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">betterosi</span><span class="o">.</span><span class="n">MovingObjectType</span><span class="o">.</span><span class="n">TYPE_VEHICLE</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                        <span class="p">),</span>
                        <span class="n">subtype</span><span class="o">=</span><span class="p">(</span>
                            <span class="n">mv</span><span class="o">.</span><span class="n">vehicle_classification</span><span class="o">.</span><span class="n">type</span> <span class="k">if</span> <span class="n">mv</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">betterosi</span><span class="o">.</span><span class="n">MovingObjectType</span><span class="o">.</span><span class="n">TYPE_VEHICLE</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                        <span class="p">),</span>
                    <span class="p">)</span>

        <span class="n">df_mv</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">get_gts</span><span class="p">(),</span> <span class="n">schema</span><span class="o">=</span><span class="n">polars_schema</span><span class="p">)</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">,</span> <span class="s2">&quot;idx&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">df_mv</span><span class="p">,</span>
            <span class="n">projections</span><span class="o">=</span><span class="n">projs</span><span class="p">,</span>
            <span class="n">host_vehicle_idx</span><span class="o">=</span><span class="n">host_vehicle_idx</span><span class="p">,</span>
            <span class="n">traffic_light_states</span><span class="o">=</span><span class="n">traffic_light_states</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_mcap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="s2">&quot;Store Recording as an MCAP file.&quot;</span>
        <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s2">&quot;.mcap&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">betterosi</span><span class="o">.</span><span class="n">Writer</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">w</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">gt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_osi_gts</span><span class="p">():</span>
                <span class="n">w</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gt</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span> <span class="n">MapOdr</span><span class="p">):</span>
                <span class="n">w</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">to_osi</span><span class="p">(),</span> <span class="n">topic</span><span class="o">=</span><span class="s2">&quot;ground_truth_map&quot;</span><span class="p">,</span> <span class="n">log_time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span> <span class="n">MapOsi</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span> <span class="n">MapOsiCenterline</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The map </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="si">}</span><span class="s2"> could not be saved to `mcap`&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_parquet</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">parse_map</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">step_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">schema_overrides</span><span class="o">=</span><span class="n">polars_schema</span><span class="p">)</span>
        <span class="n">host_vehicle_idx</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">projections</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="nb">map</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="k">if</span> <span class="sa">b</span><span class="s2">&quot;host_vehicle_idx&quot;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
                <span class="n">host_vehicle_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="sa">b</span><span class="s2">&quot;host_vehicle_idx&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>

            <span class="n">projections</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_decode_projections</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;projections_json&quot;</span><span class="p">))</span>

            <span class="n">map_parsing</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">MC</span> <span class="ow">in</span> <span class="n">MAP_CLASSES</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">MC</span><span class="o">.</span><span class="n">_binary_json_identifier</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="nb">map</span> <span class="o">=</span> <span class="n">MC</span><span class="o">.</span><span class="n">_from_binary_json</span><span class="p">(</span>
                            <span class="n">metadata</span><span class="p">,</span>
                            <span class="n">parse_map</span><span class="o">=</span><span class="n">parse_map</span><span class="p">,</span>
                            <span class="n">step_size</span><span class="o">=</span><span class="n">step_size</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">map_parsing</span><span class="p">[</span><span class="n">MC</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">break</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">df</span><span class="p">,</span>
            <span class="nb">map</span><span class="o">=</span><span class="nb">map</span><span class="p">,</span>
            <span class="n">host_vehicle_idx</span><span class="o">=</span><span class="n">host_vehicle_idx</span><span class="p">,</span>
            <span class="n">projections</span><span class="o">=</span><span class="n">projections</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_parquet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="s2">&quot;Store Recording as a Parquet file.&quot;</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">host_vehicle_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metadata</span><span class="p">[</span><span class="sa">b</span><span class="s2">&quot;host_vehicle_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host_vehicle_idx</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="n">proj_meta</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">encoded_projections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode_projections</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projections</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">encoded_projections</span><span class="p">:</span>
            <span class="n">proj_meta</span><span class="p">[</span><span class="sa">b</span><span class="s2">&quot;projections_json&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">encoded_projections</span>
        <span class="n">df_export</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df_with_original_pose_for_export</span><span class="p">()</span>
        <span class="n">to_drop</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;frame&quot;</span><span class="p">]</span>
        <span class="n">optional_cols</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;polygon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;global_lat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;global_lon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;global_alt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;global_yaw&quot;</span><span class="p">,</span>
            <span class="s2">&quot;proj_string&quot;</span><span class="p">,</span>
            <span class="s2">&quot;x_original&quot;</span><span class="p">,</span>
            <span class="s2">&quot;y_original&quot;</span><span class="p">,</span>
            <span class="s2">&quot;z_original&quot;</span><span class="p">,</span>
            <span class="s2">&quot;yaw_original&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">to_drop</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">optional_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df_export</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">pyarrow</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">df_export</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="o">*</span><span class="n">to_drop</span><span class="p">))</span>
        <span class="n">map_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">_to_binary_json</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">with_metadata</span><span class="p">(</span><span class="n">metadata</span> <span class="o">|</span> <span class="n">proj_meta</span> <span class="o">|</span> <span class="n">map_meta</span><span class="p">))</span>
        <span class="n">pq</span><span class="o">.</span><span class="n">write_table</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_file</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">filepath</span><span class="p">,</span>
        <span class="n">map_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">validate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">parse_map</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">step_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
        <span class="n">apply_proj</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Recording&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load a Recording from a file. Supports `.parquet`, `.osi` and `.mcap` files.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            filepath (str): Path to the input file.</span>
<span class="sd">            map_path (str | None): Optional path to a map file. If None, the map will be loaded from the recording if available.</span>
<span class="sd">            validate (bool): Whether to validate the data against the schema.</span>
<span class="sd">            parse_map (bool): Whether to create python objects from the map data or just load it.</span>
<span class="sd">            step_size (float): Step size for map parsing, if applicable (Used for ASAM OpenDRIVE).</span>
<span class="sd">            apply_proj (bool): Whether to apply projection transformations to the recording&#39;s moving object data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Recording (Recording): The loaded Recording object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">map_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either `filepath` or `map_path` must be provided.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.parquet&quot;</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_parquet</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">parse_map</span><span class="o">=</span><span class="n">parse_map</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="n">step_size</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gts</span> <span class="o">=</span> <span class="n">betterosi</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">return_ground_truth</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mcap_return_betterosi</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_osi_gts</span><span class="p">(</span><span class="n">gts</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">map_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">r</span>

        <span class="n">map_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">map_path</span> <span class="k">if</span> <span class="n">map_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">filepath</span><span class="p">)</span>
        <span class="n">map_parsing</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="nb">map</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">MC</span> <span class="ow">in</span> <span class="n">MAP_CLASSES</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">map_path</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="n">MC</span><span class="o">.</span><span class="n">_supported_file_suffixes</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">map</span> <span class="o">=</span> <span class="n">MC</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">map_path</span><span class="p">,</span> <span class="n">parse_map</span><span class="o">=</span><span class="n">parse_map</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">map_parsing</span><span class="p">[</span><span class="n">MC</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="nb">map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="nb">map</span>
        <span class="k">elif</span> <span class="n">r</span><span class="o">.</span><span class="n">map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No map could be found: </span><span class="si">{</span><span class="n">map_parsing</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">projections</span> <span class="ow">and</span> <span class="n">apply_proj</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">r</span><span class="o">.</span><span class="n">apply_projections</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Failed to apply projections.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="s2">&quot;Store Recording to a file based on its suffix (`.parquet`, `.mcap`).&quot;</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.parquet&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.mcap&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">to_mcap</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported file suffix `</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">`. Expected one of: `.parquet`, `.mcap`.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">apply_projections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply projection transformations to the recording&#39;s moving object data based on the provided projection metadata</span>
<span class="sd">        and the map&#39;s projection. This method updates the `x`, `y`, and `z` columns of the recording&#39;s DataFrame</span>
<span class="sd">        according to the specified projections and transforms the coordinates to the target CRS if necessary.</span>
<span class="sd">        The original coordinates before applying projections are stored in `x_original`, `y_original`, and `z_original`</span>
<span class="sd">        columns to preserve the original pose information for export or reference.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">height</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="n">source_proj_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projections</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;proj_string&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">source_proj_string</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
            <span class="n">source_proj_string</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span> <span class="s2">&quot;proj_string&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">source_proj_string</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No proj_string information available on the recording or attached map.&quot;</span><span class="p">)</span>

        <span class="n">frame_projections</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ts</span><span class="p">,</span> <span class="n">offset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">projections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">ts</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;proj_string&quot;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">ox</span><span class="p">,</span> <span class="n">oy</span><span class="p">,</span> <span class="n">oz</span><span class="p">,</span> <span class="n">oyaw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset_components</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
            <span class="n">frame_projections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">total_nanos</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span>
                    <span class="n">offset_x</span><span class="o">=</span><span class="n">ox</span><span class="p">,</span>
                    <span class="n">offset_y</span><span class="o">=</span><span class="n">oy</span><span class="p">,</span>
                    <span class="n">offset_z</span><span class="o">=</span><span class="n">oz</span><span class="p">,</span>
                    <span class="n">offset_yaw</span><span class="o">=</span><span class="n">oyaw</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span>

        <span class="n">default_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projections</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">dox</span><span class="p">,</span> <span class="n">doy</span><span class="p">,</span> <span class="n">doz</span><span class="p">,</span> <span class="n">doyaw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset_components</span><span class="p">(</span><span class="n">default_offset</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">frame_projections</span><span class="p">:</span>
            <span class="n">proj_df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">frame_projections</span><span class="p">,</span>
                <span class="n">schema</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;total_nanos&quot;</span><span class="p">:</span> <span class="n">polars_schema</span><span class="p">[</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;offset_x&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">,</span>
                    <span class="s2">&quot;offset_y&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">,</span>
                    <span class="s2">&quot;offset_z&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">,</span>
                    <span class="s2">&quot;offset_yaw&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">proj_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">source_proj_string</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;proj_string&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;offset_x&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="n">dox</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;offset_x&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;offset_y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="n">doy</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;offset_y&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;offset_z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="n">doz</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;offset_z&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;offset_yaw&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="n">doyaw</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;offset_yaw&quot;</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">source_proj_string</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;proj_string&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">dox</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;offset_x&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">doy</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;offset_y&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">doz</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;offset_z&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">doyaw</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;offset_yaw&quot;</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="n">source_crs</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">CRS</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">source_proj_string</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;proj_string&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_null</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">())</span><span class="o">.</span><span class="n">item</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Some rows do not have a projection string assigned.&quot;</span><span class="p">)</span>

        <span class="c1"># Store original values before applying offsets, when it is the first projection</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;x_original&quot;</span><span class="p">,</span> <span class="s2">&quot;y_original&quot;</span><span class="p">,</span> <span class="s2">&quot;z_original&quot;</span><span class="p">]):</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;x_original&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;y_original&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;z_original&quot;</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># Update main columns with offset values</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;offset_yaw&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;offset_yaw&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sin</span><span class="p">()</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;offset_x&quot;</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">),</span>
            <span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;offset_yaw&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sin</span><span class="p">()</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;offset_yaw&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;offset_y&quot;</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;offset_z&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
        <span class="n">target_crs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">projection</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_crs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Map does not have a valid projection defined.&quot;</span><span class="p">)</span>

        <span class="c1"># Apply 2D proj string transformation</span>
        <span class="n">transformer</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Transformer</span><span class="o">.</span><span class="n">from_crs</span><span class="p">(</span><span class="n">source_crs</span><span class="p">,</span> <span class="n">target_crs</span><span class="p">)</span>
        <span class="n">x_tgt</span><span class="p">,</span> <span class="n">y_tgt</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">x_tgt</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">y_tgt</span><span class="p">))</span>

        <span class="c1"># From map world to map local</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">proj_offset</span><span class="p">:</span>
            <span class="n">m_ox</span><span class="p">,</span> <span class="n">m_oy</span><span class="p">,</span> <span class="n">m_oz</span><span class="p">,</span> <span class="n">m_oyaw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset_components</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">proj_offset</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">m_ox</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">m_oyaw</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">m_oy</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">m_oyaw</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">),</span>
                <span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">m_oy</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">m_oyaw</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">m_ox</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">m_oyaw</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">m_oz</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">bbx_to_polygon</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># Remove temporary projection columns</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;proj_string&quot;</span><span class="p">,</span> <span class="s2">&quot;offset_x&quot;</span><span class="p">,</span> <span class="s2">&quot;offset_y&quot;</span><span class="p">,</span> <span class="s2">&quot;offset_z&quot;</span><span class="p">,</span> <span class="s2">&quot;offset_yaw&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="n">df</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_nanos</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">hz</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="s2">&quot;Interpolate the recording to new timestamps or a given frequency.&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span>
        <span class="n">nanos_min</span><span class="p">,</span> <span class="n">nanos_max</span><span class="p">,</span> <span class="n">frame_min</span><span class="p">,</span> <span class="n">frame_max</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
            <span class="n">nanos_min</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
            <span class="n">nanos_max</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
            <span class="n">frame_min</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;frame&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
            <span class="n">frame_max</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;frame&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">row</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_nanos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">new_nanos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">nanos_min</span><span class="p">,</span> <span class="n">nanos_max</span><span class="p">,</span> <span class="n">frame_max</span> <span class="o">-</span> <span class="n">frame_min</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">step</span> <span class="o">=</span> <span class="mf">1e9</span> <span class="o">/</span> <span class="n">hz</span>
                <span class="n">new_nanos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">nanos_min</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">nanos_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_nanos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_nanos</span><span class="p">)</span>
        <span class="n">new_dfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">track_df</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">):</span>
            <span class="n">track_data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">track_new_nanos</span> <span class="o">=</span> <span class="n">new_nanos</span><span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">track_df</span><span class="p">[</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">new_nanos</span><span class="p">,</span>
                    <span class="n">track_df</span><span class="p">[</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">new_nanos</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;x&quot;</span><span class="p">,</span>
                <span class="s2">&quot;y&quot;</span><span class="p">,</span>
                <span class="s2">&quot;z&quot;</span><span class="p">,</span>
                <span class="s2">&quot;vel_x&quot;</span><span class="p">,</span>
                <span class="s2">&quot;vel_y&quot;</span><span class="p">,</span>
                <span class="s2">&quot;vel_z&quot;</span><span class="p">,</span>
                <span class="s2">&quot;acc_x&quot;</span><span class="p">,</span>
                <span class="s2">&quot;acc_y&quot;</span><span class="p">,</span>
                <span class="s2">&quot;acc_z&quot;</span><span class="p">,</span>
                <span class="s2">&quot;length&quot;</span><span class="p">,</span>
                <span class="s2">&quot;width&quot;</span><span class="p">,</span>
                <span class="s2">&quot;height&quot;</span><span class="p">,</span>
            <span class="p">]:</span>
                <span class="n">track_data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">track_new_nanos</span><span class="p">,</span> <span class="n">track_df</span><span class="p">[</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">],</span> <span class="n">track_df</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;subtype&quot;</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">]:</span>
                <span class="n">track_data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">nearest_interp</span><span class="p">(</span>
                    <span class="n">track_new_nanos</span><span class="p">,</span>
                    <span class="n">track_df</span><span class="p">[</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                    <span class="n">track_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                <span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;roll&quot;</span><span class="p">,</span> <span class="s2">&quot;pitch&quot;</span><span class="p">,</span> <span class="s2">&quot;yaw&quot;</span><span class="p">]:</span>
                <span class="c1"># Unwrap angles to handle discontinuities, then interpolate, then wrap back to [-, ]</span>
                <span class="n">unwrapped_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">track_df</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
                <span class="n">interpolated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">track_new_nanos</span><span class="p">,</span> <span class="n">track_df</span><span class="p">[</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">],</span> <span class="n">unwrapped_angles</span><span class="p">)</span>
                <span class="n">track_data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">interpolated</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="n">new_track_df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">track_data</span><span class="p">)</span>
            <span class="n">new_track_df</span> <span class="o">=</span> <span class="n">new_track_df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;idx&quot;</span><span class="p">,</span>
                    <span class="n">values</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">track_new_nanos</span><span class="p">)</span> <span class="o">*</span> <span class="n">idx</span><span class="p">,</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="n">polars_schema</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">],</span>
                <span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">,</span>
                    <span class="n">values</span><span class="o">=</span><span class="n">track_new_nanos</span><span class="p">,</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="n">polars_schema</span><span class="p">[</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">],</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">new_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_track_df</span><span class="p">)</span>
        <span class="n">new_df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">new_dfs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">new_df</span><span class="p">,</span> <span class="nb">map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span> <span class="n">host_vehicle_idx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host_vehicle_idx</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_legend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
        <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="n">host_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">host_vehicle_idx</span><span class="si">}</span><span class="s2"> - HV&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">sort_key</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="n">host_label</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">))</span>  <span class="c1"># non-numeric labels go last</span>

        <span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">handles</span><span class="p">,</span> <span class="n">labels</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">sort_key</span><span class="p">)</span>
        <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">items</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center left&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ax</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mvs_plt_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;scatter&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
        <span class="s2">&quot;Generate a static plot of the recording using Matplotlib. Plots the map (if available), moving objects, and traffic light states.&quot;</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_mvs</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">mvs_plt_type</span><span class="o">=</span><span class="n">mvs_plt_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_tl</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_legend</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_mvs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mvs_plt_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;scatter&quot;</span><span class="p">):</span>
        <span class="s2">&quot;Generate a static plot of the moving objects in the recording using Matplotlib.&quot;</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plot_fn</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;scatter&quot;</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">,</span> <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mvs_plt_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`mvs_plt_type` must be one of: &#39;scatter&#39;, &#39;plot&#39;.&quot;</span><span class="p">)</span>

        <span class="n">plot_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]</span>
        <span class="n">base_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}</span>
        <span class="k">for</span> <span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">mv</span> <span class="ow">in</span> <span class="n">plot_df</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">host_vehicle_idx</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">mv</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> - HV&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">plot_fn</span><span class="p">(</span><span class="o">*</span><span class="n">mv</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span> <span class="o">**</span><span class="n">base_kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_legend</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_tl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="s2">&quot;Generate a static plot of the traffic lights in the recording using Matplotlib.&quot;</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">tl_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">tl_states</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">traffic_light_states</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">traffic_light_states</span><span class="p">[</span><span class="n">tl_states</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">tl</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tl_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">tl_dict</span><span class="p">[</span><span class="n">tl</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">tl</span>

        <span class="k">for</span> <span class="n">tl</span> <span class="ow">in</span> <span class="n">tl_dict</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">tl_dict</span><span class="p">[</span><span class="n">tl</span><span class="p">]</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">tl_dict</span><span class="p">[</span><span class="n">tl</span><span class="p">]</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">,</span>
                    <span class="n">y</span><span class="p">,</span>
                    <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Traffic Light </span><span class="si">{</span><span class="n">tl_dict</span><span class="p">[</span><span class="n">tl</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">c</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                    <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Skipping traffic light </span><span class="si">{</span><span class="n">tl</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> due to missing position data: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
        <span class="k">return</span> <span class="n">ax</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="s2">&quot;Generate a static plot of a specific frame in the recording using Matplotlib.&quot;</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_mv_frame</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">frame</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_mv_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">polys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;frame&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">frame</span><span class="p">)[</span><span class="s2">&quot;polygon&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">polys</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">PltPolygon</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_altair</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">start_frame</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">end_frame</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">plot_map</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">plot_map_polys</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">metric_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">plot_wedges</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">height</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">:</span>
        <span class="s2">&quot;Generate an interactive plot of the recording using Altair.&quot;</span>
        <span class="k">if</span> <span class="n">end_frame</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;frame&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">end_frame</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;frame&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">start_frame</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;frame&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">start_frame</span><span class="p">)</span>

        <span class="p">[</span><span class="n">frame_min</span><span class="p">],</span> <span class="p">[</span><span class="n">frame_max</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;frame&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">),</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;frame&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;max&quot;</span><span class="p">),</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">slider</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">binding_range</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="n">frame_min</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">frame_max</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;frame&quot;</span><span class="p">)</span>
        <span class="n">op_var</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="n">slider</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">concat_str</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">map_elements</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">betterosi</span><span class="o">.</span><span class="n">MovingObjectType</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">return_dtype</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">String</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;subtype&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">map_elements</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">betterosi</span><span class="o">.</span><span class="n">MovingObjectVehicleClassificationType</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">return_dtype</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">String</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;length&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
            <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">buffer</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;xmin&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">buffer</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;xmax&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">buffer</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;ymin&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">buffer</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;ymax&quot;</span><span class="p">),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">row</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pov_df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;polygon&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">shapely</span><span class="o">.</span><span class="n">Polygon</span><span class="p">([[</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">],</span> <span class="p">[</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">],</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">],</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">]])]})</span>
        <span class="n">pov_df</span> <span class="o">=</span> <span class="n">pov_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">from_shapely</span><span class="p">(</span><span class="s2">&quot;polygon&quot;</span><span class="p">))</span>
        <span class="n">pov</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">({</span><span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="n">pov_df</span><span class="o">.</span><span class="n">st</span><span class="o">.</span><span class="n">to_dicts</span><span class="p">()})</span><span class="o">.</span><span class="n">mark_geoshape</span><span class="p">(</span><span class="n">fillOpacity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">filled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">plots</span> <span class="o">=</span> <span class="p">[</span><span class="n">pov</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">plot_map</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">plot_altair</span><span class="p">(</span><span class="n">recording</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_polys</span><span class="o">=</span><span class="n">plot_map_polys</span><span class="p">))</span>

        <span class="n">mv_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">,</span> <span class="s2">&quot;idx&quot;</span><span class="p">,</span> <span class="s2">&quot;frame&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">st</span><span class="o">.</span><span class="n">to_dicts</span><span class="p">()}</span>
        <span class="n">plots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">mv_dict</span><span class="p">)</span>
            <span class="o">.</span><span class="n">mark_geoshape</span><span class="p">()</span>
            <span class="o">.</span><span class="n">encode</span><span class="p">(</span>
                <span class="n">color</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">alt</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">alt</span><span class="o">.</span><span class="n">FieldEqualPredicate</span><span class="p">(</span><span class="n">equal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host_vehicle_idx</span> <span class="ow">or</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="s2">&quot;properties.idx&quot;</span><span class="p">))</span>
                    <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">))</span>
                    <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">alt</span><span class="o">.</span><span class="n">FieldEqualPredicate</span><span class="p">(</span><span class="n">equal</span><span class="o">=-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">idx</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="s2">&quot;properties.idx&quot;</span><span class="p">))</span>
                    <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">))</span>
                    <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="s2">&quot;blue&quot;</span><span class="p">))</span>
                <span class="p">),</span>
                <span class="n">tooltip</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;properties.idx:N&quot;</span><span class="p">,</span> <span class="s2">&quot;properties.frame:N&quot;</span><span class="p">,</span> <span class="s2">&quot;properties.type:O&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">transform_filter</span><span class="p">(</span><span class="n">alt</span><span class="o">.</span><span class="n">FieldEqualPredicate</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="s2">&quot;properties.frame&quot;</span><span class="p">,</span> <span class="n">equal</span><span class="o">=</span><span class="n">op_var</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_wedges</span><span class="p">:</span>
            <span class="n">wedges_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">,</span> <span class="s2">&quot;frame&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;yaw&quot;</span><span class="p">,</span> <span class="s2">&quot;length&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;yaw&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">degrees</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;deg&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;length&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;size&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">plots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">wedges_df</span><span class="p">)</span>
                <span class="o">.</span><span class="n">mark_point</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="s2">&quot;wedge&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">strokeWidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="o">.</span><span class="n">encode</span><span class="p">(</span>
                    <span class="n">alt</span><span class="o">.</span><span class="n">Longitude</span><span class="p">(</span><span class="s2">&quot;x:Q&quot;</span><span class="p">),</span>
                    <span class="n">alt</span><span class="o">.</span><span class="n">Latitude</span><span class="p">(</span><span class="s2">&quot;y:Q&quot;</span><span class="p">),</span>
                    <span class="n">alt</span><span class="o">.</span><span class="n">Angle</span><span class="p">(</span><span class="s2">&quot;deg&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="p">[</span><span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">180</span><span class="p">],</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">270</span><span class="p">]),</span>
                    <span class="n">alt</span><span class="o">.</span><span class="n">Size</span><span class="p">(</span><span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
                    <span class="n">tooltip</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;idx:N&quot;</span><span class="p">,</span> <span class="s2">&quot;frame:N&quot;</span><span class="p">,</span> <span class="s2">&quot;type:O&quot;</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">transform_filter</span><span class="p">(</span><span class="n">alt</span><span class="o">.</span><span class="n">FieldEqualPredicate</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="s2">&quot;frame&quot;</span><span class="p">,</span> <span class="n">equal</span><span class="o">=</span><span class="n">op_var</span><span class="p">))</span>
            <span class="p">)</span>

        <span class="n">view</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">alt</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="o">*</span><span class="n">plots</span><span class="p">)</span>
            <span class="o">.</span><span class="n">properties</span><span class="p">(</span>
                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Map&quot;</span><span class="p">,</span>
                <span class="o">**</span><span class="p">({</span><span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">height</span><span class="p">}</span> <span class="k">if</span> <span class="n">height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}),</span>
                <span class="o">**</span><span class="p">({</span><span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">width</span><span class="p">}</span> <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="s2">&quot;identity&quot;</span><span class="p">,</span> <span class="n">reflectY</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">metric_column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">,</span> <span class="n">metric_column</span><span class="p">,</span> <span class="s2">&quot;frame&quot;</span><span class="p">]</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span>
                <span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;frame&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">metric_column</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">properties</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric_column</span><span class="si">}</span><span class="s2"> of object </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">vertline</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">()</span>
                <span class="o">.</span><span class="n">mark_rule</span><span class="p">()</span>
                <span class="o">.</span><span class="n">encode</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">datum</span><span class="p">(</span>
                        <span class="n">op_var</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;quantitative&quot;</span><span class="p">,</span>
                        <span class="n">scale</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Scale</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="p">[</span><span class="n">frame_min</span><span class="p">,</span> <span class="n">frame_max</span><span class="p">]),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">view</span> <span class="o">=</span> <span class="n">view</span> <span class="o">|</span> <span class="p">(</span><span class="n">metric</span> <span class="o">+</span> <span class="n">vertline</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">view</span><span class="o">.</span><span class="n">add_params</span><span class="p">(</span><span class="n">op_var</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_mapsegments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span> <span class="n">MapOsiCenterline</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mapsegment</span> <span class="o">=</span> <span class="n">MapOsiCenterlineSegmentation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mapsegment</span><span class="o">.</span><span class="n">init_intersections</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="omega_prime.recording.Recording.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="nb">map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">projections</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">host_vehicle_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">traffic_light_states</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initialize a Recording instance.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/recording.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="nb">map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">projections</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">host_vehicle_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">traffic_light_states</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="s2">&quot;Initialize a Recording instance.&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_polars_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;total_nanos&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;df must contain column `total_nanos`.&quot;</span><span class="p">)</span>
    <span class="n">nanos2frame</span><span class="p">,</span> <span class="n">mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_frame_mapping</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attach_frame_column</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_polars_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
        <span class="n">recording_moving_object_schema</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nanos2frame</span> <span class="o">=</span> <span class="n">nanos2frame</span>

    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_motion_norm_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">projections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_projections_schema</span><span class="p">(</span><span class="n">projections</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">traffic_light_states</span> <span class="o">=</span> <span class="n">traffic_light_states</span> <span class="k">if</span> <span class="n">traffic_light_states</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">bbx_to_polygon</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="n">df</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="nb">map</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_moving_objects</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">host_vehicle_idx</span> <span class="o">=</span> <span class="n">host_vehicle_idx</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mapsegment</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.recording.Recording.apply_projections" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">apply_projections</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Apply projection transformations to the recording's moving object data based on the provided projection metadata
and the map's projection. This method updates the <code>x</code>, <code>y</code>, and <code>z</code> columns of the recording's DataFrame
according to the specified projections and transforms the coordinates to the target CRS if necessary.
The original coordinates before applying projections are stored in <code>x_original</code>, <code>y_original</code>, and <code>z_original</code>
columns to preserve the original pose information for export or reference.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/recording.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">apply_projections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply projection transformations to the recording&#39;s moving object data based on the provided projection metadata</span>
<span class="sd">    and the map&#39;s projection. This method updates the `x`, `y`, and `z` columns of the recording&#39;s DataFrame</span>
<span class="sd">    according to the specified projections and transforms the coordinates to the target CRS if necessary.</span>
<span class="sd">    The original coordinates before applying projections are stored in `x_original`, `y_original`, and `z_original`</span>
<span class="sd">    columns to preserve the original pose information for export or reference.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">height</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="n">source_proj_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projections</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;proj_string&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">source_proj_string</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
        <span class="n">source_proj_string</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span> <span class="s2">&quot;proj_string&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">source_proj_string</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No proj_string information available on the recording or attached map.&quot;</span><span class="p">)</span>

    <span class="n">frame_projections</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ts</span><span class="p">,</span> <span class="n">offset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">projections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">ts</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;proj_string&quot;</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">ox</span><span class="p">,</span> <span class="n">oy</span><span class="p">,</span> <span class="n">oz</span><span class="p">,</span> <span class="n">oyaw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset_components</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
        <span class="n">frame_projections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span>
                <span class="n">total_nanos</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span>
                <span class="n">offset_x</span><span class="o">=</span><span class="n">ox</span><span class="p">,</span>
                <span class="n">offset_y</span><span class="o">=</span><span class="n">oy</span><span class="p">,</span>
                <span class="n">offset_z</span><span class="o">=</span><span class="n">oz</span><span class="p">,</span>
                <span class="n">offset_yaw</span><span class="o">=</span><span class="n">oyaw</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span>

    <span class="n">default_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projections</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">dox</span><span class="p">,</span> <span class="n">doy</span><span class="p">,</span> <span class="n">doz</span><span class="p">,</span> <span class="n">doyaw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset_components</span><span class="p">(</span><span class="n">default_offset</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">frame_projections</span><span class="p">:</span>
        <span class="n">proj_df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">frame_projections</span><span class="p">,</span>
            <span class="n">schema</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;total_nanos&quot;</span><span class="p">:</span> <span class="n">polars_schema</span><span class="p">[</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">],</span>
                <span class="s2">&quot;offset_x&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">,</span>
                <span class="s2">&quot;offset_y&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">,</span>
                <span class="s2">&quot;offset_z&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">,</span>
                <span class="s2">&quot;offset_yaw&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">proj_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">source_proj_string</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;proj_string&quot;</span><span class="p">),</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;offset_x&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="n">dox</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;offset_x&quot;</span><span class="p">),</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;offset_y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="n">doy</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;offset_y&quot;</span><span class="p">),</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;offset_z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="n">doz</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;offset_z&quot;</span><span class="p">),</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;offset_yaw&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="n">doyaw</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;offset_yaw&quot;</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">source_proj_string</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;proj_string&quot;</span><span class="p">),</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">dox</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;offset_x&quot;</span><span class="p">),</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">doy</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;offset_y&quot;</span><span class="p">),</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">doz</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;offset_z&quot;</span><span class="p">),</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">doyaw</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;offset_yaw&quot;</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="n">source_crs</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">CRS</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">source_proj_string</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;proj_string&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_null</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">())</span><span class="o">.</span><span class="n">item</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Some rows do not have a projection string assigned.&quot;</span><span class="p">)</span>

    <span class="c1"># Store original values before applying offsets, when it is the first projection</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;x_original&quot;</span><span class="p">,</span> <span class="s2">&quot;y_original&quot;</span><span class="p">,</span> <span class="s2">&quot;z_original&quot;</span><span class="p">]):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;x_original&quot;</span><span class="p">),</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;y_original&quot;</span><span class="p">),</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;z_original&quot;</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="c1"># Update main columns with offset values</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;offset_yaw&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;offset_yaw&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sin</span><span class="p">()</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;offset_x&quot;</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">),</span>
        <span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;offset_yaw&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sin</span><span class="p">()</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;offset_yaw&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;offset_y&quot;</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;offset_z&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
    <span class="n">target_crs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">projection</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">target_crs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Map does not have a valid projection defined.&quot;</span><span class="p">)</span>

    <span class="c1"># Apply 2D proj string transformation</span>
    <span class="n">transformer</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Transformer</span><span class="o">.</span><span class="n">from_crs</span><span class="p">(</span><span class="n">source_crs</span><span class="p">,</span> <span class="n">target_crs</span><span class="p">)</span>
    <span class="n">x_tgt</span><span class="p">,</span> <span class="n">y_tgt</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">x_tgt</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">y_tgt</span><span class="p">))</span>

    <span class="c1"># From map world to map local</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">proj_offset</span><span class="p">:</span>
        <span class="n">m_ox</span><span class="p">,</span> <span class="n">m_oy</span><span class="p">,</span> <span class="n">m_oz</span><span class="p">,</span> <span class="n">m_oyaw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset_components</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">proj_offset</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">m_ox</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">m_oyaw</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">m_oy</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">m_oyaw</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">),</span>
            <span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">m_oy</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">m_oyaw</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">m_ox</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">m_oyaw</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">m_oz</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">bbx_to_polygon</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="c1"># Remove temporary projection columns</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;proj_string&quot;</span><span class="p">,</span> <span class="s2">&quot;offset_x&quot;</span><span class="p">,</span> <span class="s2">&quot;offset_y&quot;</span><span class="p">,</span> <span class="s2">&quot;offset_z&quot;</span><span class="p">,</span> <span class="s2">&quot;offset_yaw&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="n">df</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.recording.Recording.from_file" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">map_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">parse_map</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">apply_proj</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Load a Recording from a file. Supports <code>.parquet</code>, <code>.osi</code> and <code>.mcap</code> files.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>filepath</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the input file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>map_path</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional path to a map file. If None, the map will be loaded from the recording if available.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>validate</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to validate the data against the schema.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>parse_map</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to create python objects from the map data or just load it.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>step_size</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Step size for map parsing, if applicable (Used for ASAM OpenDRIVE).</p>
              </div>
            </td>
            <td>
                  <code>0.01</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>apply_proj</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to apply projection transformations to the recording's moving object data.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>Recording</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" href="#omega_prime.recording.Recording">Recording</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The loaded Recording object.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/recording.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_file</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">filepath</span><span class="p">,</span>
    <span class="n">map_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">validate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">parse_map</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">step_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
    <span class="n">apply_proj</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Recording&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load a Recording from a file. Supports `.parquet`, `.osi` and `.mcap` files.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        filepath (str): Path to the input file.</span>
<span class="sd">        map_path (str | None): Optional path to a map file. If None, the map will be loaded from the recording if available.</span>
<span class="sd">        validate (bool): Whether to validate the data against the schema.</span>
<span class="sd">        parse_map (bool): Whether to create python objects from the map data or just load it.</span>
<span class="sd">        step_size (float): Step size for map parsing, if applicable (Used for ASAM OpenDRIVE).</span>
<span class="sd">        apply_proj (bool): Whether to apply projection transformations to the recording&#39;s moving object data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Recording (Recording): The loaded Recording object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">map_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either `filepath` or `map_path` must be provided.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.parquet&quot;</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_parquet</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">parse_map</span><span class="o">=</span><span class="n">parse_map</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="n">step_size</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gts</span> <span class="o">=</span> <span class="n">betterosi</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">return_ground_truth</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mcap_return_betterosi</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_osi_gts</span><span class="p">(</span><span class="n">gts</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">map_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">r</span>

    <span class="n">map_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">map_path</span> <span class="k">if</span> <span class="n">map_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">filepath</span><span class="p">)</span>
    <span class="n">map_parsing</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="nb">map</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">MC</span> <span class="ow">in</span> <span class="n">MAP_CLASSES</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">map_path</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="n">MC</span><span class="o">.</span><span class="n">_supported_file_suffixes</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">map</span> <span class="o">=</span> <span class="n">MC</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">map_path</span><span class="p">,</span> <span class="n">parse_map</span><span class="o">=</span><span class="n">parse_map</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">map_parsing</span><span class="p">[</span><span class="n">MC</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
    <span class="k">if</span> <span class="nb">map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">r</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="nb">map</span>
    <span class="k">elif</span> <span class="n">r</span><span class="o">.</span><span class="n">map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No map could be found: </span><span class="si">{</span><span class="n">map_parsing</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">projections</span> <span class="ow">and</span> <span class="n">apply_proj</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">apply_projections</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Failed to apply projections.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.recording.Recording.interpolate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">interpolate</span><span class="p">(</span><span class="n">new_nanos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hz</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Interpolate the recording to new timestamps or a given frequency.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/recording.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_nanos</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">hz</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="s2">&quot;Interpolate the recording to new timestamps or a given frequency.&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span>
    <span class="n">nanos_min</span><span class="p">,</span> <span class="n">nanos_max</span><span class="p">,</span> <span class="n">frame_min</span><span class="p">,</span> <span class="n">frame_max</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
        <span class="n">nanos_min</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
        <span class="n">nanos_max</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
        <span class="n">frame_min</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;frame&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
        <span class="n">frame_max</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;frame&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
    <span class="p">)</span><span class="o">.</span><span class="n">row</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">new_nanos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">hz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_nanos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">nanos_min</span><span class="p">,</span> <span class="n">nanos_max</span><span class="p">,</span> <span class="n">frame_max</span> <span class="o">-</span> <span class="n">frame_min</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">step</span> <span class="o">=</span> <span class="mf">1e9</span> <span class="o">/</span> <span class="n">hz</span>
            <span class="n">new_nanos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">nanos_min</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">nanos_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_nanos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_nanos</span><span class="p">)</span>
    <span class="n">new_dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">track_df</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">):</span>
        <span class="n">track_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">track_new_nanos</span> <span class="o">=</span> <span class="n">new_nanos</span><span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                <span class="n">track_df</span><span class="p">[</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">new_nanos</span><span class="p">,</span>
                <span class="n">track_df</span><span class="p">[</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">new_nanos</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;x&quot;</span><span class="p">,</span>
            <span class="s2">&quot;y&quot;</span><span class="p">,</span>
            <span class="s2">&quot;z&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vel_x&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vel_y&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vel_z&quot;</span><span class="p">,</span>
            <span class="s2">&quot;acc_x&quot;</span><span class="p">,</span>
            <span class="s2">&quot;acc_y&quot;</span><span class="p">,</span>
            <span class="s2">&quot;acc_z&quot;</span><span class="p">,</span>
            <span class="s2">&quot;length&quot;</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">,</span>
            <span class="s2">&quot;height&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="n">track_data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">track_new_nanos</span><span class="p">,</span> <span class="n">track_df</span><span class="p">[</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">],</span> <span class="n">track_df</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;subtype&quot;</span><span class="p">,</span> <span class="s2">&quot;role&quot;</span><span class="p">]:</span>
            <span class="n">track_data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">nearest_interp</span><span class="p">(</span>
                <span class="n">track_new_nanos</span><span class="p">,</span>
                <span class="n">track_df</span><span class="p">[</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                <span class="n">track_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;roll&quot;</span><span class="p">,</span> <span class="s2">&quot;pitch&quot;</span><span class="p">,</span> <span class="s2">&quot;yaw&quot;</span><span class="p">]:</span>
            <span class="c1"># Unwrap angles to handle discontinuities, then interpolate, then wrap back to [-, ]</span>
            <span class="n">unwrapped_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">track_df</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
            <span class="n">interpolated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">track_new_nanos</span><span class="p">,</span> <span class="n">track_df</span><span class="p">[</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">],</span> <span class="n">unwrapped_angles</span><span class="p">)</span>
            <span class="n">track_data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">interpolated</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">new_track_df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">track_data</span><span class="p">)</span>
        <span class="n">new_track_df</span> <span class="o">=</span> <span class="n">new_track_df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;idx&quot;</span><span class="p">,</span>
                <span class="n">values</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">track_new_nanos</span><span class="p">)</span> <span class="o">*</span> <span class="n">idx</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">polars_schema</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">],</span>
            <span class="p">),</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">,</span>
                <span class="n">values</span><span class="o">=</span><span class="n">track_new_nanos</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">polars_schema</span><span class="p">[</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">],</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">new_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_track_df</span><span class="p">)</span>
    <span class="n">new_df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">new_dfs</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">new_df</span><span class="p">,</span> <span class="nb">map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span> <span class="n">host_vehicle_idx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host_vehicle_idx</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.recording.Recording.plot" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mvs_plt_type</span><span class="o">=</span><span class="s1">&#39;scatter&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Generate a static plot of the recording using Matplotlib. Plots the map (if available), moving objects, and traffic light states.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/recording.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mvs_plt_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;scatter&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
    <span class="s2">&quot;Generate a static plot of the recording using Matplotlib. Plots the map (if available), moving objects, and traffic light states.&quot;</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">plot_mvs</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">mvs_plt_type</span><span class="o">=</span><span class="n">mvs_plt_type</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">plot_tl</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_legend</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.recording.Recording.plot_altair" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_altair</span><span class="p">(</span><span class="n">start_frame</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end_frame</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">plot_map</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_map_polys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">metric_column</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_wedges</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Generate an interactive plot of the recording using Altair.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/recording.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_altair</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">start_frame</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">end_frame</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">plot_map</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">plot_map_polys</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">metric_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">plot_wedges</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">height</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">:</span>
    <span class="s2">&quot;Generate an interactive plot of the recording using Altair.&quot;</span>
    <span class="k">if</span> <span class="n">end_frame</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;frame&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">end_frame</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;frame&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">start_frame</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;frame&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">start_frame</span><span class="p">)</span>

    <span class="p">[</span><span class="n">frame_min</span><span class="p">],</span> <span class="p">[</span><span class="n">frame_max</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;frame&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">),</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;frame&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;max&quot;</span><span class="p">),</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">slider</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">binding_range</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="n">frame_min</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">frame_max</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;frame&quot;</span><span class="p">)</span>
    <span class="n">op_var</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="n">slider</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">concat_str</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">map_elements</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">betterosi</span><span class="o">.</span><span class="n">MovingObjectType</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">return_dtype</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">String</span><span class="p">),</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;subtype&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">map_elements</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">betterosi</span><span class="o">.</span><span class="n">MovingObjectVehicleClassificationType</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">return_dtype</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">String</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;length&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">buffer</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;xmin&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">buffer</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;xmax&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">buffer</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;ymin&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">buffer</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;ymax&quot;</span><span class="p">),</span>
    <span class="p">)</span><span class="o">.</span><span class="n">row</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">pov_df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;polygon&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">shapely</span><span class="o">.</span><span class="n">Polygon</span><span class="p">([[</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">],</span> <span class="p">[</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">],</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">],</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">]])]})</span>
    <span class="n">pov_df</span> <span class="o">=</span> <span class="n">pov_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">from_shapely</span><span class="p">(</span><span class="s2">&quot;polygon&quot;</span><span class="p">))</span>
    <span class="n">pov</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">({</span><span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="n">pov_df</span><span class="o">.</span><span class="n">st</span><span class="o">.</span><span class="n">to_dicts</span><span class="p">()})</span><span class="o">.</span><span class="n">mark_geoshape</span><span class="p">(</span><span class="n">fillOpacity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">filled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">plots</span> <span class="o">=</span> <span class="p">[</span><span class="n">pov</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">plot_map</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">plot_altair</span><span class="p">(</span><span class="n">recording</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_polys</span><span class="o">=</span><span class="n">plot_map_polys</span><span class="p">))</span>

    <span class="n">mv_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">,</span> <span class="s2">&quot;idx&quot;</span><span class="p">,</span> <span class="s2">&quot;frame&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">st</span><span class="o">.</span><span class="n">to_dicts</span><span class="p">()}</span>
    <span class="n">plots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">mv_dict</span><span class="p">)</span>
        <span class="o">.</span><span class="n">mark_geoshape</span><span class="p">()</span>
        <span class="o">.</span><span class="n">encode</span><span class="p">(</span>
            <span class="n">color</span><span class="o">=</span><span class="p">(</span>
                <span class="n">alt</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">alt</span><span class="o">.</span><span class="n">FieldEqualPredicate</span><span class="p">(</span><span class="n">equal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host_vehicle_idx</span> <span class="ow">or</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="s2">&quot;properties.idx&quot;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">alt</span><span class="o">.</span><span class="n">FieldEqualPredicate</span><span class="p">(</span><span class="n">equal</span><span class="o">=-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">idx</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="s2">&quot;properties.idx&quot;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="s2">&quot;blue&quot;</span><span class="p">))</span>
            <span class="p">),</span>
            <span class="n">tooltip</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;properties.idx:N&quot;</span><span class="p">,</span> <span class="s2">&quot;properties.frame:N&quot;</span><span class="p">,</span> <span class="s2">&quot;properties.type:O&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">transform_filter</span><span class="p">(</span><span class="n">alt</span><span class="o">.</span><span class="n">FieldEqualPredicate</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="s2">&quot;properties.frame&quot;</span><span class="p">,</span> <span class="n">equal</span><span class="o">=</span><span class="n">op_var</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">plot_wedges</span><span class="p">:</span>
        <span class="n">wedges_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">,</span> <span class="s2">&quot;frame&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;yaw&quot;</span><span class="p">,</span> <span class="s2">&quot;length&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;yaw&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">degrees</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;deg&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;length&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;size&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">plots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">wedges_df</span><span class="p">)</span>
            <span class="o">.</span><span class="n">mark_point</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="s2">&quot;wedge&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">strokeWidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="o">.</span><span class="n">encode</span><span class="p">(</span>
                <span class="n">alt</span><span class="o">.</span><span class="n">Longitude</span><span class="p">(</span><span class="s2">&quot;x:Q&quot;</span><span class="p">),</span>
                <span class="n">alt</span><span class="o">.</span><span class="n">Latitude</span><span class="p">(</span><span class="s2">&quot;y:Q&quot;</span><span class="p">),</span>
                <span class="n">alt</span><span class="o">.</span><span class="n">Angle</span><span class="p">(</span><span class="s2">&quot;deg&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="p">[</span><span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">180</span><span class="p">],</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">270</span><span class="p">]),</span>
                <span class="n">alt</span><span class="o">.</span><span class="n">Size</span><span class="p">(</span><span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
                <span class="n">tooltip</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;idx:N&quot;</span><span class="p">,</span> <span class="s2">&quot;frame:N&quot;</span><span class="p">,</span> <span class="s2">&quot;type:O&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">transform_filter</span><span class="p">(</span><span class="n">alt</span><span class="o">.</span><span class="n">FieldEqualPredicate</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="s2">&quot;frame&quot;</span><span class="p">,</span> <span class="n">equal</span><span class="o">=</span><span class="n">op_var</span><span class="p">))</span>
        <span class="p">)</span>

    <span class="n">view</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">alt</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="o">*</span><span class="n">plots</span><span class="p">)</span>
        <span class="o">.</span><span class="n">properties</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Map&quot;</span><span class="p">,</span>
            <span class="o">**</span><span class="p">({</span><span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">height</span><span class="p">}</span> <span class="k">if</span> <span class="n">height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}),</span>
            <span class="o">**</span><span class="p">({</span><span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">width</span><span class="p">}</span> <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}),</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="s2">&quot;identity&quot;</span><span class="p">,</span> <span class="n">reflectY</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">metric_column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">,</span> <span class="n">metric_column</span><span class="p">,</span> <span class="s2">&quot;frame&quot;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span>
            <span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;frame&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">metric_column</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">properties</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric_column</span><span class="si">}</span><span class="s2"> of object </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">vertline</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">()</span>
            <span class="o">.</span><span class="n">mark_rule</span><span class="p">()</span>
            <span class="o">.</span><span class="n">encode</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">datum</span><span class="p">(</span>
                    <span class="n">op_var</span><span class="p">,</span>
                    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;quantitative&quot;</span><span class="p">,</span>
                    <span class="n">scale</span><span class="o">=</span><span class="n">alt</span><span class="o">.</span><span class="n">Scale</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="p">[</span><span class="n">frame_min</span><span class="p">,</span> <span class="n">frame_max</span><span class="p">]),</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">view</span> <span class="o">=</span> <span class="n">view</span> <span class="o">|</span> <span class="p">(</span><span class="n">metric</span> <span class="o">+</span> <span class="n">vertline</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">view</span><span class="o">.</span><span class="n">add_params</span><span class="p">(</span><span class="n">op_var</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.recording.Recording.plot_frame" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Generate a static plot of a specific frame in the recording using Matplotlib.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/recording.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="s2">&quot;Generate a static plot of a specific frame in the recording using Matplotlib.&quot;</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">plot_mv_frame</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">frame</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.recording.Recording.plot_mvs" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_mvs</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mvs_plt_type</span><span class="o">=</span><span class="s1">&#39;scatter&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Generate a static plot of the moving objects in the recording using Matplotlib.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/recording.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_mvs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mvs_plt_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;scatter&quot;</span><span class="p">):</span>
    <span class="s2">&quot;Generate a static plot of the moving objects in the recording using Matplotlib.&quot;</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plot_fn</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;scatter&quot;</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">,</span> <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mvs_plt_type</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plot_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`mvs_plt_type` must be one of: &#39;scatter&#39;, &#39;plot&#39;.&quot;</span><span class="p">)</span>

    <span class="n">plot_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]</span>
    <span class="n">base_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}</span>
    <span class="k">for</span> <span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">mv</span> <span class="ow">in</span> <span class="n">plot_df</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">host_vehicle_idx</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">mv</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> - HV&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">plot_fn</span><span class="p">(</span><span class="o">*</span><span class="n">mv</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span> <span class="o">**</span><span class="n">base_kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_legend</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.recording.Recording.plot_tl" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_tl</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Generate a static plot of the traffic lights in the recording using Matplotlib.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/recording.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_tl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="s2">&quot;Generate a static plot of the traffic lights in the recording using Matplotlib.&quot;</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">tl_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">tl_states</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">traffic_light_states</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">tl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">traffic_light_states</span><span class="p">[</span><span class="n">tl_states</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">tl</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tl_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">tl_dict</span><span class="p">[</span><span class="n">tl</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">tl</span>

    <span class="k">for</span> <span class="n">tl</span> <span class="ow">in</span> <span class="n">tl_dict</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">tl_dict</span><span class="p">[</span><span class="n">tl</span><span class="p">]</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">tl_dict</span><span class="p">[</span><span class="n">tl</span><span class="p">]</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">x</span><span class="p">,</span>
                <span class="n">y</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Traffic Light </span><span class="si">{</span><span class="n">tl_dict</span><span class="p">[</span><span class="n">tl</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">c</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Skipping traffic light </span><span class="si">{</span><span class="n">tl</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> due to missing position data: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
    <span class="k">return</span> <span class="n">ax</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.recording.Recording.to_file" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Store Recording to a file based on its suffix (<code>.parquet</code>, <code>.mcap</code>).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/recording.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
    <span class="s2">&quot;Store Recording to a file based on its suffix (`.parquet`, `.mcap`).&quot;</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.parquet&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.mcap&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">to_mcap</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported file suffix `</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">`. Expected one of: `.parquet`, `.mcap`.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.recording.Recording.to_mcap" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_mcap</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Store Recording as an MCAP file.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/recording.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_mcap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
    <span class="s2">&quot;Store Recording as an MCAP file.&quot;</span>
    <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s2">&quot;.mcap&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">betterosi</span><span class="o">.</span><span class="n">Writer</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">w</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">gt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_osi_gts</span><span class="p">():</span>
            <span class="n">w</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gt</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span> <span class="n">MapOdr</span><span class="p">):</span>
            <span class="n">w</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">to_osi</span><span class="p">(),</span> <span class="n">topic</span><span class="o">=</span><span class="s2">&quot;ground_truth_map&quot;</span><span class="p">,</span> <span class="n">log_time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span> <span class="n">MapOsi</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span> <span class="n">MapOsiCenterline</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The map </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="si">}</span><span class="s2"> could not be saved to `mcap`&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.recording.Recording.to_parquet" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_parquet</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Store Recording as a Parquet file.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/recording.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_parquet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="s2">&quot;Store Recording as a Parquet file.&quot;</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">host_vehicle_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">metadata</span><span class="p">[</span><span class="sa">b</span><span class="s2">&quot;host_vehicle_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host_vehicle_idx</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
    <span class="n">proj_meta</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">encoded_projections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode_projections</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projections</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">encoded_projections</span><span class="p">:</span>
        <span class="n">proj_meta</span><span class="p">[</span><span class="sa">b</span><span class="s2">&quot;projections_json&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">encoded_projections</span>
    <span class="n">df_export</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df_with_original_pose_for_export</span><span class="p">()</span>
    <span class="n">to_drop</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;frame&quot;</span><span class="p">]</span>
    <span class="n">optional_cols</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;polygon&quot;</span><span class="p">,</span>
        <span class="s2">&quot;global_lat&quot;</span><span class="p">,</span>
        <span class="s2">&quot;global_lon&quot;</span><span class="p">,</span>
        <span class="s2">&quot;global_alt&quot;</span><span class="p">,</span>
        <span class="s2">&quot;global_yaw&quot;</span><span class="p">,</span>
        <span class="s2">&quot;proj_string&quot;</span><span class="p">,</span>
        <span class="s2">&quot;x_original&quot;</span><span class="p">,</span>
        <span class="s2">&quot;y_original&quot;</span><span class="p">,</span>
        <span class="s2">&quot;z_original&quot;</span><span class="p">,</span>
        <span class="s2">&quot;yaw_original&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">to_drop</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">optional_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df_export</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">pyarrow</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">df_export</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="o">*</span><span class="n">to_drop</span><span class="p">))</span>
    <span class="n">map_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">_to_binary_json</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">with_metadata</span><span class="p">(</span><span class="n">metadata</span> <span class="o">|</span> <span class="n">proj_meta</span> <span class="o">|</span> <span class="n">map_meta</span><span class="p">))</span>
    <span class="n">pq</span><span class="o">.</span><span class="n">write_table</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="omega_prime.map"></a>
    <div class="doc doc-contents first">










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="omega_prime.map.Map" class="doc doc-heading">
            <code>Map</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">



        <p>Base class for Map representations</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>omega_prime/map.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Map</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for Map representations&quot;&quot;&quot;</span>

    <span class="n">lane_boundaries</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">LaneBoundary</span><span class="p">]</span>
    <span class="n">lanes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Any</span><span class="p">:</span><span class="n">Lane</span><span class="p">]</span>

    <span class="n">_supported_file_suffixes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.osi&quot;</span><span class="p">,</span> <span class="s2">&quot;.mcap&quot;</span><span class="p">]</span>
    <span class="n">_binary_json_identifier</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;osi&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">l</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_boundaries</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">b</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">parse_map</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="s2">&quot;Create a Map instance from a file.&quot;</span>
        <span class="n">first_gt</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">betterosi</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">return_ground_truth</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mcap_return_betterosi</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">first_gt</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_altair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recording</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_polys</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">arbitrary_lane</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="n">plot_polys</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arbitrary_lane</span><span class="p">,</span> <span class="s2">&quot;polygon&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">arbitrary_lane</span><span class="o">.</span><span class="n">polygon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">plot_polys</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_plot_dict&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">plot_polys</span><span class="p">:</span>
                <span class="n">shapely_series</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;shapely&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">shapely_series</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;shapely&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">centerline</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
                <span class="p">)</span>

            <span class="n">map_df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">shapely_series</span><span class="p">,</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;idx&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">keys</span><span class="p">())]),</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;subtype&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">subtype</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;on_intersection&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">on_intersection</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">map_df</span> <span class="o">=</span> <span class="n">map_df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">from_shapely</span><span class="p">(</span><span class="s2">&quot;shapely&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;shapely&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">recording</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">buffer</span> <span class="o">=</span> <span class="mi">5</span>
                <span class="p">[</span><span class="n">xmin</span><span class="p">],</span> <span class="p">[</span><span class="n">xmax</span><span class="p">],</span> <span class="p">[</span><span class="n">ymin</span><span class="p">],</span> <span class="p">[</span><span class="n">ymax</span><span class="p">]</span> <span class="o">=</span> <span class="n">recording</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">buffer</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;xmin&quot;</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">buffer</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;xmax&quot;</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">buffer</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;ymin&quot;</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">buffer</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;ymax&quot;</span><span class="p">),</span>
                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">pov_df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;polygon&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">shapely</span><span class="o">.</span><span class="n">Polygon</span><span class="p">([[</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">],</span> <span class="p">[</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">],</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">],</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">]])]}</span>
                <span class="p">)</span>
                <span class="n">pov_df</span> <span class="o">=</span> <span class="n">pov_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">from_shapely</span><span class="p">(</span><span class="s2">&quot;polygon&quot;</span><span class="p">))</span>
                <span class="n">map_df</span> <span class="o">=</span> <span class="n">map_df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;geometry&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">st</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">pov_df</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">])),</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="n">map_df</span><span class="o">.</span><span class="n">st</span><span class="o">.</span><span class="n">to_dicts</span><span class="p">()}</span>

        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_plot_dict</span><span class="p">)</span>
            <span class="o">.</span><span class="n">mark_geoshape</span><span class="p">(</span><span class="n">fillOpacity</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">filled</span><span class="o">=</span><span class="kc">True</span> <span class="k">if</span> <span class="n">plot_polys</span> <span class="k">else</span> <span class="kc">False</span><span class="p">)</span>
            <span class="o">.</span><span class="n">encode</span><span class="p">(</span>
                <span class="n">tooltip</span><span class="o">=</span><span class="p">[</span>
                    <span class="s2">&quot;properties.idx:N&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;properties.type:O&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;properties.subtype:O&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;properties.on_intersection:O&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">color</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">alt</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">alt</span><span class="o">.</span><span class="n">FieldEqualPredicate</span><span class="p">(</span><span class="n">equal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="s2">&quot;properties.on_intersection&quot;</span><span class="p">))</span>
                    <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="s2">&quot;black&quot;</span><span class="p">))</span>
                    <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="s2">&quot;green&quot;</span><span class="p">))</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">recording</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Map&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="s2">&quot;identity&quot;</span><span class="p">,</span> <span class="n">reflectY</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">c</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">map_to_centerline_mcap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_mcap_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">betterosi</span><span class="o">.</span><span class="n">GroundTruth</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert an Map to a MapOsiCenterline and save it as an MCAP file if the output path is provided.</span>
<span class="sd">        It returns the generated GroundTruth object from the generated MapOsiCenterline.</span>

<span class="sd">        Args:</span>
<span class="sd">            output_mcap_path: Path where the MCAP file will be saved</span>
<span class="sd">        Returns:</span>
<span class="sd">            betterosi.GroundTruth: The generated GroundTruth object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Create a mapping from XodrLaneId to a simple integer ID</span>
        <span class="n">lane_id_mapping</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">lane_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">lane_id_mapping</span><span class="p">[</span><span class="n">lane_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>

        <span class="c1"># Create betterosi.Lane objects for each lane</span>
        <span class="n">osi_lanes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="o">.</span><span class="n">is_valid</span> <span class="ow">or</span> <span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Skipping invalid lane </span><span class="si">{</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Check for NaN/inf coordinates</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Lane </span><span class="si">{</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="si">}</span><span class="s2"> has non-finite coordinates, skipping&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Lane </span><span class="si">{</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="si">}</span><span class="s2"> has insufficient points, skipping&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c1"># Get centerline coordinates</span>
            <span class="n">centerline_coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">shapely</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">centerline_coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">centerline_coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">centerline_coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># skip lanes with insufficient centerline points</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Skipping lane </span><span class="si">{</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="si">}</span><span class="s2"> due to insufficient centerline points&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

            <span class="n">centerline</span> <span class="o">=</span> <span class="p">[</span><span class="n">betterosi</span><span class="o">.</span><span class="n">Vector3D</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">y</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">z</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">centerline_coords</span><span class="p">]</span>

            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">centerline_coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
            <span class="c1"># Create lane pairing for successor/predecessor relationships</span>
            <span class="n">lane_pairings</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Get all unique combinations of predecessors and successors</span>
            <span class="n">predecessors</span> <span class="o">=</span> <span class="p">[</span><span class="n">pred_id</span> <span class="k">for</span> <span class="n">pred_id</span> <span class="ow">in</span> <span class="n">lane</span><span class="o">.</span><span class="n">predecessor_ids</span> <span class="k">if</span> <span class="n">pred_id</span> <span class="ow">in</span> <span class="n">lane_id_mapping</span><span class="p">]</span>
            <span class="n">successors</span> <span class="o">=</span> <span class="p">[</span><span class="n">succ_id</span> <span class="k">for</span> <span class="n">succ_id</span> <span class="ow">in</span> <span class="n">lane</span><span class="o">.</span><span class="n">successor_ids</span> <span class="k">if</span> <span class="n">succ_id</span> <span class="ow">in</span> <span class="n">lane_id_mapping</span><span class="p">]</span>

            <span class="c1"># If there are no predecessors or successors, create a single pairing with None values</span>
            <span class="k">if</span> <span class="n">predecessors</span> <span class="ow">or</span> <span class="n">successors</span><span class="p">:</span>
                <span class="c1"># Create pairings for all combinations</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">predecessors</span><span class="p">:</span>
                    <span class="n">predecessors</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">successors</span><span class="p">:</span>
                    <span class="n">successors</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">pred_id</span> <span class="ow">in</span> <span class="n">predecessors</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">succ_id</span> <span class="ow">in</span> <span class="n">successors</span><span class="p">:</span>
                        <span class="n">lane_pairings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">betterosi</span><span class="o">.</span><span class="n">LaneClassificationLanePairing</span><span class="p">(</span>
                                <span class="n">antecessor_lane_id</span><span class="o">=</span><span class="n">betterosi</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">lane_id_mapping</span><span class="p">[</span><span class="n">pred_id</span><span class="p">])</span>
                                <span class="k">if</span> <span class="n">pred_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                                <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="n">successor_lane_id</span><span class="o">=</span><span class="n">betterosi</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">lane_id_mapping</span><span class="p">[</span><span class="n">succ_id</span><span class="p">])</span>
                                <span class="k">if</span> <span class="n">succ_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                                <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>

            <span class="c1"># Create the OSI lane</span>
            <span class="n">osi_lane</span> <span class="o">=</span> <span class="n">betterosi</span><span class="o">.</span><span class="n">Lane</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">betterosi</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">lane_id_mapping</span><span class="p">[</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="p">]),</span>
                <span class="n">classification</span><span class="o">=</span><span class="n">betterosi</span><span class="o">.</span><span class="n">LaneClassification</span><span class="p">(</span>
                    <span class="n">centerline</span><span class="o">=</span><span class="n">centerline</span><span class="p">,</span>
                    <span class="n">centerline_is_driving_direction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="nb">type</span><span class="o">=</span><span class="n">lane</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                    <span class="n">subtype</span><span class="o">=</span><span class="n">lane</span><span class="o">.</span><span class="n">subtype</span><span class="p">,</span>
                    <span class="n">lane_pairing</span><span class="o">=</span><span class="n">lane_pairings</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">osi_lanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">osi_lane</span><span class="p">)</span>

        <span class="c1"># Create a GroundTruth with only the lanes (no moving objects, no lane boundaries)</span>
        <span class="n">ground_truth</span> <span class="o">=</span> <span class="n">betterosi</span><span class="o">.</span><span class="n">GroundTruth</span><span class="p">(</span>
            <span class="n">version</span><span class="o">=</span><span class="n">betterosi</span><span class="o">.</span><span class="n">InterfaceVersion</span><span class="p">(</span>
                <span class="n">version_major</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                <span class="n">version_minor</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
                <span class="n">version_patch</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">betterosi</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span>
                <span class="n">seconds</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">nanos</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">lane</span><span class="o">=</span><span class="n">osi_lanes</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Save to MCAP file if output path is provided</span>
        <span class="k">if</span> <span class="n">output_mcap_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No output path provided for MCAP file&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Convert string to Path if needed</span>
            <span class="n">output_mcap_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_mcap_path</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">output_mcap_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="n">output_mcap_path</span> <span class="o">=</span> <span class="n">output_mcap_path</span> <span class="o">/</span> <span class="s2">&quot;map_to_centerline.mcap&quot;</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">output_mcap_path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.mcap&quot;</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output path must be a directory or .mcap file: </span><span class="si">{</span><span class="n">output_mcap_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ground_truth</span>

            <span class="k">with</span> <span class="n">betterosi</span><span class="o">.</span><span class="n">Writer</span><span class="p">(</span><span class="n">output_mcap_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">topic</span><span class="o">=</span><span class="s2">&quot;ground_truth_map&quot;</span><span class="p">,</span> <span class="n">log_time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully saved map with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">osi_lanes</span><span class="p">)</span><span class="si">}</span><span class="s2"> lanes to </span><span class="si">{</span><span class="n">output_mcap_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ground_truth</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">align_predecessor_and_successor_relations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensure that predecessor and successor relationships between lanes are consistent.</span>
<span class="sd">        If lane A lists lane B as a successor, then lane B should list lane A as a predecessor, and vice versa.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">succ_id</span> <span class="ow">in</span> <span class="n">lane</span><span class="o">.</span><span class="n">successor_ids</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">succ_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="p">:</span>
                    <span class="n">succ_lane</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="p">[</span><span class="n">succ_id</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">lane</span><span class="o">.</span><span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">succ_lane</span><span class="o">.</span><span class="n">predecessor_ids</span><span class="p">:</span>
                        <span class="n">succ_lane</span><span class="o">.</span><span class="n">predecessor_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pred_id</span> <span class="ow">in</span> <span class="n">lane</span><span class="o">.</span><span class="n">predecessor_ids</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pred_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="p">:</span>
                    <span class="n">pred_lane</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="p">[</span><span class="n">pred_id</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">lane</span><span class="o">.</span><span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pred_lane</span><span class="o">.</span><span class="n">successor_ids</span><span class="p">:</span>
                        <span class="n">pred_lane</span><span class="o">.</span><span class="n">successor_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_lanes_and_boundaries</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">setup_lanes_and_boundaries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_to_binary_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_from_binary_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="omega_prime.map.Map.align_predecessor_and_successor_relations" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">align_predecessor_and_successor_relations</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Ensure that predecessor and successor relationships between lanes are consistent.
If lane A lists lane B as a successor, then lane B should list lane A as a predecessor, and vice versa.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/map.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">align_predecessor_and_successor_relations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ensure that predecessor and successor relationships between lanes are consistent.</span>
<span class="sd">    If lane A lists lane B as a successor, then lane B should list lane A as a predecessor, and vice versa.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">succ_id</span> <span class="ow">in</span> <span class="n">lane</span><span class="o">.</span><span class="n">successor_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">succ_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="p">:</span>
                <span class="n">succ_lane</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="p">[</span><span class="n">succ_id</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">lane</span><span class="o">.</span><span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">succ_lane</span><span class="o">.</span><span class="n">predecessor_ids</span><span class="p">:</span>
                    <span class="n">succ_lane</span><span class="o">.</span><span class="n">predecessor_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pred_id</span> <span class="ow">in</span> <span class="n">lane</span><span class="o">.</span><span class="n">predecessor_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pred_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="p">:</span>
                <span class="n">pred_lane</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="p">[</span><span class="n">pred_id</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">lane</span><span class="o">.</span><span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pred_lane</span><span class="o">.</span><span class="n">successor_ids</span><span class="p">:</span>
                    <span class="n">pred_lane</span><span class="o">.</span><span class="n">successor_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.map.Map.from_file" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">parse_map</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Create a Map instance from a file.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/map.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">parse_map</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="s2">&quot;Create a Map instance from a file.&quot;</span>
    <span class="n">first_gt</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">betterosi</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">return_ground_truth</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mcap_return_betterosi</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">first_gt</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.map.Map.map_to_centerline_mcap" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">map_to_centerline_mcap</span><span class="p">(</span><span class="n">output_mcap_path</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Convert an Map to a MapOsiCenterline and save it as an MCAP file if the output path is provided.
It returns the generated GroundTruth object from the generated MapOsiCenterline.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>output_mcap_path</code>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path where the MCAP file will be saved</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:
    betterosi.GroundTruth: The generated GroundTruth object</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/map.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">map_to_centerline_mcap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_mcap_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">betterosi</span><span class="o">.</span><span class="n">GroundTruth</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert an Map to a MapOsiCenterline and save it as an MCAP file if the output path is provided.</span>
<span class="sd">    It returns the generated GroundTruth object from the generated MapOsiCenterline.</span>

<span class="sd">    Args:</span>
<span class="sd">        output_mcap_path: Path where the MCAP file will be saved</span>
<span class="sd">    Returns:</span>
<span class="sd">        betterosi.GroundTruth: The generated GroundTruth object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Create a mapping from XodrLaneId to a simple integer ID</span>
    <span class="n">lane_id_mapping</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">lane_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">lane_id_mapping</span><span class="p">[</span><span class="n">lane_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>

    <span class="c1"># Create betterosi.Lane objects for each lane</span>
    <span class="n">osi_lanes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="o">.</span><span class="n">is_valid</span> <span class="ow">or</span> <span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Skipping invalid lane </span><span class="si">{</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Check for NaN/inf coordinates</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Lane </span><span class="si">{</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="si">}</span><span class="s2"> has non-finite coordinates, skipping&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Lane </span><span class="si">{</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="si">}</span><span class="s2"> has insufficient points, skipping&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="c1"># Get centerline coordinates</span>
        <span class="n">centerline_coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">shapely</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">centerline_coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">centerline_coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">centerline_coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># skip lanes with insufficient centerline points</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Skipping lane </span><span class="si">{</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="si">}</span><span class="s2"> due to insufficient centerline points&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="n">centerline</span> <span class="o">=</span> <span class="p">[</span><span class="n">betterosi</span><span class="o">.</span><span class="n">Vector3D</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">y</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">z</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">centerline_coords</span><span class="p">]</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">centerline_coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="c1"># Create lane pairing for successor/predecessor relationships</span>
        <span class="n">lane_pairings</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Get all unique combinations of predecessors and successors</span>
        <span class="n">predecessors</span> <span class="o">=</span> <span class="p">[</span><span class="n">pred_id</span> <span class="k">for</span> <span class="n">pred_id</span> <span class="ow">in</span> <span class="n">lane</span><span class="o">.</span><span class="n">predecessor_ids</span> <span class="k">if</span> <span class="n">pred_id</span> <span class="ow">in</span> <span class="n">lane_id_mapping</span><span class="p">]</span>
        <span class="n">successors</span> <span class="o">=</span> <span class="p">[</span><span class="n">succ_id</span> <span class="k">for</span> <span class="n">succ_id</span> <span class="ow">in</span> <span class="n">lane</span><span class="o">.</span><span class="n">successor_ids</span> <span class="k">if</span> <span class="n">succ_id</span> <span class="ow">in</span> <span class="n">lane_id_mapping</span><span class="p">]</span>

        <span class="c1"># If there are no predecessors or successors, create a single pairing with None values</span>
        <span class="k">if</span> <span class="n">predecessors</span> <span class="ow">or</span> <span class="n">successors</span><span class="p">:</span>
            <span class="c1"># Create pairings for all combinations</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">predecessors</span><span class="p">:</span>
                <span class="n">predecessors</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">successors</span><span class="p">:</span>
                <span class="n">successors</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">pred_id</span> <span class="ow">in</span> <span class="n">predecessors</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">succ_id</span> <span class="ow">in</span> <span class="n">successors</span><span class="p">:</span>
                    <span class="n">lane_pairings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">betterosi</span><span class="o">.</span><span class="n">LaneClassificationLanePairing</span><span class="p">(</span>
                            <span class="n">antecessor_lane_id</span><span class="o">=</span><span class="n">betterosi</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">lane_id_mapping</span><span class="p">[</span><span class="n">pred_id</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">pred_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                            <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">successor_lane_id</span><span class="o">=</span><span class="n">betterosi</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">lane_id_mapping</span><span class="p">[</span><span class="n">succ_id</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">succ_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                            <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

        <span class="c1"># Create the OSI lane</span>
        <span class="n">osi_lane</span> <span class="o">=</span> <span class="n">betterosi</span><span class="o">.</span><span class="n">Lane</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">betterosi</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">lane_id_mapping</span><span class="p">[</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="p">]),</span>
            <span class="n">classification</span><span class="o">=</span><span class="n">betterosi</span><span class="o">.</span><span class="n">LaneClassification</span><span class="p">(</span>
                <span class="n">centerline</span><span class="o">=</span><span class="n">centerline</span><span class="p">,</span>
                <span class="n">centerline_is_driving_direction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">lane</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                <span class="n">subtype</span><span class="o">=</span><span class="n">lane</span><span class="o">.</span><span class="n">subtype</span><span class="p">,</span>
                <span class="n">lane_pairing</span><span class="o">=</span><span class="n">lane_pairings</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">osi_lanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">osi_lane</span><span class="p">)</span>

    <span class="c1"># Create a GroundTruth with only the lanes (no moving objects, no lane boundaries)</span>
    <span class="n">ground_truth</span> <span class="o">=</span> <span class="n">betterosi</span><span class="o">.</span><span class="n">GroundTruth</span><span class="p">(</span>
        <span class="n">version</span><span class="o">=</span><span class="n">betterosi</span><span class="o">.</span><span class="n">InterfaceVersion</span><span class="p">(</span>
            <span class="n">version_major</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">version_minor</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
            <span class="n">version_patch</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">timestamp</span><span class="o">=</span><span class="n">betterosi</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span>
            <span class="n">seconds</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">nanos</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">lane</span><span class="o">=</span><span class="n">osi_lanes</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Save to MCAP file if output path is provided</span>
    <span class="k">if</span> <span class="n">output_mcap_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No output path provided for MCAP file&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Convert string to Path if needed</span>
        <span class="n">output_mcap_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_mcap_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">output_mcap_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="n">output_mcap_path</span> <span class="o">=</span> <span class="n">output_mcap_path</span> <span class="o">/</span> <span class="s2">&quot;map_to_centerline.mcap&quot;</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">output_mcap_path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.mcap&quot;</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output path must be a directory or .mcap file: </span><span class="si">{</span><span class="n">output_mcap_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ground_truth</span>

        <span class="k">with</span> <span class="n">betterosi</span><span class="o">.</span><span class="n">Writer</span><span class="p">(</span><span class="n">output_mcap_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">topic</span><span class="o">=</span><span class="s2">&quot;ground_truth_map&quot;</span><span class="p">,</span> <span class="n">log_time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully saved map with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">osi_lanes</span><span class="p">)</span><span class="si">}</span><span class="s2"> lanes to </span><span class="si">{</span><span class="n">output_mcap_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ground_truth</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="omega_prime.map.MapOsi" class="doc doc-heading">
            <code>MapOsi</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" href="#omega_prime.map.Map">Map</a></code></p>



        <p>Map representation based on ASAM OSI GroundTruth</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>omega_prime/map.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MapOsi</span><span class="p">(</span><span class="n">Map</span><span class="p">):</span>
    <span class="s2">&quot;Map representation based on ASAM OSI GroundTruth&quot;</span>

    <span class="n">_osi</span><span class="p">:</span> <span class="n">betterosi</span><span class="o">.</span><span class="n">GroundTruth</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">gt</span><span class="p">:</span> <span class="n">betterosi</span><span class="o">.</span><span class="n">GroundTruth</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gt</span><span class="o">.</span><span class="n">lane_boundary</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Empty Map&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">_osi</span><span class="o">=</span><span class="n">gt</span><span class="p">,</span>
            <span class="n">lane_boundaries</span><span class="o">=</span><span class="p">{</span><span class="n">b</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">value</span><span class="p">:</span> <span class="n">LaneBoundaryOsi</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">gt</span><span class="o">.</span><span class="n">lane_boundary</span><span class="p">},</span>
            <span class="n">lanes</span><span class="o">=</span><span class="p">{</span>
                <span class="n">l</span><span class="o">.</span><span class="n">idx</span><span class="p">:</span> <span class="n">l</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="p">[</span><span class="n">LaneOsi</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">gt</span><span class="o">.</span><span class="n">lane</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">classification</span><span class="o">.</span><span class="n">right_lane_boundary_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="p">},</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_lanes_and_boundaries</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">setup_lanes_and_boundaries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_boundaries</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">b</span><span class="o">.</span><span class="n">_map</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">map_osi_id2idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">l</span><span class="o">.</span><span class="n">_osi</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">value</span><span class="p">:</span> <span class="n">l</span><span class="o">.</span><span class="n">idx</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">()}</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">l</span><span class="o">.</span><span class="n">successor_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">map_osi_id2idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">successor_ids</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">map_osi_id2idx</span><span class="p">]</span>
            <span class="n">l</span><span class="o">.</span><span class="n">predecessor_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">map_osi_id2idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">predecessor_ids</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">map_osi_id2idx</span><span class="p">]</span>
            <span class="n">l</span><span class="o">.</span><span class="n">_map</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="n">l</span><span class="o">.</span><span class="n">set_boundaries</span><span class="p">()</span>
            <span class="n">l</span><span class="o">.</span><span class="n">set_polygon</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_to_binary_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_osi</span><span class="o">.</span><span class="n">to_json</span><span class="p">())</span>
        <span class="k">if</span> <span class="s2">&quot;movingObject&quot;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;movingObject&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span><span class="sa">b</span><span class="s2">&quot;osi&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_from_binary_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">gt</span> <span class="o">=</span> <span class="n">betterosi</span><span class="o">.</span><span class="n">GroundTruth</span><span class="p">()</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="sa">b</span><span class="s2">&quot;osi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gt</span><span class="o">.</span><span class="n">lane_boundary</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">gt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="omega_prime.map.MapOsiCenterline" class="doc doc-heading">
            <code>MapOsiCenterline</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" href="#omega_prime.map.Map">Map</a></code></p>



        <p>Map representation based on ASAM OSI GroundTruth defining only the centerlines of lanes and nothing else. Does not conform to the omega-prime specification for Map.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>omega_prime/map.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MapOsiCenterline</span><span class="p">(</span><span class="n">Map</span><span class="p">):</span>
    <span class="s2">&quot;Map representation based on ASAM OSI GroundTruth defining only the centerlines of lanes and nothing else. Does not conform to the omega-prime specification for Map.&quot;</span>

    <span class="n">_osi</span><span class="p">:</span> <span class="n">betterosi</span><span class="o">.</span><span class="n">GroundTruth</span>
    <span class="n">lanes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">LaneOsiCenterline</span><span class="p">]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">gt</span><span class="p">:</span> <span class="n">betterosi</span><span class="o">.</span><span class="n">GroundTruth</span><span class="p">,</span> <span class="n">split_lanes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">split_lanes_length</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gt</span><span class="o">.</span><span class="n">lane</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No Map&quot;</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">_osi</span><span class="o">=</span><span class="n">gt</span><span class="p">,</span>
            <span class="n">lanes</span><span class="o">=</span><span class="p">{</span><span class="n">l</span><span class="o">.</span><span class="n">idx</span><span class="p">:</span> <span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="p">[</span><span class="n">LaneOsiCenterline</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">gt</span><span class="o">.</span><span class="n">lane</span><span class="p">]},</span>
            <span class="n">lane_boundaries</span><span class="o">=</span><span class="p">{},</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">split_lanes</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">_split</span><span class="p">(</span><span class="n">split_lanes_length</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">setup_lanes_and_boundaries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">map_osi_id2idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">l</span><span class="o">.</span><span class="n">_osi</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">value</span><span class="p">:</span> <span class="n">l</span><span class="o">.</span><span class="n">idx</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">()}</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">l</span><span class="o">.</span><span class="n">successor_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">map_osi_id2idx</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">successor_ids</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="ow">in</span> <span class="n">map_osi_id2idx</span><span class="p">]</span>
            <span class="n">l</span><span class="o">.</span><span class="n">predecessor_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">map_osi_id2idx</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">predecessor_ids</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="ow">in</span> <span class="n">map_osi_id2idx</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">l</span><span class="o">.</span><span class="n">_map</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c1"># Sometimes a presuccessor lane is not set as a successor lane in the other lane, therefore we need to check where this is the case and add it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">align_predecessor_and_successor_relations</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_len</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Split lanes into segments of maximum length.</span>

<span class="sd">        This method post-processes the map by splitting lane centerlines that exceed</span>
<span class="sd">        the specified maximum length into smaller segments. It updates lane connections</span>
<span class="sd">        accordingly and removes connections between segments that are too far apart.</span>

<span class="sd">        Args:</span>
<span class="sd">            max_len (float): Maximum length allowed for each lane segment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The Postprocessing is ACTIVE! The lanes will be split into segments!!!&quot;</span><span class="p">)</span>
        <span class="n">lanes_or</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span>
        <span class="n">lanes_new</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">idx_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">lanes_or</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">max_len</span><span class="p">:</span>
                <span class="c1"># Split the lane&#39;s centerline into segments of maximum length</span>
                <span class="n">segments</span> <span class="o">=</span> <span class="n">split_linestring</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="p">,</span> <span class="n">max_len</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">segments</span> <span class="o">=</span> <span class="p">[</span><span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="p">]</span>

            <span class="c1"># Create new lane objects for each segment</span>
            <span class="n">segment_lanes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">segment</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">segments</span><span class="p">):</span>
                <span class="c1"># Create a copy of the lane with modified centerline</span>
                <span class="c1"># new_lane = copy.deepcopy(lane)</span>

                <span class="n">new_lane</span> <span class="o">=</span> <span class="n">LaneOsiCenterline</span><span class="p">(</span>
                    <span class="n">_osi</span><span class="o">=</span><span class="n">lane</span><span class="o">.</span><span class="n">_osi</span><span class="p">,</span>
                    <span class="n">idx</span><span class="o">=</span><span class="n">OsiLaneId</span><span class="p">(</span><span class="n">road_id</span><span class="o">=</span><span class="n">idx_count</span><span class="p">,</span> <span class="n">lane_id</span><span class="o">=</span><span class="n">idx_count</span><span class="p">),</span>
                    <span class="n">centerline</span><span class="o">=</span><span class="n">segment</span><span class="p">,</span>
                    <span class="nb">type</span><span class="o">=</span><span class="n">lane</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                    <span class="n">subtype</span><span class="o">=</span><span class="n">lane</span><span class="o">.</span><span class="n">subtype</span><span class="p">,</span>
                    <span class="n">successor_ids</span><span class="o">=</span><span class="p">[],</span>
                    <span class="n">predecessor_ids</span><span class="o">=</span><span class="p">[],</span>
                <span class="p">)</span>

                <span class="n">segment_lanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_lane</span><span class="p">)</span>
                <span class="n">lanes_new</span><span class="p">[</span><span class="n">new_lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">lane_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_lane</span>
                <span class="n">idx_count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">new_lane</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">segment_lanes</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">segments</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># If only one segment, keep original predecessors and successors</span>
                    <span class="n">new_lane</span><span class="o">.</span><span class="n">predecessor_ids</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">predecessor_ids</span>
                    <span class="n">new_lane</span><span class="o">.</span><span class="n">successor_ids</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">successor_ids</span>
                <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># First segment: keep original predecessors, connect to next segment</span>
                    <span class="n">new_lane</span><span class="o">.</span><span class="n">predecessor_ids</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">predecessor_ids</span>
                    <span class="n">new_lane</span><span class="o">.</span><span class="n">successor_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">segment_lanes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">segments</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Last segment: connect to previous segment, keep original successors</span>
                    <span class="n">new_lane</span><span class="o">.</span><span class="n">predecessor_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">segment_lanes</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">new_lane</span><span class="o">.</span><span class="n">successor_ids</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">successor_ids</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Middle segments: connect to both neighbors</span>
                    <span class="n">new_lane</span><span class="o">.</span><span class="n">predecessor_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">segment_lanes</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">new_lane</span><span class="o">.</span><span class="n">successor_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">segment_lanes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span>

            <span class="c1"># Update references in other lanes&#39; predecessors/successors</span>
            <span class="k">for</span> <span class="n">other_lane</span> <span class="ow">in</span> <span class="n">lanes_or</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">lane</span><span class="o">.</span><span class="n">idx</span> <span class="ow">in</span> <span class="n">other_lane</span><span class="o">.</span><span class="n">successor_ids</span><span class="p">:</span>
                    <span class="c1"># Replace reference to original lane with first segment</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">other_lane</span><span class="o">.</span><span class="n">successor_ids</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="p">)</span>
                    <span class="n">other_lane</span><span class="o">.</span><span class="n">successor_ids</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">segment_lanes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">idx</span>
                <span class="k">if</span> <span class="n">lane</span><span class="o">.</span><span class="n">idx</span> <span class="ow">in</span> <span class="n">other_lane</span><span class="o">.</span><span class="n">predecessor_ids</span><span class="p">:</span>
                    <span class="c1"># Replace reference to original lane with last segment</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">other_lane</span><span class="o">.</span><span class="n">predecessor_ids</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="p">)</span>
                    <span class="n">other_lane</span><span class="o">.</span><span class="n">predecessor_ids</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">segment_lanes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">idx</span>

        <span class="c1"># Replace original lanes with segmented lanes</span>

        <span class="c1"># Do a check for the predecessor and successor: Check if the distance between the centerlines is greater than the max_len --&gt; if yes, then remove the connection</span>
        <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="n">lanes_new</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">lane</span><span class="o">.</span><span class="n">predecessor_ids</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pre</span> <span class="ow">in</span> <span class="n">lane</span><span class="o">.</span><span class="n">predecessor_ids</span><span class="p">:</span>
                    <span class="n">pre_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">lanes_new</span><span class="p">[</span><span class="n">pre</span><span class="o">.</span><span class="n">lane_id</span><span class="p">]</span><span class="o">.</span><span class="n">centerline</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_len</span><span class="p">:</span>
                        <span class="n">pre_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pre</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">lanes_new</span><span class="p">[</span><span class="n">pre</span><span class="o">.</span><span class="n">lane_id</span><span class="p">]</span><span class="o">.</span><span class="n">successor_ids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="k">pass</span>  <span class="c1"># If the successor is not in the list, ignore</span>

                    <span class="k">for</span> <span class="n">pre</span> <span class="ow">in</span> <span class="n">pre_to_remove</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">lanes_new</span><span class="p">[</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">lane_id</span><span class="p">]</span><span class="o">.</span><span class="n">predecessor_ids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pre</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="k">pass</span>  <span class="c1"># If the predecessor is not in the list, ignore</span>
            <span class="k">if</span> <span class="n">lane</span><span class="o">.</span><span class="n">successor_ids</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">suc</span> <span class="ow">in</span> <span class="n">lane</span><span class="o">.</span><span class="n">successor_ids</span><span class="p">:</span>
                    <span class="n">suc_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">lanes_new</span><span class="p">[</span><span class="n">suc</span><span class="o">.</span><span class="n">lane_id</span><span class="p">]</span><span class="o">.</span><span class="n">centerline</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_len</span><span class="p">:</span>
                        <span class="n">suc_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">suc</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">lanes_new</span><span class="p">[</span><span class="n">suc</span><span class="o">.</span><span class="n">lane_id</span><span class="p">]</span><span class="o">.</span><span class="n">predecessor_ids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="k">pass</span>  <span class="c1"># If the predecessor is not in the list, ignore</span>

                    <span class="k">for</span> <span class="n">suc</span> <span class="ow">in</span> <span class="n">suc_to_remove</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">lanes_new</span><span class="p">[</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">lane_id</span><span class="p">]</span><span class="o">.</span><span class="n">successor_ids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">suc</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span> <span class="o">=</span> <span class="p">{</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="p">:</span> <span class="n">lane</span> <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="n">lanes_new</span><span class="o">.</span><span class="n">values</span><span class="p">()}</span>
        <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">lane</span><span class="o">.</span><span class="n">_map</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_to_binary_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_osi</span><span class="o">.</span><span class="n">to_json</span><span class="p">())</span>
        <span class="k">if</span> <span class="s2">&quot;movingObject&quot;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;movingObject&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span><span class="sa">b</span><span class="s2">&quot;osi&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_from_binary_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">gt</span> <span class="o">=</span> <span class="n">betterosi</span><span class="o">.</span><span class="n">GroundTruth</span><span class="p">()</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="sa">b</span><span class="s2">&quot;osi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">gt</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="omega_prime.map.split_linestring" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">split_linestring</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">max_length</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Split a LineString into segments of maximum length.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>line</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>shapely LineString to split</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_length</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum length of each segment</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of LineString segments</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/map.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">split_linestring</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">max_length</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split a LineString into segments of maximum length.</span>

<span class="sd">    Args:</span>
<span class="sd">        line: shapely LineString to split</span>
<span class="sd">        max_length: Maximum length of each segment</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of LineString segments</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">segments</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># If line is already short enough, return it as is</span>
    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">length</span> <span class="o">&lt;=</span> <span class="n">max_length</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">line</span><span class="p">]</span>

    <span class="c1"># Number of segments needed</span>
    <span class="n">n_segments</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="n">max_length</span><span class="p">))</span>

    <span class="c1"># Get evenly spaced points along the line</span>
    <span class="n">points</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="n">n_segments</span><span class="p">,</span> <span class="n">normalized</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_segments</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>

    <span class="c1"># Create line segments</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_segments</span><span class="p">):</span>
        <span class="n">segment_coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shapely</span><span class="o">.</span><span class="n">LineString</span><span class="p">(</span><span class="n">segment_coords</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">segments</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="omega_prime.map_odr"></a>
    <div class="doc doc-contents first">










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="omega_prime.map_odr.MapOdr" class="doc doc-heading">
            <code>MapOdr</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" href="#omega_prime.map.Map">Map</a></code></p>










              <details class="mkdocstrings-source">
                <summary>Source code in <code>omega_prime/map_odr.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MapOdr</span><span class="p">(</span><span class="n">Map</span><span class="p">):</span>
    <span class="n">odr_xml</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">step_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">_xodr_map</span><span class="p">:</span> <span class="n">PyxodrRoadNetwork</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">proj_string</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">proj_offset</span><span class="p">:</span> <span class="n">ProjectionOffset</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">projection</span><span class="p">:</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">CRS</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_supported_file_suffixes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.xodr&quot;</span><span class="p">,</span> <span class="s2">&quot;.mcap&quot;</span><span class="p">,</span> <span class="s2">&quot;.odr&quot;</span><span class="p">]</span>
    <span class="n">_binary_json_identifier</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;xodr&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">xodr_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xodr_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xodr_map</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_file</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">filename</span><span class="p">,</span>
        <span class="n">topics</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;/ground_truth_map&quot;</span><span class="p">,</span> <span class="s2">&quot;ground_truth_map&quot;</span><span class="p">],</span>
        <span class="n">parse_map</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">is_odr_xml</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">is_mcap</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">step_size</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
        <span class="n">ignored_lane_types</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([]),</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.xodr&quot;</span><span class="p">,</span> <span class="s2">&quot;.odr&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">is_odr_xml</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">odr_xml</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">odr_xml</span><span class="o">=</span><span class="n">odr_xml</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span><span class="p">,</span>
                <span class="n">step_size</span><span class="o">=</span><span class="n">step_size</span><span class="p">,</span>
                <span class="n">parse_map</span><span class="o">=</span><span class="n">parse_map</span><span class="p">,</span>
                <span class="n">ignored_lane_types</span><span class="o">=</span><span class="n">ignored_lane_types</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.mcap&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">is_mcap</span><span class="p">:</span>
            <span class="nb">map</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">betterosi</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mcap_topics</span><span class="o">=</span><span class="n">topics</span><span class="p">,</span> <span class="n">mcap_return_betterosi</span><span class="o">=</span><span class="kc">False</span><span class="p">)))</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">odr_xml</span><span class="o">=</span><span class="nb">map</span><span class="o">.</span><span class="n">open_drive_xml_content</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="nb">map</span><span class="o">.</span><span class="n">map_reference</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="n">step_size</span><span class="p">,</span> <span class="n">parse_map</span><span class="o">=</span><span class="n">parse_map</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">lanes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lanes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lanes</span>

    <span class="nd">@lanes</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">lanes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lanes</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">lane_boundaries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lane_boundaries</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lane_boundaries</span>

    <span class="nd">@lane_boundaries</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">lane_boundaries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lane_boundaries</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">odr_xml</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">parse_map</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">ignored_lane_types</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])):</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">odr_xml</span><span class="o">=</span><span class="n">odr_xml</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="n">step_size</span><span class="p">,</span> <span class="n">lanes</span><span class="o">=</span><span class="p">{},</span> <span class="n">lane_boundaries</span><span class="o">=</span><span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lane_boundaries</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lanes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignored_lane_types</span> <span class="o">=</span> <span class="n">ignored_lane_types</span>
        <span class="k">if</span> <span class="n">parse_map</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rn</span> <span class="o">=</span> <span class="n">RoadNetwork</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">odr_xml</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">step_size</span><span class="p">,</span> <span class="n">ignored_lane_types</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ignored_lane_types</span><span class="p">)</span>

        <span class="n">lane_boundaries</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">lanes</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Extract projection information from XML tree</span>
        <span class="n">proj_string</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">proj_offset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">projection</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Get the header element from XML</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">rn</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;header&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Get geoReference if it exists</span>
            <span class="n">geo_ref</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;geoReference&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">geo_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">geo_ref</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                <span class="n">proj_string</span> <span class="o">=</span> <span class="n">geo_ref</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">projection</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">CRS</span><span class="o">.</span><span class="n">from_proj4</span><span class="p">(</span><span class="n">proj_string</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">CRSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to parse projection string: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Get offset if it exists</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;offset&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">proj_offset</span> <span class="o">=</span> <span class="n">ProjectionOffset</span><span class="p">(</span>
                        <span class="n">x</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">offset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)),</span>
                        <span class="n">y</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">offset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)),</span>
                        <span class="n">z</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">offset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)),</span>
                        <span class="n">yaw</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">offset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hdg&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)),</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to parse offset: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">road</span> <span class="ow">in</span> <span class="n">rn</span><span class="o">.</span><span class="n">get_roads</span><span class="p">():</span>
            <span class="n">lane_idx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">lane_section_id</span><span class="p">,</span> <span class="n">lane_section</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">road</span><span class="o">.</span><span class="n">lane_sections</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="n">lane_section</span><span class="o">.</span><span class="n">lanes</span><span class="p">:</span>
                    <span class="n">boundary_line</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="s2">&quot;boundary_line&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">boundary_line</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">boundary_line</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Skipping road </span><span class="si">{</span><span class="n">road</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> / lane_section </span><span class="si">{</span><span class="n">lane_section_id</span><span class="si">}</span><span class="s2"> / lane </span><span class="si">{</span><span class="n">lane</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">: missing boundary_line&quot;</span>
                        <span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">left_boundary</span> <span class="o">=</span> <span class="n">LaneBoundaryXodr</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                            <span class="n">lane</span><span class="p">,</span> <span class="n">road</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">lane</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">lane_section_id</span><span class="p">,</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">lane_idx</span><span class="o">=</span><span class="n">lane_idx</span>
                        <span class="p">)</span>
                        <span class="n">right_boundary</span> <span class="o">=</span> <span class="n">LaneBoundaryXodr</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                            <span class="n">lane</span><span class="p">,</span> <span class="n">road</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">lane</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">lane_section_id</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">lane_idx</span><span class="o">=</span><span class="n">lane_idx</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Failed to create boundaries for road </span><span class="si">{</span><span class="n">road</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> / lane_section </span><span class="si">{</span><span class="n">lane_section_id</span><span class="si">}</span><span class="s2"> / lane </span><span class="si">{</span><span class="n">lane</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="n">lane_boundaries</span><span class="p">[</span><span class="n">left_boundary</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">left_boundary</span>
                    <span class="n">lane_boundaries</span><span class="p">[</span><span class="n">right_boundary</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">right_boundary</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">lane_obj</span> <span class="o">=</span> <span class="n">LaneXodr</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">road</span><span class="p">,</span> <span class="n">lane_section_id</span><span class="p">,</span> <span class="n">lane_idx</span><span class="p">)</span>
                        <span class="n">lanes</span><span class="p">[</span><span class="n">lane_obj</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">lane_obj</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Failed to create lane object for road </span><span class="si">{</span><span class="n">road</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> / lane_section </span><span class="si">{</span><span class="n">lane_section_id</span><span class="si">}</span><span class="s2"> / lane </span><span class="si">{</span><span class="n">lane</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>

                    <span class="n">lane_idx</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_xodr_map</span> <span class="o">=</span> <span class="n">rn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lane_boundaries</span> <span class="o">=</span> <span class="n">lane_boundaries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span> <span class="o">=</span> <span class="n">lanes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proj_string</span> <span class="o">=</span> <span class="n">proj_string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proj_offset</span> <span class="o">=</span> <span class="n">proj_offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projection</span> <span class="o">=</span> <span class="n">projection</span>
        <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">lane</span><span class="o">.</span><span class="n">_map</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="n">lane</span><span class="o">.</span><span class="n">_set_boundaries</span><span class="p">()</span>
            <span class="n">lane</span><span class="o">.</span><span class="n">_set_polygon</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lane_boundaries</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">b</span><span class="o">.</span><span class="n">_map</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">setup_lanes_and_boundaries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Export the current MapOdr to a .xodr file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.xodr&quot;</span>

        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.xodr&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">odr_xml</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_osi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">MapAsamOpenDrive</span><span class="p">(</span><span class="n">map_reference</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">open_drive_xml_content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">odr_xml</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_to_binary_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="sa">b</span><span class="s2">&quot;xodr&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">odr_xml</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="sa">b</span><span class="s2">&quot;xodr_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">encode</span><span class="p">()}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_from_binary_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">parse_map</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">step_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">odr_xml</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="sa">b</span><span class="s2">&quot;xodr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span>
            <span class="n">name</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="sa">b</span><span class="s2">&quot;xodr_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span>
            <span class="n">parse_map</span><span class="o">=</span><span class="n">parse_map</span><span class="p">,</span>
            <span class="n">step_size</span><span class="o">=</span><span class="n">step_size</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="omega_prime.map_odr.MapOdr.to_file" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Export the current MapOdr to a .xodr file.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/map_odr.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Export the current MapOdr to a .xodr file.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.xodr&quot;</span>

    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.xodr&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">odr_xml</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="omega_prime.locator"></a>
    <div class="doc doc-contents first">










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="omega_prime.locator.Locator" class="doc doc-heading">
            <code>Locator</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">










              <details class="mkdocstrings-source">
                <summary>Source code in <code>omega_prime/locator.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Locator</span><span class="p">:</span>
    <span class="n">all_lanes</span><span class="p">:</span> <span class="n">Any</span>  <span class="c1"># array of all lanes</span>
    <span class="n">external2internal_laneid</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">internal2external_laneid</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">lane_point_distances</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">str_tree</span><span class="p">:</span> <span class="n">shapely</span><span class="o">.</span><span class="n">STRtree</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">extended_centerlines</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">shapely</span><span class="o">.</span><span class="n">LineString</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">g</span><span class="p">:</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Lane Relation Graph</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_map</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="nb">map</span><span class="p">):</span>
        <span class="n">all_lanes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">all_lanes</span><span class="o">=</span><span class="n">all_lanes</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Create mapping with lane_id as key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external2internal_laneid</span> <span class="o">=</span> <span class="p">{</span><span class="n">l</span><span class="o">.</span><span class="n">idx</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_lanes</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">internal2external_laneid</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">idx</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_lanes</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">extended_centerlines</span> <span class="o">=</span> <span class="p">[</span><span class="n">ShapelyTrajectoryTools</span><span class="o">.</span><span class="n">extend_linestring</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">centerline</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_lanes</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_lanes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;polygon&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_lanes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">polygon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">str_tree</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">STRtree</span><span class="p">([</span><span class="n">l</span><span class="o">.</span><span class="n">polygon</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_lanes</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">str_tree</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">STRtree</span><span class="p">([</span><span class="n">l</span><span class="o">.</span><span class="n">centerline</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_lanes</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lane_point_distances</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">shapely</span><span class="o">.</span><span class="n">line_locate_point</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">shapely</span><span class="o">.</span><span class="n">points</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="n">coords</span><span class="p">)))</span> <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extended_centerlines</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_routing_graph</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_route</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_id</span><span class="p">,</span> <span class="n">end_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">nx</span><span class="o">.</span><span class="n">shortest_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">,</span> <span class="n">start_id</span><span class="p">,</span> <span class="n">end_id</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sts2xys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sts</span><span class="p">):</span>
        <span class="n">xys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">sts</span><span class="o">.</span><span class="n">s</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">l_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">external2internal_laneid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sts</span><span class="o">.</span><span class="n">roadlane_id</span><span class="o">.</span><span class="n">values</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">l_id</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">l_ids</span><span class="p">):</span>
            <span class="n">point_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">l_ids</span> <span class="o">==</span> <span class="n">l_id</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">rel_sts</span> <span class="o">=</span> <span class="n">sts</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">point_idxs</span><span class="p">))</span>
            <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extended_centerlines</span><span class="p">[</span><span class="n">l_id</span><span class="p">]</span>
            <span class="n">xys</span><span class="p">[</span><span class="n">point_idxs</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">xys</span><span class="p">[</span><span class="n">point_idxs</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ShapelyTrajectoryTools</span><span class="o">.</span><span class="n">st2xy</span><span class="p">(</span>
                <span class="n">l</span><span class="p">,</span> <span class="n">rel_sts</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">values</span> <span class="o">+</span> <span class="n">ShapelyTrajectoryTools</span><span class="o">.</span><span class="n">l_append</span><span class="p">,</span> <span class="n">rel_sts</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">values</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">xys</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">xys2sts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xys</span><span class="p">,</span> <span class="n">polygons</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xys</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">xys</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">xys</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="n">xys</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">points</span><span class="p">(</span><span class="n">xys</span><span class="p">)</span>
        <span class="n">lat_distances</span><span class="p">,</span> <span class="n">lon_distances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xys2sts</span><span class="p">(</span><span class="n">xys</span><span class="p">,</span> <span class="n">polygons</span><span class="p">)</span>
        <span class="n">single_lane_association</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_single_lane_association</span><span class="p">(</span><span class="n">lat_distances</span><span class="p">)</span>
        <span class="n">sla</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">single_lane_association</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">tuple</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">single_lane_association</span><span class="p">):</span>
            <span class="n">sla</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">sts</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">lon_distances</span><span class="p">[</span><span class="n">lidx</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lidx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">single_lane_association</span><span class="p">)]),</span>
                <span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">lat_distances</span><span class="p">[</span><span class="n">lidx</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lidx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">single_lane_association</span><span class="p">)]),</span>
                <span class="s2">&quot;roadlane_id&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">sla</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">sts</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">xys2lane_sts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane_id</span><span class="p">,</span> <span class="n">xys</span><span class="p">,</span> <span class="n">internal_id</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># xys should be an array of shapely objects or an array of points with dim (n_points, 2)</span>
        <span class="c1"># return (n_points, 2) where ret[:,0] is s and ret[:,1] is t</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xys</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">xys</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">xys</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="n">xys</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">points</span><span class="p">(</span><span class="n">xys</span><span class="p">)</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">external2internal_laneid</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">internal_id</span> <span class="k">else</span> <span class="n">lane_id</span>
        <span class="n">lane_point_distances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_point_distances</span><span class="p">[</span><span class="n">lid</span><span class="p">]</span>
        <span class="n">sts</span> <span class="o">=</span> <span class="n">ShapelyTrajectoryTools</span><span class="o">.</span><span class="n">xy2st</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extended_centerlines</span><span class="p">[</span><span class="n">lid</span><span class="p">],</span> <span class="n">x_or_xy</span><span class="o">=</span><span class="n">xys</span><span class="p">,</span> <span class="n">line_point_distances</span><span class="o">=</span><span class="n">lane_point_distances</span>
        <span class="p">)</span>
        <span class="n">sts</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">ShapelyTrajectoryTools</span><span class="o">.</span><span class="n">l_append</span>
        <span class="k">return</span> <span class="n">sts</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_xys2sts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xys</span><span class="p">,</span> <span class="n">polygons</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># xys should be an array of shapely objects or an array of points with dim (n_points, 2)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xys</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">xys</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">xys</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="n">xys</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">points</span><span class="p">(</span><span class="n">xys</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xys</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">polygons</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">polygons</span> <span class="o">=</span> <span class="n">xys</span>
        <span class="n">lon_distances</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">xys</span><span class="p">),)))</span>
        <span class="n">lat_distances</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">xys</span><span class="p">),)))</span>
        <span class="n">point_idxs</span><span class="p">,</span> <span class="n">intersection_lane_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">polygons</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;intersects&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">l_id</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">intersection_lane_ids</span><span class="p">):</span>
            <span class="n">lps</span> <span class="o">=</span> <span class="n">point_idxs</span><span class="p">[</span><span class="n">intersection_lane_ids</span> <span class="o">==</span> <span class="n">l_id</span><span class="p">]</span>
            <span class="p">(</span>
                <span class="n">lon_distances</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">internal2external_laneid</span><span class="p">[</span><span class="n">l_id</span><span class="p">]][</span><span class="n">lps</span><span class="p">],</span>
                <span class="n">lat_distances</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">internal2external_laneid</span><span class="p">[</span><span class="n">l_id</span><span class="p">]][</span><span class="n">lps</span><span class="p">],</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xys2lane_sts</span><span class="p">(</span><span class="n">l_id</span><span class="p">,</span> <span class="n">xys</span><span class="p">[</span><span class="n">lps</span><span class="p">],</span> <span class="n">internal_id</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">no_associations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">lon_distances</span><span class="o">.</span><span class="n">values</span><span class="p">()))),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># no arrays to stack</span>
            <span class="n">no_associations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xys</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_lanes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;polygon&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_lanes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">polygon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">no_asscociation_idxs</span><span class="p">,</span> <span class="n">intersection_lane_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_tree</span><span class="o">.</span><span class="n">query_nearest</span><span class="p">(</span><span class="n">polygons</span><span class="p">[</span><span class="n">no_associations</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Create an empty numpy array for no_asscociation_idxs</span>
            <span class="n">no_asscociation_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="n">intersection_lane_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">no_associations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">poly</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">polygons</span><span class="p">[</span><span class="n">no_associations</span><span class="p">]):</span>
                    <span class="c1"># Returns the indxes of all centerlines that are in range</span>
                    <span class="n">nearby_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_centerlines</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">range_percentage</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
                    <span class="c1"># Connect the no_assosciation_idxs with the intersection_lane_ids</span>
                    <span class="n">no_asscociation_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">no_asscociation_idxs</span><span class="p">,</span> <span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">nearby_idx</span><span class="p">))</span>
                    <span class="n">intersection_lane_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intersection_lane_ids</span><span class="p">,</span> <span class="n">nearby_idx</span><span class="p">)</span>

        <span class="c1"># Need a convertion from float values to int values. This is because the shapely STRtree query_nearest returns float values</span>
        <span class="n">no_asscociation_idxs</span> <span class="o">=</span> <span class="n">no_asscociation_idxs</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">intersection_lane_ids</span> <span class="o">=</span> <span class="n">intersection_lane_ids</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">l_id</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">intersection_lane_ids</span><span class="p">):</span>
            <span class="n">lps</span> <span class="o">=</span> <span class="n">no_associations</span><span class="p">[</span><span class="n">no_asscociation_idxs</span><span class="p">[</span><span class="n">intersection_lane_ids</span> <span class="o">==</span> <span class="n">l_id</span><span class="p">]]</span>
            <span class="p">(</span>
                <span class="n">lon_distances</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">internal2external_laneid</span><span class="p">[</span><span class="n">l_id</span><span class="p">]][</span><span class="n">lps</span><span class="p">],</span>
                <span class="n">lat_distances</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">internal2external_laneid</span><span class="p">[</span><span class="n">l_id</span><span class="p">]][</span><span class="n">lps</span><span class="p">],</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xys2lane_sts</span><span class="p">(</span><span class="n">l_id</span><span class="p">,</span> <span class="n">xys</span><span class="p">[</span><span class="n">lps</span><span class="p">],</span> <span class="n">internal_id</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="n">no_asscociation_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">lon_distances</span><span class="o">.</span><span class="n">values</span><span class="p">()))),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">no_asscociation_new</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">lat_distances</span><span class="p">,</span> <span class="n">lon_distances</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">locate_mv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mv</span><span class="p">,</span> <span class="n">use_polygon</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">mv</span><span class="o">.</span><span class="n">polygon</span>
        <span class="n">moving</span> <span class="o">=</span> <span class="n">mv</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">any_horizontal</span><span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;is_moving&quot;</span><span class="p">))[</span>
            <span class="s2">&quot;total_nanos&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;polygon&quot;</span>
        <span class="p">]</span>
        <span class="n">xrd</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xys2sts</span><span class="p">(</span><span class="n">moving</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">polygons</span><span class="o">=</span><span class="n">moving</span><span class="p">[</span><span class="s2">&quot;polygon&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">use_polygon</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
            <span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">moving</span><span class="p">[</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()})</span>
            <span class="o">.</span><span class="n">set_coords</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">moving</span><span class="o">.</span><span class="n">height</span> <span class="o">&lt;</span> <span class="n">mv</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">height</span><span class="p">:</span>
            <span class="n">xrd</span> <span class="o">=</span> <span class="n">xrd</span><span class="o">.</span><span class="n">sel</span><span class="p">({</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">mv</span><span class="o">.</span><span class="n">_df</span><span class="p">[</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()},</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;ffill&quot;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">xrd</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mv</span><span class="o">.</span><span class="n">_df</span><span class="p">[</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">xrd</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">query_centerlines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">range_percentage</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query the nearest centerline and all centerlines within a range percentage.</span>

<span class="sd">        :param point: A shapely Point object representing the query location.</span>
<span class="sd">        :param range_percentage: The range as a percentage of the total length of the nearest centerline. Default is 0.1 (10%).</span>
<span class="sd">        :return: A NDArray with all the Lane Idx in the Range.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Query the nearest centerline</span>
        <span class="n">nearest_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_tree</span><span class="o">.</span><span class="n">query_nearest</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
        <span class="n">nearest_centerline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extended_centerlines</span><span class="p">[</span><span class="n">nearest_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="c1"># Calculate the range based on the nearest centerline&#39;s length</span>
        <span class="n">range_distance</span> <span class="o">=</span> <span class="n">nearest_centerline</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">point</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">range_percentage</span><span class="p">)</span>

        <span class="c1"># Create a buffer around the point</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">range_distance</span><span class="p">)</span>

        <span class="c1"># Query all centerlines within the buffer</span>
        <span class="n">nearby_idxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;intersects&quot;</span><span class="p">)</span>

        <span class="c1"># If there was no intersection, return the nearest centerline</span>
        <span class="k">if</span> <span class="n">nearby_idxs</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">nearest_idx</span>

        <span class="k">return</span> <span class="n">nearby_idxs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_routing_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_lanes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_lanes</span>
        <span class="n">str_tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_tree</span>
        <span class="n">external2internal_laneid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">external2internal_laneid</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">lid</span><span class="p">,</span> <span class="n">lane</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_lanes</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">lane</span><span class="o">=</span><span class="n">lane</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">external_pid</span> <span class="ow">in</span> <span class="n">lane</span><span class="o">.</span><span class="n">predecessor_ids</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">external2internal_laneid</span><span class="p">[</span><span class="n">external_pid</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">LaneRelation</span><span class="o">.</span><span class="n">predecessor</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">for</span> <span class="n">external_sid</span> <span class="ow">in</span> <span class="n">lane</span><span class="o">.</span><span class="n">successor_ids</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">external2internal_laneid</span><span class="p">[</span><span class="n">external_sid</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">LaneRelation</span><span class="o">.</span><span class="n">successor</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">if</span> <span class="n">lane</span><span class="o">.</span><span class="n">right_boundary</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">lane</span><span class="o">.</span><span class="n">left_boundary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">right_neigbours</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">str_tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">right_boundary</span><span class="o">.</span><span class="n">polyline</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;covered_by&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="n">lid</span>
            <span class="p">]</span>
            <span class="n">left_neigbours</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">str_tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">left_boundary</span><span class="o">.</span><span class="n">polyline</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;covered_by&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="n">lid</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">rn</span> <span class="ow">in</span> <span class="n">right_neigbours</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">rn</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">LaneRelation</span><span class="o">.</span><span class="n">neighbour_right</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">left_neigbours</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">LaneRelation</span><span class="o">.</span><span class="n">neighbour_left</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">g</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_single_lane_association</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">traveler_lane_intersections</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">overlaps</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        filter traveling path of traveler, so that traveler is not assigned to lanes that are only reachable through a merging or crossing relation</span>
<span class="sd">        return format: road, lane</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>

        <span class="n">g</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">external_lid</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">traveler_lane_intersections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">timeidx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">v</span><span class="p">))[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">nodes</span><span class="p">[</span><span class="n">timeidx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">external2internal_laneid</span><span class="p">[</span><span class="n">external_lid</span><span class="p">])</span>
        <span class="n">nodes_per_time</span> <span class="o">=</span> <span class="p">[</span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">))]</span>
        <span class="n">g</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">g</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nodes_per_time</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">nodes_of_time</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nodes_per_time</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes_of_time</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">next_n</span> <span class="ow">in</span> <span class="n">nodes_per_time</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">add_node</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="n">pos</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">add_node</span><span class="p">((</span><span class="n">next_n</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">pos</span><span class="o">=</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">next_n</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">next_n</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">overlaps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">weight</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">weight</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">overlaps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">internal2external_laneid</span><span class="p">[</span><span class="n">n</span><span class="p">]][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="n">LaneRelation</span><span class="o">.</span><span class="n">neighbour_left</span> <span class="ow">in</span> <span class="n">o</span> <span class="ow">or</span> <span class="n">LaneRelation</span><span class="o">.</span><span class="n">neighbour_right</span> <span class="ow">in</span> <span class="n">o</span>
                                <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">get_edge_data</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">next_n</span><span class="p">)[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
                                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">get_edge_data</span><span class="p">(</span><span class="n">next_n</span><span class="p">,</span> <span class="n">n</span><span class="p">)[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
                            <span class="p">]</span>
                        <span class="p">):</span>
                            <span class="n">weight</span> <span class="o">=</span> <span class="mi">2</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">get_edge_data</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">next_n</span><span class="p">)[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span>
                            <span class="n">LaneRelation</span><span class="o">.</span><span class="n">predecessor</span><span class="p">,</span>
                            <span class="n">LaneRelation</span><span class="o">.</span><span class="n">successor</span><span class="p">,</span>
                        <span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">get_edge_data</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">next_n</span><span class="p">)[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span>
                            <span class="n">LaneRelation</span><span class="o">.</span><span class="n">predecessor</span><span class="p">,</span>
                            <span class="n">LaneRelation</span><span class="o">.</span><span class="n">successor</span><span class="p">,</span>
                        <span class="p">]:</span>
                            <span class="n">weight</span> <span class="o">=</span> <span class="mi">2</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">weight</span> <span class="o">=</span> <span class="mi">3</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">weight</span> <span class="o">=</span> <span class="mi">4</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="p">(</span><span class="n">next_n</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes_per_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes_per_time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes_per_time</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">shortest_path</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;weight&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">fixed_traveler_path</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">internal2external_laneid</span><span class="p">[</span><span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">sp</span><span class="p">]</span>

        <span class="n">overlaps</span> <span class="o">=</span> <span class="p">[</span><span class="n">traveler_lane_intersections</span><span class="p">[</span><span class="n">lid</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fixed_traveler_path</span><span class="p">)]</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">overlaps</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">fixed_traveler_path</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Locator(</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_lanes</span><span class="p">)</span><span class="si">}</span><span class="s2"> lanes)&lt;</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_lane_ids_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external2internal_laneid</span> <span class="o">=</span> <span class="p">{</span><span class="n">l</span><span class="o">.</span><span class="n">idx</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_lanes</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">internal2external_laneid</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">idx</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_lanes</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="omega_prime.locator.Locator.get_single_lane_association" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_single_lane_association</span><span class="p">(</span><span class="n">traveler_lane_intersections</span><span class="p">,</span> <span class="n">overlaps</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>filter traveling path of traveler, so that traveler is not assigned to lanes that are only reachable through a merging or crossing relation
return format: road, lane</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/locator.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_single_lane_association</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">traveler_lane_intersections</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">overlaps</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    filter traveling path of traveler, so that traveler is not assigned to lanes that are only reachable through a merging or crossing relation</span>
<span class="sd">    return format: road, lane</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>

    <span class="n">g</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">external_lid</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">traveler_lane_intersections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">timeidx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">v</span><span class="p">))[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">nodes</span><span class="p">[</span><span class="n">timeidx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">external2internal_laneid</span><span class="p">[</span><span class="n">external_lid</span><span class="p">])</span>
    <span class="n">nodes_per_time</span> <span class="o">=</span> <span class="p">[</span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">))]</span>
    <span class="n">g</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">g</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nodes_per_time</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">nodes_of_time</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nodes_per_time</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes_of_time</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">next_n</span> <span class="ow">in</span> <span class="n">nodes_per_time</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">add_node</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="n">pos</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
                <span class="n">g</span><span class="o">.</span><span class="n">add_node</span><span class="p">((</span><span class="n">next_n</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">pos</span><span class="o">=</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">next_n</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">next_n</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">overlaps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">weight</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">weight</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">overlaps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">internal2external_laneid</span><span class="p">[</span><span class="n">n</span><span class="p">]][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">LaneRelation</span><span class="o">.</span><span class="n">neighbour_left</span> <span class="ow">in</span> <span class="n">o</span> <span class="ow">or</span> <span class="n">LaneRelation</span><span class="o">.</span><span class="n">neighbour_right</span> <span class="ow">in</span> <span class="n">o</span>
                            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">get_edge_data</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">next_n</span><span class="p">)[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">get_edge_data</span><span class="p">(</span><span class="n">next_n</span><span class="p">,</span> <span class="n">n</span><span class="p">)[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
                        <span class="p">]</span>
                    <span class="p">):</span>
                        <span class="n">weight</span> <span class="o">=</span> <span class="mi">2</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">get_edge_data</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">next_n</span><span class="p">)[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span>
                        <span class="n">LaneRelation</span><span class="o">.</span><span class="n">predecessor</span><span class="p">,</span>
                        <span class="n">LaneRelation</span><span class="o">.</span><span class="n">successor</span><span class="p">,</span>
                    <span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">get_edge_data</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">next_n</span><span class="p">)[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span>
                        <span class="n">LaneRelation</span><span class="o">.</span><span class="n">predecessor</span><span class="p">,</span>
                        <span class="n">LaneRelation</span><span class="o">.</span><span class="n">successor</span><span class="p">,</span>
                    <span class="p">]:</span>
                        <span class="n">weight</span> <span class="o">=</span> <span class="mi">2</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">weight</span> <span class="o">=</span> <span class="mi">3</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">weight</span> <span class="o">=</span> <span class="mi">4</span>
                <span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="p">(</span><span class="n">next_n</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes_per_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes_per_time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes_per_time</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sp</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">shortest_path</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;weight&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">fixed_traveler_path</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">internal2external_laneid</span><span class="p">[</span><span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">sp</span><span class="p">]</span>

    <span class="n">overlaps</span> <span class="o">=</span> <span class="p">[</span><span class="n">traveler_lane_intersections</span><span class="p">[</span><span class="n">lid</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fixed_traveler_path</span><span class="p">)]</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">overlaps</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">fixed_traveler_path</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.locator.Locator.query_centerlines" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">query_centerlines</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">range_percentage</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Query the nearest centerline and all centerlines within a range percentage.</p>
<p>:param point: A shapely Point object representing the query location.
:param range_percentage: The range as a percentage of the total length of the nearest centerline. Default is 0.1 (10%).
:return: A NDArray with all the Lane Idx in the Range.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/locator.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">query_centerlines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">range_percentage</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Query the nearest centerline and all centerlines within a range percentage.</span>

<span class="sd">    :param point: A shapely Point object representing the query location.</span>
<span class="sd">    :param range_percentage: The range as a percentage of the total length of the nearest centerline. Default is 0.1 (10%).</span>
<span class="sd">    :return: A NDArray with all the Lane Idx in the Range.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Query the nearest centerline</span>
    <span class="n">nearest_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_tree</span><span class="o">.</span><span class="n">query_nearest</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
    <span class="n">nearest_centerline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extended_centerlines</span><span class="p">[</span><span class="n">nearest_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="c1"># Calculate the range based on the nearest centerline&#39;s length</span>
    <span class="n">range_distance</span> <span class="o">=</span> <span class="n">nearest_centerline</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">point</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">range_percentage</span><span class="p">)</span>

    <span class="c1"># Create a buffer around the point</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">range_distance</span><span class="p">)</span>

    <span class="c1"># Query all centerlines within the buffer</span>
    <span class="n">nearby_idxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;intersects&quot;</span><span class="p">)</span>

    <span class="c1"># If there was no intersection, return the nearest centerline</span>
    <span class="k">if</span> <span class="n">nearby_idxs</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">nearest_idx</span>

    <span class="k">return</span> <span class="n">nearby_idxs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="omega_prime.locator.get_lane_centerline" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_lane_centerline</span><span class="p">(</span><span class="n">right_border</span><span class="p">,</span> <span class="n">left_border</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>middle line between (interpolated) boundaries, oriented in direction of lane</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/locator.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_lane_centerline</span><span class="p">(</span><span class="n">right_border</span><span class="p">:</span> <span class="n">shapely</span><span class="o">.</span><span class="n">LineString</span><span class="p">,</span> <span class="n">left_border</span><span class="p">:</span> <span class="n">shapely</span><span class="o">.</span><span class="n">LineString</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">shapely</span><span class="o">.</span><span class="n">LineString</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;middle line between (interpolated) boundaries, oriented in direction of lane&quot;&quot;&quot;</span>
    <span class="n">ses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">shapely</span><span class="o">.</span><span class="n">line_locate_point</span><span class="p">(</span><span class="n">left_border</span><span class="p">,</span> <span class="n">shapely</span><span class="o">.</span><span class="n">points</span><span class="p">(</span><span class="n">right_border</span><span class="o">.</span><span class="n">coords</span><span class="p">),</span> <span class="n">normalized</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="n">shapely</span><span class="o">.</span><span class="n">line_locate_point</span><span class="p">(</span><span class="n">right_border</span><span class="p">,</span> <span class="n">shapely</span><span class="o">.</span><span class="n">points</span><span class="p">(</span><span class="n">left_border</span><span class="o">.</span><span class="n">coords</span><span class="p">),</span> <span class="n">normalized</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ses</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">rbp</span><span class="p">,</span> <span class="n">lbp</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
        <span class="nb">zip</span><span class="p">(</span><span class="n">right_border</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">ses</span><span class="p">,</span> <span class="n">normalized</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">left_border</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">ses</span><span class="p">,</span> <span class="n">normalized</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="p">):</span>
        <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">MultiPoint</span><span class="p">([</span><span class="n">rbp</span><span class="p">,</span> <span class="n">lbp</span><span class="p">])</span><span class="o">.</span><span class="n">minimum_rotated_rectangle</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">coords</span>

    <span class="c1"># TODO some smoothing operation could be helpful</span>
    <span class="n">cl</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">LineString</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cl</span><span class="o">.</span><span class="n">is_empty</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">cl</span><span class="o">.</span><span class="n">is_valid</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Could not compute centerline for lane!&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cl</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="omega_prime.converters.converter"></a>
    <div class="doc doc-contents first">










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="omega_prime.converters.converter.DatasetConverter" class="doc doc-heading">
            <code>DatasetConverter</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>










              <details class="mkdocstrings-source">
                <summary>Source code in <code>omega_prime/converters/converter.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DatasetConverter</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">out_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;./&quot;</span><span class="p">,</span> <span class="n">n_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_out_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_workers</span> <span class="o">=</span> <span class="n">n_workers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">len</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_source_recordings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Abstract method to get a list of the source recordings.</span>
<span class="sd">        The method should be implemented in subclasses to handle specific dataset formats.</span>
<span class="sd">        Returns:</span>
<span class="sd">            source_recordings: List of the source recordings. Could be of any type as further processed in get_recordings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_recordings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_recording</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Abstract method to get all recordings in a source-recording-instance of the specific dataset.</span>
<span class="sd">        The method should be implemented in subclasses to handle specific dataset formats.</span>
<span class="sd">        Args:</span>
<span class="sd">            source_recordings: List of the source recordings. Could be of any type as returned by get_source_recordings.</span>
<span class="sd">        Yields:</span>
<span class="sd">            recording: Each recording in the source-recording-instance, one at a time. Could be of any type as further processed in to_omega_prime_recording and get_recording_id.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_omega_prime_recording</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recording</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Recording</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Abstract method to convert a raw recording into an omega prime recording instance.</span>
<span class="sd">        The method should be implemented in subclasses to handle specific dataset formats.</span>
<span class="sd">        Args:</span>
<span class="sd">            recording: A recording of any type as returned by get_omega_prime_recordings.</span>
<span class="sd">        Returns:</span>
<span class="sd">            Recording: An instance of the Recording class containing the processed data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_recording_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recording</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Abstract method to get the name for a given recording.</span>
<span class="sd">        The method should be implemented in subclasses to handle specific dataset formats.</span>
<span class="sd">        Args:</span>
<span class="sd">            recording: Recording of any type as returned by get_recordings.</span>
<span class="sd">        Returns:</span>
<span class="sd">            str: unique name of recording.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">convert_source_recording</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">source_recording</span><span class="p">,</span> <span class="n">save_as_parquet</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">skip_existing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">log_file</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">recording</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_recordings</span><span class="p">(</span><span class="n">source_recording</span><span class="p">):</span>
                <span class="n">out_filename</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_out_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_recording_name</span><span class="p">(</span><span class="n">recording</span><span class="p">)</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="s1">&#39;parquet&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">save_as_parquet</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;mcap&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">Status</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">source_recording</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">out_filename</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_existing</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">out_filename</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="n">Path</span><span class="p">(</span><span class="n">out_filename</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_omega_prime_recording</span><span class="p">(</span><span class="n">recording</span><span class="p">)</span>
                        <span class="n">status</span><span class="o">.</span><span class="n">set_success</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Error converting recording </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_recording_name</span><span class="p">(</span><span class="n">recording</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="n">rec</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">status</span><span class="o">.</span><span class="n">set_error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">save_as_parquet</span><span class="p">:</span>
                                <span class="n">rec</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">out_filename</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">rec</span><span class="o">.</span><span class="n">to_mcap</span><span class="p">(</span><span class="n">out_filename</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Error saving recording </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_recording_name</span><span class="p">(</span><span class="n">recording</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                            <span class="n">status</span><span class="o">.</span><span class="n">set_error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">status</span><span class="o">.</span><span class="n">set_skip</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">log_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">FileLock</span><span class="p">(</span><span class="n">log_file</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.csv.lock&quot;</span><span class="p">)):</span>
                        <span class="n">status</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing source recording </span><span class="si">{</span><span class="n">source_recording</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">convert</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">n_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_as_parquet</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">skip_existing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">write_log</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">n_workers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_workers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_workers</span>
        <span class="k">if</span> <span class="n">n_workers</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">n_workers</span> <span class="o">=</span> <span class="n">jb</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_out_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">recordings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_source_recordings</span><span class="p">()</span>

        <span class="c1"># Create a log file if requested</span>
        <span class="n">log_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">write_log</span><span class="p">:</span>
            <span class="n">log_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out_path</span> <span class="o">/</span> <span class="s2">&quot;conversion_log.csv&quot;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
                <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;file_path_input&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="s2">&quot;file_path_output&quot;</span><span class="p">,</span> <span class="s2">&quot;error_message&quot;</span><span class="p">]</span>
                <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">len</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">recordings</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="n">n_workers</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">partial_fct</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">convert_source_recording</span><span class="p">,</span>
                <span class="n">save_as_parquet</span><span class="o">=</span><span class="n">save_as_parquet</span><span class="p">,</span>
                <span class="n">skip_existing</span><span class="o">=</span><span class="n">skip_existing</span><span class="p">,</span>
                <span class="n">log_file</span><span class="o">=</span><span class="n">log_file</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">with</span> <span class="n">tqdm_joblib</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Source Recordings&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">len</span><span class="p">):</span>
                <span class="n">jb</span><span class="o">.</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_workers</span><span class="p">)(</span><span class="n">jb</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">partial_fct</span><span class="p">)(</span><span class="n">rec</span><span class="p">)</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">recordings</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">recordings</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">len</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">convert_source_recording</span><span class="p">(</span>
                    <span class="n">rec</span><span class="p">,</span> <span class="n">save_as_parquet</span><span class="o">=</span><span class="n">save_as_parquet</span><span class="p">,</span> <span class="n">skip_existing</span><span class="o">=</span><span class="n">skip_existing</span><span class="p">,</span> <span class="n">log_file</span><span class="o">=</span><span class="n">log_file</span>
                <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">yield_recordings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Recording</span><span class="p">]:</span>
        <span class="n">source_recordings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_source_recordings</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sr</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">source_recordings</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">source_recordings</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">recording</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_recordings</span><span class="p">(</span><span class="n">sr</span><span class="p">):</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_omega_prime_recording</span><span class="p">(</span><span class="n">recording</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">convert_cli</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">dataset_path</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span>
            <span class="n">Path</span><span class="p">,</span>
            <span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dir_okay</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file_okay</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">readable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Root of the dataset&quot;</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="n">output_path</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span>
            <span class="n">Path</span><span class="p">,</span>
            <span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span>
                <span class="n">file_okay</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">writable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;In which folder to write the created omega-prime files&quot;</span>
            <span class="p">),</span>
        <span class="p">],</span>
        <span class="n">n_workers</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set to -1 for n_cpus-1 workers.&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">save_as_parquet</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span>
            <span class="nb">bool</span><span class="p">,</span>
            <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If activated, omega-prime recordings will be stored as parquet files instead of mcap (use for large recordings). Will loose information in OSI that are not mandatory in omega-prime.&quot;</span>
            <span class="p">),</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">skip_existing</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s2">&quot;Only convert not yet converted files&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">write_log</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s2">&quot;Write a log file with the conversion process&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">cls</span><span class="p">(</span><span class="n">dataset_path</span><span class="o">=</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">out_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span> <span class="n">n_workers</span><span class="o">=</span><span class="n">n_workers</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span>
            <span class="n">save_as_parquet</span><span class="o">=</span><span class="n">save_as_parquet</span><span class="p">,</span> <span class="n">skip_existing</span><span class="o">=</span><span class="n">skip_existing</span><span class="p">,</span> <span class="n">write_log</span><span class="o">=</span><span class="n">write_log</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="omega_prime.converters.converter.DatasetConverter.get_recording_name" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_recording_name</span><span class="p">(</span><span class="n">recording</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Abstract method to get the name for a given recording.
The method should be implemented in subclasses to handle specific dataset formats.
Args:
    recording: Recording of any type as returned by get_recordings.
Returns:
    str: unique name of recording.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/converters/converter.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_recording_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recording</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract method to get the name for a given recording.</span>
<span class="sd">    The method should be implemented in subclasses to handle specific dataset formats.</span>
<span class="sd">    Args:</span>
<span class="sd">        recording: Recording of any type as returned by get_recordings.</span>
<span class="sd">    Returns:</span>
<span class="sd">        str: unique name of recording.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.converters.converter.DatasetConverter.get_recordings" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_recordings</span><span class="p">(</span><span class="n">source_recording</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Abstract method to get all recordings in a source-recording-instance of the specific dataset.
The method should be implemented in subclasses to handle specific dataset formats.
Args:
    source_recordings: List of the source recordings. Could be of any type as returned by get_source_recordings.
Yields:
    recording: Each recording in the source-recording-instance, one at a time. Could be of any type as further processed in to_omega_prime_recording and get_recording_id.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/converters/converter.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_recordings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_recording</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract method to get all recordings in a source-recording-instance of the specific dataset.</span>
<span class="sd">    The method should be implemented in subclasses to handle specific dataset formats.</span>
<span class="sd">    Args:</span>
<span class="sd">        source_recordings: List of the source recordings. Could be of any type as returned by get_source_recordings.</span>
<span class="sd">    Yields:</span>
<span class="sd">        recording: Each recording in the source-recording-instance, one at a time. Could be of any type as further processed in to_omega_prime_recording and get_recording_id.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.converters.converter.DatasetConverter.get_source_recordings" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_source_recordings</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Abstract method to get a list of the source recordings.
The method should be implemented in subclasses to handle specific dataset formats.
Returns:
    source_recordings: List of the source recordings. Could be of any type as further processed in get_recordings.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/converters/converter.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_source_recordings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract method to get a list of the source recordings.</span>
<span class="sd">    The method should be implemented in subclasses to handle specific dataset formats.</span>
<span class="sd">    Returns:</span>
<span class="sd">        source_recordings: List of the source recordings. Could be of any type as further processed in get_recordings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.converters.converter.DatasetConverter.to_omega_prime_recording" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_omega_prime_recording</span><span class="p">(</span><span class="n">recording</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Abstract method to convert a raw recording into an omega prime recording instance.
The method should be implemented in subclasses to handle specific dataset formats.
Args:
    recording: A recording of any type as returned by get_omega_prime_recordings.
Returns:
    Recording: An instance of the Recording class containing the processed data.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/converters/converter.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">to_omega_prime_recording</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recording</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Recording</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract method to convert a raw recording into an omega prime recording instance.</span>
<span class="sd">    The method should be implemented in subclasses to handle specific dataset formats.</span>
<span class="sd">    Args:</span>
<span class="sd">        recording: A recording of any type as returned by get_omega_prime_recordings.</span>
<span class="sd">    Returns:</span>
<span class="sd">        Recording: An instance of the Recording class containing the processed data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="omega_prime.metrics"></a>
    <div class="doc doc-contents first">










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="omega_prime.metrics.Metric" class="doc doc-heading">
            <code>Metric</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">



        <p>Class to compute metrics based on polars dataframes.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>omega_prime/metrics.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Metric</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class to compute metrics based on polars dataframes.&quot;&quot;&quot;</span>

    <span class="n">compute_func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">]]]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The function that actually computes the metric&quot;&quot;&quot;</span>
    <span class="n">computes_columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Names of the columns that will be added to the dataframe by this metrics&quot;&quot;&quot;</span>
    <span class="n">computes_properties</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Keys of the tables added to the properties dictionary by this metric&quot;&quot;&quot;</span>
    <span class="n">requires_columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Columns that must be present in the dataframe before this metric can be calculated&quot;&quot;&quot;</span>
    <span class="n">requires_properties</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Keys of tables that must be present in the properties dictionary before this metric can be calculated.&quot;&quot;&quot;</span>
    <span class="n">computes_intermediate_columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Same as computes_columns by these ones will not be returned in the end and are only available to other metrics&quot;&quot;&quot;</span>
    <span class="n">computes_intermediate_properties</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Same as computes_properties but these ones will not be returned in the end and are only available to other metrics.&quot;&quot;&quot;</span>
    <span class="n">_parameters</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;All parameters of metrics that need to be set on computation&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_lazy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">]]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df</span><span class="p">,</span> <span class="n">properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_func</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">computes_properties</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">computes_intermediate_properties</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">properties</span>

        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Missing parameter for Metric with compute_func </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_func</span><span class="p">)</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span>
        <span class="k">assert</span> <span class="s2">&quot;df&quot;</span> <span class="ow">in</span> <span class="n">parameters</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">p</span> <span class="ow">in</span> <span class="n">parameters</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requires_properties</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;df&quot;</span><span class="p">,</span> <span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="s2">&quot;kwargs&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">requires_properties</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">):</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_lazy</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Missing paramter for Metric with compute_func </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="omega_prime.metrics.Metric.compute_func" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_func</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>The function that actually computes the metric</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="omega_prime.metrics.Metric.computes_columns" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">computes_columns</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Names of the columns that will be added to the dataframe by this metrics</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="omega_prime.metrics.Metric.computes_intermediate_columns" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">computes_intermediate_columns</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Same as computes_columns by these ones will not be returned in the end and are only available to other metrics</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="omega_prime.metrics.Metric.computes_intermediate_properties" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">computes_intermediate_properties</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Same as computes_properties but these ones will not be returned in the end and are only available to other metrics.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="omega_prime.metrics.Metric.computes_properties" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">computes_properties</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Keys of the tables added to the properties dictionary by this metric</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="omega_prime.metrics.Metric.requires_columns" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">requires_columns</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Columns that must be present in the dataframe before this metric can be calculated</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="omega_prime.metrics.Metric.requires_properties" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">requires_properties</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Keys of tables that must be present in the properties dictionary before this metric can be calculated.</p>

    </div>

</div>






  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="omega_prime.metrics.MetricManager" class="doc doc-heading">
            <code>MetricManager</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">










              <details class="mkdocstrings-source">
                <summary>Source code in <code>omega_prime/metrics.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MetricManager</span><span class="p">:</span>
    <span class="n">metrics</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">metrics</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;List of metrics to compute&quot;&quot;&quot;</span>
    <span class="n">exclude_columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;List of columns computed by the metrics that do not need to be computed&quot;&quot;&quot;</span>
    <span class="n">exclude_properties</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;List of tables in the properties dict that do not need to be computed&quot;&quot;&quot;</span>
    <span class="n">_dependencies</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Automatically derived dependencies between metrics&quot;&quot;&quot;</span>
    <span class="n">_ordered_metrics</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Automatically derived execution order of metrics&quot;&quot;&quot;</span>
    <span class="n">_parameters</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Automatically derived list of parameters to keep&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">val</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;column_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">computes_columns</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">computes_intermediate_columns</span><span class="p">]</span>
            <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;property_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">computes_properties</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">computes_intermediate_properties</span><span class="p">]</span>
        <span class="p">}</span> <span class="o">|</span> <span class="p">{</span>
            <span class="n">i</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;column_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">requires_columns</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;property_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">requires_properties</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="n">unresovled_dependencies</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vv</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unresovled_dependencies</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">error_dict</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;self.metrics[</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">unresovled_dependencies</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;There are columns and properties required by metrics, that are never computed: </span><span class="si">{</span><span class="n">error_dict</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">_parameters</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">exclude_columns</span> <span class="o">+=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">computes_intermediate_columns</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exclude_properties</span> <span class="o">+=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">computes_intermediate_properties</span><span class="p">]</span>

        <span class="n">ts</span> <span class="o">=</span> <span class="n">graphlib</span><span class="o">.</span><span class="n">TopologicalSorter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ordered_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">ts</span><span class="o">.</span><span class="n">static_order</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="nb">int</span><span class="p">)]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;computes columns: </span><span class="si">{</span><span class="p">[</span><span class="n">c</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_ordered_metrics</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">computes_columns</span><span class="p">]</span><span class="si">}</span><span class="s2"> - computes properties </span><span class="si">{</span><span class="p">[</span><span class="n">p</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_ordered_metrics</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">computes_properties</span><span class="p">]</span><span class="si">}</span><span class="s2"> - parameters </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">]))</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="n">Recording</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="s2">&quot;polygon&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">_add_polygons</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">_df</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;geometry&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">from_shapely</span><span class="p">(</span><span class="s2">&quot;polygon&quot;</span><span class="p">))</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">_df</span><span class="p">)</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ordered_metrics</span><span class="p">:</span>
            <span class="n">df</span><span class="p">,</span> <span class="n">new_p</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">compute_lazy</span><span class="p">(</span>
                <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">properties</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">requires_properties</span><span class="p">},</span>
                <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">_parameters</span><span class="p">]},</span>
            <span class="p">)</span>
            <span class="n">properties</span> <span class="o">|=</span> <span class="n">new_p</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclude_properties</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">properties</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exclude_columns</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">collect_all</span><span class="p">([</span><span class="n">df</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">properties</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">computed_props</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclude_columns</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">computes_columns</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">properties</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">computed_props</span><span class="p">)}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ordered_metrics</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">compute_func</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">pos</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">i</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">cn</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;column_</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">computes_columns</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">computes_intermediate_columns</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
                <span class="sa">f</span><span class="s2">&quot;property_</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">computes_properties</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">computes_intermediate_properties</span>
            <span class="p">]</span>
            <span class="n">pos</span> <span class="o">|=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cn</span><span class="p">)}</span>
            <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightblue&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cn</span><span class="p">:</span>
                <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightgreen&quot;</span><span class="p">)</span>
                <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;computes&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;column_</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">requires_columns</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;property_</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">requires_properties</span><span class="p">]:</span>
                <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;required by&quot;</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Draw nodes and edges</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span>
            <span class="n">G</span><span class="p">,</span>
            <span class="n">pos</span><span class="p">,</span>
            <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">node_size</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
            <span class="n">node_color</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">get_node_attributes</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="n">arrows</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">font_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="omega_prime.metrics.MetricManager.exclude_columns" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">exclude_columns</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>List of columns computed by the metrics that do not need to be computed</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="omega_prime.metrics.MetricManager.exclude_properties" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">exclude_properties</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>List of tables in the properties dict that do not need to be computed</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="omega_prime.metrics.MetricManager.metrics" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">metrics</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">metrics</span><span class="p">))</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>List of metrics to compute</p>

    </div>

</div>






  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="omega_prime.metrics.distance_traveled" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">distance_traveled</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Metric that computes the column <code>distance_traveled</code></p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/metrics.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@metric</span><span class="p">(</span><span class="n">computes_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;distance_traveled&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">distance_traveled</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Metric that computes the column `distance_traveled`&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
        <span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="o">.</span><span class="n">cum_sum</span><span class="p">()</span>
        <span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;distance_traveled&quot;</span><span class="p">),</span>
    <span class="p">),</span> <span class="p">{}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="omega_prime.metrics.metric" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">metric</span><span class="p">(</span><span class="n">computes_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">computes_properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">requires_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">requires_properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">computes_intermediate_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">computes_intermediate_properties</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Decorator to turn a function into a Metric</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/metrics.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">metric</span><span class="p">(</span>
    <span class="n">computes_columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">computes_properties</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">requires_columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">requires_properties</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">computes_intermediate_columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">computes_intermediate_properties</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator to turn a function into a Metric&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Metric</span><span class="p">(</span>
            <span class="n">compute_func</span><span class="o">=</span><span class="n">func</span><span class="p">,</span>
            <span class="n">computes_columns</span><span class="o">=</span><span class="n">computes_columns</span> <span class="ow">or</span> <span class="p">[],</span>
            <span class="n">computes_properties</span><span class="o">=</span><span class="n">computes_properties</span> <span class="ow">or</span> <span class="p">[],</span>
            <span class="n">requires_columns</span><span class="o">=</span><span class="n">requires_columns</span> <span class="ow">or</span> <span class="p">[],</span>
            <span class="n">requires_properties</span><span class="o">=</span><span class="n">requires_properties</span> <span class="ow">or</span> <span class="p">[],</span>
            <span class="n">computes_intermediate_columns</span><span class="o">=</span><span class="n">computes_intermediate_columns</span> <span class="ow">or</span> <span class="p">[],</span>
            <span class="n">computes_intermediate_properties</span><span class="o">=</span><span class="n">computes_intermediate_properties</span> <span class="ow">or</span> <span class="p">[],</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">decorator</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="omega_prime.metrics.p_timegaps_and_min_p_timgaps" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">p_timegaps_and_min_p_timgaps</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="n">ego_id</span><span class="p">,</span> <span class="n">crossed</span><span class="p">,</span> <span class="n">timegaps</span><span class="p">,</span> <span class="n">time_buffer</span><span class="o">=</span><span class="mf">2000000000.0</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Metrics that computes a predicted timegap between <code>ego_id</code> and all other objects. <code>time_buffer</code> gives the timespan in which intersection of trajectories is tested. The prediction is based on constant velocity following the same trajectory as observed.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/metrics.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@metric</span><span class="p">(</span>
    <span class="n">requires_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;distance_traveled&quot;</span><span class="p">,</span> <span class="s2">&quot;vel&quot;</span><span class="p">],</span>
    <span class="n">requires_properties</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;crossed&quot;</span><span class="p">,</span> <span class="s2">&quot;timegaps&quot;</span><span class="p">],</span>
    <span class="n">computes_properties</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;p_timegaps&quot;</span><span class="p">,</span> <span class="s2">&quot;min_p_timegaps&quot;</span><span class="p">],</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">p_timegaps_and_min_p_timgaps</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="n">ego_id</span><span class="p">,</span> <span class="n">crossed</span><span class="p">,</span> <span class="n">timegaps</span><span class="p">,</span> <span class="n">time_buffer</span><span class="o">=</span><span class="mf">2e9</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Metrics that computes a predicted timegap between `ego_id` and all other objects. `time_buffer` gives the timespan in which intersection of trajectories is tested. The prediction is based on constant velocity following the same trajectory as observed.&quot;&quot;&quot;</span>
    <span class="n">p_timegaps</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">crossed</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timegaps</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;_overlap&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">,</span> <span class="s2">&quot;idx_ego&quot;</span><span class="p">])</span>
        <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;total_nanos_overlap&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">then</span><span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;total_nanos_overlap&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span>
            <span class="o">.</span><span class="n">otherwise</span><span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;distance_traveled_overlap&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;distance_traveled&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vel&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;time_to_overlap&quot;</span><span class="p">),</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;total_nanos_ego&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;total_nanos_ego_overlap&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">then</span><span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;total_nanos_ego_overlap&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;total_nanos_ego&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span>
            <span class="o">.</span><span class="n">otherwise</span><span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;distance_traveled_ego_overlap&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;distance_traveled_ego&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vel_ego&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;time_to_overlap_ego&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="o">-</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;time_to_overlap_ego&quot;</span><span class="p">)</span>
                <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;time_to_overlap&quot;</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;total_nanos_ego&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="mf">1e9</span>
            <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;p_timegap&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;idx_ego&quot;</span><span class="p">,</span> <span class="s2">&quot;idx&quot;</span><span class="p">,</span> <span class="s2">&quot;total_nanos_ego&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;p_timegap&quot;</span><span class="p">,</span> <span class="s2">&quot;total_nanos&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">sort_by</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;p_timegap&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">(),</span> <span class="n">descending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nulls_last</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;idx_ego&quot;</span><span class="p">,</span> <span class="s2">&quot;idx&quot;</span><span class="p">,</span> <span class="s2">&quot;total_nanos_ego&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">min_p_timegaps</span> <span class="o">=</span> <span class="n">p_timegaps</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;idx_ego&quot;</span><span class="p">,</span> <span class="s2">&quot;idx&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;p_timegap&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_by</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;p_timegap&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">(),</span> <span class="n">descending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="p">{</span>
        <span class="s2">&quot;p_timegaps&quot;</span><span class="p">:</span> <span class="n">p_timegaps</span><span class="p">,</span>
        <span class="s2">&quot;min_p_timegaps&quot;</span><span class="p">:</span> <span class="n">min_p_timegaps</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="omega_prime.metrics.timegaps_and_min_timgaps" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">timegaps_and_min_timgaps</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="n">ego_id</span><span class="p">,</span> <span class="n">time_buffer</span><span class="o">=</span><span class="mf">2000000000.0</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Metrics that computes timegaps between <code>ego_id</code> and all other objects. <code>time_buffer</code> gives the timespan in which intersection of trajectories is tested</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/metrics.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@metric</span><span class="p">(</span>
    <span class="n">requires_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;distance_traveled&quot;</span><span class="p">,</span> <span class="s2">&quot;vel&quot;</span><span class="p">],</span>
    <span class="n">computes_properties</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;timegaps&quot;</span><span class="p">,</span> <span class="s2">&quot;min_timegaps&quot;</span><span class="p">],</span>
    <span class="n">computes_intermediate_properties</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;crossed&quot;</span><span class="p">],</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">timegaps_and_min_timgaps</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="n">ego_id</span><span class="p">,</span> <span class="n">time_buffer</span><span class="o">=</span><span class="mf">2e9</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Metrics that computes timegaps between `ego_id` and all other objects. `time_buffer` gives the timespan in which intersection of trajectories is tested&quot;&quot;&quot;</span>
    <span class="n">ego_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="n">ego_id</span><span class="p">)</span>

    <span class="n">crossed</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ego_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;cross&quot;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;_ego&quot;</span><span class="p">)</span>

    <span class="n">crossed</span> <span class="o">=</span> <span class="n">crossed</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;total_nanos_ego&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">time_buffer</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;total_nanos_ego&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">time_buffer</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">),</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;idx_ego&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">all_timegaps</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">crossed</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;geometry&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">st</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;geometry_ego&quot;</span><span class="p">)))</span>
        <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">timegap</span><span class="o">=</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;total_nanos&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;total_nanos_ego&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span>
        <span class="o">.</span><span class="n">select</span><span class="p">(</span>
            <span class="s2">&quot;idx_ego&quot;</span><span class="p">,</span> <span class="s2">&quot;idx&quot;</span><span class="p">,</span> <span class="s2">&quot;total_nanos_ego&quot;</span><span class="p">,</span> <span class="s2">&quot;total_nanos&quot;</span><span class="p">,</span> <span class="s2">&quot;timegap&quot;</span><span class="p">,</span> <span class="s2">&quot;distance_traveled&quot;</span><span class="p">,</span> <span class="s2">&quot;distance_traveled_ego&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">timegaps</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">all_timegaps</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">,</span> <span class="s2">&quot;idx_ego&quot;</span><span class="p">,</span> <span class="s2">&quot;total_nanos_ego&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;timegap&quot;</span><span class="p">,</span> <span class="s2">&quot;total_nanos&quot;</span><span class="p">,</span> <span class="s2">&quot;distance_traveled&quot;</span><span class="p">,</span> <span class="s2">&quot;distance_traveled_ego&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;timegap&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">arg_min</span><span class="p">()</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;idx_ego&quot;</span><span class="p">,</span> <span class="s2">&quot;idx&quot;</span><span class="p">,</span> <span class="s2">&quot;total_nanos_ego&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">select</span><span class="p">(</span>
            <span class="s2">&quot;idx_ego&quot;</span><span class="p">,</span> <span class="s2">&quot;idx&quot;</span><span class="p">,</span> <span class="s2">&quot;total_nanos_ego&quot;</span><span class="p">,</span> <span class="s2">&quot;timegap&quot;</span><span class="p">,</span> <span class="s2">&quot;total_nanos&quot;</span><span class="p">,</span> <span class="s2">&quot;distance_traveled&quot;</span><span class="p">,</span> <span class="s2">&quot;distance_traveled_ego&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">min_timegaps</span> <span class="o">=</span> <span class="n">timegaps</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;idx_ego&quot;</span><span class="p">,</span> <span class="s2">&quot;idx&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;timegap&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;timegap&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">arg_min</span><span class="p">())</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;min_timegap&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;timegaps&quot;</span><span class="p">:</span> <span class="n">timegaps</span><span class="p">,</span> <span class="s2">&quot;min_timegaps&quot;</span><span class="p">:</span> <span class="n">min_timegaps</span><span class="p">,</span> <span class="s2">&quot;crossed&quot;</span><span class="p">:</span> <span class="n">crossed</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="omega_prime.metrics.vel" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">vel</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Metric that computes the column length of the speed vecotr <code>vel</code></p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/metrics.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@metric</span><span class="p">(</span><span class="n">computes_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;vel&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">vel</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Metric that computes the column length of the speed vecotr `vel`&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vel_x&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vel_y&quot;</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;vel&quot;</span><span class="p">),</span>
    <span class="p">),</span> <span class="p">{}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="omega_prime.mapsegment"></a>
    <div class="doc doc-contents first">










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="omega_prime.mapsegment.MapSegmentType" class="doc doc-heading">
            <code>MapSegmentType</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="enum.Enum">Enum</span></code></p>



        <p>Classification of MapSegments.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>omega_prime/mapsegment.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MapSegmentType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Classification of MapSegments.&quot;&quot;&quot;</span>

    <span class="n">STRAIGHT</span> <span class="o">=</span> <span class="s2">&quot;straight&quot;</span>
    <span class="n">JUNCTION</span> <span class="o">=</span> <span class="s2">&quot;junction&quot;</span>
    <span class="n">ROUNDABOUT</span> <span class="o">=</span> <span class="s2">&quot;roundabout&quot;</span>
    <span class="n">RAMP_ON</span> <span class="o">=</span> <span class="s2">&quot;ramp_on&quot;</span>
    <span class="n">RAMP_OFF</span> <span class="o">=</span> <span class="s2">&quot;ramp_off&quot;</span>
    <span class="n">UNKNOWN</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="omega_prime.mapsegment.MapSegmentation" class="doc doc-heading">
            <code>MapSegmentation</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>



        <p>Abstract base class for map segmentation that handles multiple segments on a single map.
Concrete implementations must define how to extract lane-specific information.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>omega_prime/mapsegment.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MapSegmentation</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract base class for map segmentation that handles multiple segments on a single map.</span>
<span class="sd">    Concrete implementations must define how to extract lane-specific information.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recording</span><span class="p">,</span> <span class="n">concave_hull_ratio</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="n">recording</span><span class="o">.</span><span class="n">map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span> <span class="o">=</span> <span class="n">recording</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">lanes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trafficlight</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trafficlight_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intersections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lane_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lane_successors_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lane_predecessors_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intersecting_lanes_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intersection_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">segments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">concave_hull_ratio</span> <span class="o">=</span> <span class="n">concave_hull_ratio</span>

        <span class="n">segment_name</span> <span class="o">=</span> <span class="n">nt</span><span class="p">(</span><span class="s2">&quot;SegmentName&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;lane_id&quot;</span><span class="p">,</span> <span class="s2">&quot;segment_idx&quot;</span><span class="p">,</span> <span class="s2">&quot;segment&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_lane_id</span><span class="p">(</span><span class="n">lane</span><span class="p">)]</span> <span class="o">=</span> <span class="n">segment_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_lane_id</span><span class="p">(</span><span class="n">lane</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_lane_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract lane ID from a lane object. Map-type specific.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_lane_centerline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">shapely</span><span class="o">.</span><span class="n">LineString</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract centerline from a lane object. Map-type specific.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_lane_successors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract successor IDs from a lane object. Map-type specific.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_lane_predecessors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract predecessor IDs from a lane object. Map-type specific.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_has_traffic_light</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if lane has traffic light. Map-type specific.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_traffic_light</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get traffic light object from lane. Map-type specific.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_set_lane_on_intersection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the on_intersection attribute for a lane. Map-type specific.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_set_lane_is_approaching</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the is_approaching attribute for a lane. Map-type specific.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_lane_on_intersection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the on_intersection status of a lane. Map-type specific.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="c1"># Concrete methods using abstract methods</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_lane_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a dictionary mapping each lane&#39;s lane_id to the lane object.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lane_dict</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_lane_id</span><span class="p">(</span><span class="n">lane</span><span class="p">):</span> <span class="n">lane</span> <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">()}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_dict</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_lane_successors_and_predecessors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns dictionaries mapping each lane&#39;s lane_id to its successor and predecessor lane indices.&quot;&quot;&quot;</span>
        <span class="n">lane_successors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">lane_predecessors</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">lane_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lane_id</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span>
            <span class="n">lane_successors</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lane_successors</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span>
            <span class="n">lane_predecessors</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lane_predecessors</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lane_successors_dict</span> <span class="o">=</span> <span class="n">lane_successors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lane_predecessors_dict</span> <span class="o">=</span> <span class="n">lane_predecessors</span>
        <span class="k">return</span> <span class="n">lane_successors</span><span class="p">,</span> <span class="n">lane_predecessors</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_if_all_lanes_are_on_segment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if all lanes are on a segment.</span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: True if all lanes are on a segment, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">lane_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lane_id</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lane_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]</span><span class="o">.</span><span class="n">segment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="omega_prime.mapsegment.MapSegmentation.check_if_all_lanes_are_on_segment" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">check_if_all_lanes_are_on_segment</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Checks if all lanes are on a segment.
Returns:
    bool: True if all lanes are on a segment, False otherwise.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/mapsegment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_if_all_lanes_are_on_segment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks if all lanes are on a segment.</span>
<span class="sd">    Returns:</span>
<span class="sd">        bool: True if all lanes are on a segment, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">lane_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lane_id</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lane_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]</span><span class="o">.</span><span class="n">segment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.mapsegment.MapSegmentation.create_lane_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_lane_dict</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Returns a dictionary mapping each lane's lane_id to the lane object.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/mapsegment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_lane_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a dictionary mapping each lane&#39;s lane_id to the lane object.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lane_dict</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_lane_id</span><span class="p">(</span><span class="n">lane</span><span class="p">):</span> <span class="n">lane</span> <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">()}</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_dict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.mapsegment.MapSegmentation.get_lane_successors_and_predecessors" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_lane_successors_and_predecessors</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Returns dictionaries mapping each lane's lane_id to its successor and predecessor lane indices.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/mapsegment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_lane_successors_and_predecessors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns dictionaries mapping each lane&#39;s lane_id to its successor and predecessor lane indices.&quot;&quot;&quot;</span>
    <span class="n">lane_successors</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">lane_predecessors</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">lane_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lane_id</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span>
        <span class="n">lane_successors</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lane_successors</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span>
        <span class="n">lane_predecessors</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lane_predecessors</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">lane_successors_dict</span> <span class="o">=</span> <span class="n">lane_successors</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lane_predecessors_dict</span> <span class="o">=</span> <span class="n">lane_predecessors</span>
    <span class="k">return</span> <span class="n">lane_successors</span><span class="p">,</span> <span class="n">lane_predecessors</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="omega_prime.mapsegment.Segment" class="doc doc-heading">
            <code>Segment</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>



        <p>A class that represents a segment of the map</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>omega_prime/mapsegment.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Segment</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A class that represents a segment of the map&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lanes</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">concave_hull_ratio</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span> <span class="o">=</span> <span class="n">lanes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lane_ids</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_lane_id</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span> <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="n">lanes</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trafficlights</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">concave_hull_ratio</span> <span class="o">=</span> <span class="n">concave_hull_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">MapSegmentType</span><span class="o">.</span><span class="n">UNKNOWN</span>

        <span class="c1"># Cache polygon to avoid recomputing concave hull when lanes stay unchanged</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_polygon_cache</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_polygon_cache_key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_polygon_dirty</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">polygon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_segment_polygon</span><span class="p">()</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_lane_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract lane ID from a lane object. Map-type specific.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_lane_geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">shapely</span><span class="o">.</span><span class="n">LineString</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract geometry from a lane object. Map-type specific.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_trafficlight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set traffic lights for this segment. Map-type specific.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_polygon_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_lane_id</span><span class="p">(</span><span class="n">lane</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lane_geometry</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span><span class="o">.</span><span class="n">wkb</span><span class="p">)</span> <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_segment_polygon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lane_centerline</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_lane_geometry</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span> <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="p">]</span>
        <span class="n">multilinestring</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">MultiLineString</span><span class="p">(</span><span class="n">lane_centerline</span><span class="p">)</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">unary_union</span><span class="p">(</span><span class="n">multilinestring</span><span class="p">)</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hull</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">concave_hull</span><span class="p">(</span><span class="n">combined</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">concave_hull_ratio</span><span class="p">)</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">hull</span><span class="o">.</span><span class="n">is_empty</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">shapely</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">GEOSException</span><span class="p">,</span> <span class="ne">AssertionError</span><span class="p">):</span>
            <span class="n">hull</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">convex_hull</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">hull</span><span class="o">.</span><span class="n">is_empty</span>
        <span class="k">return</span> <span class="n">hull</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_polygon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_polygon_key</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">force</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_polygon_dirty</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_polygon_cache_key</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_polygon_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_segment_polygon</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_polygon_cache_key</span> <span class="o">=</span> <span class="n">key</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_polygon_dirty</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_polygon_cache</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_center_point</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Returns the center point of the segment&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">y</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_segment_polygon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Create the Polygon of the Segment&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_polygon</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_polygon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Updates the Polygon of the Segment&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_polygon_dirty</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">polygon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_polygon</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_lane</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lanes</span><span class="p">,</span> <span class="n">update_polygon</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds a lane to the segment.</span>
<span class="sd">        If the lane is already in the segment, it will not be added again.</span>

<span class="sd">        Args:</span>
<span class="sd">            lane (list): A list of lane objects to be added to the segment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="n">lanes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lane</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lane_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_lane_id</span><span class="p">(</span><span class="n">lane</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">update_polygon</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_polygon</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_trafficlight</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_timeinterval_on_segment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">roaduser</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets a roadsegment as input as well as a roaduser trajectory.</span>
<span class="sd">        Returns the time interval of the roaduser on the segment.</span>
<span class="sd">        roaduser should be a np.array with (total_nanos, x, y)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">:</span>
            <span class="n">roaduser_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">shapely</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">roaduser</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]]</span>
            <span class="n">roaduser_on_segment</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">point</span><span class="p">)</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">roaduser_points</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">roaduser_on_segment</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">roaduser_on_segment</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">roaduser</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span> <span class="n">roaduser</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="omega_prime.mapsegment.Segment.add_lane" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_lane</span><span class="p">(</span><span class="n">lanes</span><span class="p">,</span> <span class="n">update_polygon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Adds a lane to the segment.
If the lane is already in the segment, it will not be added again.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>lane</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of lane objects to be added to the segment.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/mapsegment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_lane</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lanes</span><span class="p">,</span> <span class="n">update_polygon</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adds a lane to the segment.</span>
<span class="sd">    If the lane is already in the segment, it will not be added again.</span>

<span class="sd">    Args:</span>
<span class="sd">        lane (list): A list of lane objects to be added to the segment.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="n">lanes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">lane</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lane_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_lane_id</span><span class="p">(</span><span class="n">lane</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">update_polygon</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_polygon</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">set_trafficlight</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.mapsegment.Segment.create_segment_polygon" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_segment_polygon</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Create the Polygon of the Segment</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/mapsegment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_segment_polygon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s2">&quot;Create the Polygon of the Segment&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_polygon</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.mapsegment.Segment.get_center_point" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_center_point</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Returns the center point of the segment</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/mapsegment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_center_point</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s2">&quot;Returns the center point of the segment&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">y</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.mapsegment.Segment.get_timeinterval_on_segment" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_timeinterval_on_segment</span><span class="p">(</span><span class="n">roaduser</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Gets a roadsegment as input as well as a roaduser trajectory.
Returns the time interval of the roaduser on the segment.
roaduser should be a np.array with (total_nanos, x, y)</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/mapsegment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_timeinterval_on_segment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">roaduser</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets a roadsegment as input as well as a roaduser trajectory.</span>
<span class="sd">    Returns the time interval of the roaduser on the segment.</span>
<span class="sd">    roaduser should be a np.array with (total_nanos, x, y)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="p">:</span>
        <span class="n">roaduser_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">shapely</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">roaduser</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]]</span>
        <span class="n">roaduser_on_segment</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">point</span><span class="p">)</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">roaduser_points</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">roaduser_on_segment</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">roaduser_on_segment</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">roaduser</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span> <span class="n">roaduser</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.mapsegment.Segment.set_trafficlight" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_trafficlight</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Set traffic lights for this segment. Map-type specific.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/mapsegment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">set_trafficlight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set traffic lights for this segment. Map-type specific.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.mapsegment.Segment.update_polygon" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_polygon</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Updates the Polygon of the Segment</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/mapsegment.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_polygon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s2">&quot;Updates the Polygon of the Segment&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_polygon_dirty</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">polygon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_polygon</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="omega_prime.maposicenterlinesegmentation"></a>
    <div class="doc doc-contents first">










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="omega_prime.maposicenterlinesegmentation.ConnectionSegment" class="doc doc-heading">
            <code>ConnectionSegment</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" href="#omega_prime.maposicenterlinesegmentation.SegmentOsiCenterline">SegmentOsiCenterline</a></code></p>










              <details class="mkdocstrings-source">
                <summary>Source code in <code>omega_prime/maposicenterlinesegmentation.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ConnectionSegment</span><span class="p">(</span><span class="n">SegmentOsiCenterline</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lanes</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">concave_hull_ratio</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">lanes</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">concave_hull_ratio</span><span class="o">=</span><span class="n">concave_hull_ratio</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">MapSegmentType</span><span class="o">.</span><span class="n">STRAIGHT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intersection_idxs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_plot</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plots the Connection segment</span>

<span class="sd">        Args:</span>
<span class="sd">            output_plot (Path): Path to the output directory.</span>
<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Add the index of the center line to the plot</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection segment </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="o">.</span><span class="n">xy</span><span class="p">)[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                <span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">lane_id</span><span class="p">,</span>
                <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">m</span><span class="p">],</span> <span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">m</span><span class="p">]),</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="c1"># Plot the polygon into the intersection</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="si">}</span><span class="s2"> has no polygon&quot;</span><span class="p">)</span>
            <span class="k">pass</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="p">)</span><span class="si">}</span><span class="s2"> lanes&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;X Coordinate&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Y Coordinate&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output_plot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output_plot</span><span class="p">,</span> <span class="n">Path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">output_plot</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="n">output_plot</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_plot</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;Connection</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="si">}</span><span class="s2">.pdf&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;output_plot must be a Path to a directory or None&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="omega_prime.maposicenterlinesegmentation.ConnectionSegment.plot" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot</span><span class="p">(</span><span class="n">output_plot</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Plots the Connection segment</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>output_plot</code>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the output directory.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:
    None</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/maposicenterlinesegmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_plot</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plots the Connection segment</span>

<span class="sd">    Args:</span>
<span class="sd">        output_plot (Path): Path to the output directory.</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Add the index of the center line to the plot</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection segment </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="o">.</span><span class="n">xy</span><span class="p">)[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">lane_id</span><span class="p">,</span>
            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">m</span><span class="p">],</span> <span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">m</span><span class="p">]),</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="c1"># Plot the polygon into the intersection</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="si">}</span><span class="s2"> has no polygon&quot;</span><span class="p">)</span>
        <span class="k">pass</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="p">)</span><span class="si">}</span><span class="s2"> lanes&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;X Coordinate&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Y Coordinate&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">output_plot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output_plot</span><span class="p">,</span> <span class="n">Path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">output_plot</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
        <span class="n">output_plot</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_plot</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;Connection</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="si">}</span><span class="s2">.pdf&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;output_plot must be a Path to a directory or None&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation" class="doc doc-heading">
            <code>MapOsiCenterlineSegmentation</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" href="#omega_prime.mapsegment.MapSegmentation">MapSegmentation</a></code></p>



        <p>A class that identifies different segments on a OsiCenterline Map.
Concrete implementation of MapSegmentation for OSI centerline maps.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>omega_prime/maposicenterlinesegmentation.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MapOsiCenterlineSegmentation</span><span class="p">(</span><span class="n">MapSegmentation</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class that identifies different segments on a OsiCenterline Map.</span>
<span class="sd">    Concrete implementation of MapSegmentation for OSI centerline maps.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recording</span><span class="p">,</span> <span class="n">lane_buffer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">intersection_overlap_buffer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">concave_hull_ratio</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">recording</span><span class="p">,</span> <span class="n">concave_hull_ratio</span><span class="o">=</span><span class="n">concave_hull_ratio</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locator</span> <span class="o">=</span> <span class="n">Locator</span><span class="o">.</span><span class="n">from_map</span><span class="p">(</span><span class="n">recording</span><span class="o">.</span><span class="n">map</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isolated_connections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lane_buffer</span> <span class="o">=</span> <span class="n">lane_buffer</span> <span class="k">if</span> <span class="n">lane_buffer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intersection_overlap_buffer</span> <span class="o">=</span> <span class="n">intersection_overlap_buffer</span> <span class="k">if</span> <span class="n">intersection_overlap_buffer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_combine_intersections</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">tl_state</span> <span class="ow">in</span> <span class="n">recording</span><span class="o">.</span><span class="n">traffic_light_states</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">tl</span> <span class="ow">in</span> <span class="n">tl_state</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tl</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trafficlight_ids</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trafficlight</span><span class="p">[</span><span class="n">tl</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">tl</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trafficlight_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="c1"># Implement abstract methods for OSI centerline maps</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_lane_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract lane ID from OSI centerline lane.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">lane_id</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_lane_centerline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">shapely</span><span class="o">.</span><span class="n">LineString</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract centerline from OSI centerline lane.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">lane</span><span class="o">.</span><span class="n">centerline</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_lane_successors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract successor IDs from OSI centerline lane.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">succ_id</span><span class="o">.</span><span class="n">lane_id</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">succ_id</span><span class="p">,</span> <span class="s2">&quot;lane_id&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">succ_id</span> <span class="k">for</span> <span class="n">succ_id</span> <span class="ow">in</span> <span class="n">lane</span><span class="o">.</span><span class="n">successor_ids</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_lane_predecessors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract predecessor IDs from OSI centerline lane.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">pred_id</span><span class="o">.</span><span class="n">lane_id</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pred_id</span><span class="p">,</span> <span class="s2">&quot;lane_id&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">pred_id</span> <span class="k">for</span> <span class="n">pred_id</span> <span class="ow">in</span> <span class="n">lane</span><span class="o">.</span><span class="n">predecessor_ids</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_has_traffic_light</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if OSI centerline lane has traffic light.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="s2">&quot;trafficlight&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lane</span><span class="o">.</span><span class="n">trafficlight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_traffic_light</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get traffic light object from OSI centerline lane.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">lane</span><span class="o">.</span><span class="n">trafficlight</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_traffic_light</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_lane_on_intersection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the on_intersection attribute for OSI centerline lane.&quot;&quot;&quot;</span>
        <span class="n">lane</span><span class="o">.</span><span class="n">on_intersection</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_lane_is_approaching</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the is_approaching attribute for OSI centerline lane.&quot;&quot;&quot;</span>
        <span class="n">lane</span><span class="o">.</span><span class="n">is_approaching</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_lane_on_intersection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the on_intersection status of OSI centerline lane.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">lane</span><span class="o">.</span><span class="n">on_intersection</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="s2">&quot;on_intersection&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init_intersections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the intersections in the map.</span>
<span class="sd">        Args:</span>
<span class="sd">            None</span>
<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_lane_dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_lane_successors_and_predecessors</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parallel_lane_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_parallel_lane_dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_intersecting_lanes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lane_trafficlights</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph_intersection_detection</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="n">add_lanexy_to_graph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_intersection_idx</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_combine_intersections</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_non_intersecting_lanes_to_intersection</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">combine_intersections</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_intersection_idx</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_intersection_dict</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">create_lane_segment_dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">find_isolated_connections</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_lane_segment_dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_if_all_lanes_are_on_segment</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_segment_ids</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_lane_segment_dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_road_ids</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lane_intersection_relation</span><span class="p">()</span>

        <span class="c1"># from pathlib import Path</span>
        <span class="c1"># #Plot the graph G with x and y coordinates of the lanes</span>
        <span class="c1"># plot_graph(self.G , Path(&quot;/scenario-center-playground/scenarios/&quot;) / &quot;graph_plot.pdf&quot;)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_road_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the road_ids of the lane to the segment ID</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">updates_needed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">old_to_new_mapping</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># First pass: identify what needs to be updated</span>
        <span class="k">for</span> <span class="n">lane_idx</span><span class="p">,</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">lane_id</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">lane_id</span>
            <span class="k">if</span> <span class="n">lane_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]</span><span class="o">.</span><span class="n">segment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">new_road_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]</span><span class="o">.</span><span class="n">segment</span><span class="o">.</span><span class="n">idx</span>
                <span class="k">if</span> <span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">road_id</span> <span class="o">!=</span> <span class="n">new_road_id</span><span class="p">:</span>
                    <span class="n">new_idx</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">road_id</span><span class="o">=</span><span class="n">new_road_id</span><span class="p">)</span>
                    <span class="n">updates_needed</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">lane_idx</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">new_idx</span><span class="p">))</span>
                    <span class="n">old_to_new_mapping</span><span class="p">[</span><span class="n">lane_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_idx</span>

        <span class="c1"># Second pass: apply updates efficiently</span>
        <span class="k">for</span> <span class="n">old_idx</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">new_idx</span> <span class="ow">in</span> <span class="n">updates_needed</span><span class="p">:</span>
            <span class="c1"># Update the lane object in place</span>
            <span class="n">lane</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">new_idx</span>

            <span class="c1"># Only modify dictionary if the key actually changed</span>
            <span class="k">if</span> <span class="n">old_idx</span> <span class="o">!=</span> <span class="n">new_idx</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="p">[</span><span class="n">new_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">lane</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="p">[</span><span class="n">old_idx</span><span class="p">]</span>

        <span class="c1"># Third pass: update all predecessor and successor references</span>
        <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="c1"># Update predecessor references</span>
            <span class="n">updated_predecessors</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pred_id</span> <span class="ow">in</span> <span class="n">lane</span><span class="o">.</span><span class="n">predecessor_ids</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pred_id</span> <span class="ow">in</span> <span class="n">old_to_new_mapping</span><span class="p">:</span>
                    <span class="n">updated_predecessors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">old_to_new_mapping</span><span class="p">[</span><span class="n">pred_id</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">updated_predecessors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred_id</span><span class="p">)</span>
            <span class="n">lane</span><span class="o">.</span><span class="n">predecessor_ids</span> <span class="o">=</span> <span class="n">updated_predecessors</span>

            <span class="c1"># Update successor references</span>
            <span class="n">updated_successors</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">succ_id</span> <span class="ow">in</span> <span class="n">lane</span><span class="o">.</span><span class="n">successor_ids</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">succ_id</span> <span class="ow">in</span> <span class="n">old_to_new_mapping</span><span class="p">:</span>
                    <span class="n">updated_successors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">old_to_new_mapping</span><span class="p">[</span><span class="n">succ_id</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">updated_successors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">succ_id</span><span class="p">)</span>
            <span class="n">lane</span><span class="o">.</span><span class="n">successor_ids</span> <span class="o">=</span> <span class="n">updated_successors</span>

        <span class="c1"># Fourth pass: update internal dictionaries that track relationships</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lane_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">lane_id</span><span class="p">:</span> <span class="n">lane</span> <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_lane_successors_and_predecessors</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_segment_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Updates the segment IDs of the map segmentation&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">segments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersections</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">isolated_connections</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">segment</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">):</span>
            <span class="n">segment</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">segment</span><span class="o">.</span><span class="n">set_trafficlight</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_parallel_lane_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a dictionary mapping each lane&#39;s lane_id to the lane ids which are parallel to it</span>
<span class="sd">        Args:</span>
<span class="sd">            None</span>
<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary mapping each lane&#39;s lane_id to the lane ids which are parallel to it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lane_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">lane_id</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">()}</span>

        <span class="c1"># Precompute lane directions for faster comparisons</span>
        <span class="n">lane_directions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">lane_centerlines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lane_ids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lane_directions</span><span class="p">[</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">lane_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">direction</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>
            <span class="n">lane_centerlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="p">)</span>
            <span class="n">lane_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">lane_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">lane_centerlines</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">lane_dict</span>

        <span class="c1"># Use original centerlines for spatial index, buffer only when needed</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">STRtree</span><span class="p">(</span><span class="n">lane_centerlines</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lane</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">lane_id</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">lane_id</span>

            <span class="c1"># Create buffer only when querying, not storing it</span>
            <span class="n">buffer_geom</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">candidates</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">buffer_geom</span><span class="p">)</span>

            <span class="c1"># Clear the buffer immediately after use</span>
            <span class="k">del</span> <span class="n">buffer_geom</span>

            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
                <span class="n">other_lane_id</span> <span class="o">=</span> <span class="n">lane_ids</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">other_lane_id</span> <span class="o">==</span> <span class="n">lane_id</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Compare directions using dot product</span>
                <span class="n">dir1</span> <span class="o">=</span> <span class="n">lane_directions</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]</span>
                <span class="n">dir2</span> <span class="o">=</span> <span class="n">lane_directions</span><span class="p">[</span><span class="n">other_lane_id</span><span class="p">]</span>
                <span class="n">dot_product</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dir1</span><span class="p">,</span> <span class="n">dir2</span><span class="p">)),</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="n">angle_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">dot_product</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">angle_deg</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="n">lane_dict</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">other_lane_id</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lane_dict</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">trajectory_segment_detection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectory</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Splits a trajectory into segments based on the lane it is located on</span>

<span class="sd">        Args:</span>
<span class="sd">            trajectory (np.ndarray): A NumPy array of shape (n, 3) representing the trajectory, where each row is a (frame, x, y) coordinate.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of tuples, where each tuple contains a segment of the trajectory and the segment it intersects with.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">segments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">current_segment</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="n">trajectory</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># Extract x and y coordinates</span>
        <span class="n">sts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locator</span><span class="o">.</span><span class="n">xys2sts</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>
        <span class="n">lane_ids</span> <span class="o">=</span> <span class="n">sts</span><span class="p">[</span><span class="s2">&quot;roadlane_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">segment_idx</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span><span class="p">[</span><span class="n">lane_id</span><span class="o">.</span><span class="n">lane_id</span><span class="p">]</span><span class="o">.</span><span class="n">segment</span><span class="o">.</span><span class="n">idx</span> <span class="k">for</span> <span class="n">lane_id</span> <span class="ow">in</span> <span class="n">lane_ids</span><span class="p">]</span>

        <span class="n">trajectory</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">trajectory</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">trajectory</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">trajectory</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">lane_ids</span><span class="p">,</span> <span class="n">segment_idx</span><span class="p">))</span>

        <span class="c1"># Create spatial index for intersection polygons</span>
        <span class="n">intersection_polygons</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">intersection_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">segment</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">MapSegmentType</span><span class="o">.</span><span class="n">JUNCTION</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="s2">&quot;polygon&quot;</span><span class="p">):</span>
                <span class="n">intersection_polygons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">segment</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span>
                <span class="n">intersection_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">segment</span><span class="o">.</span><span class="n">idx</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">intersection_polygons</span><span class="p">:</span>
            <span class="c1"># Use spatial index for efficient intersection queries</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="n">STRtree</span><span class="p">(</span><span class="n">intersection_polygons</span><span class="p">)</span>

            <span class="c1"># Process points in batches for better performance</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">trajectory</span><span class="p">):</span>
                <span class="n">point</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

                <span class="c1"># Query spatial index instead of checking all polygons</span>
                <span class="n">candidates</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">intersection_polygons</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">point</span><span class="p">):</span>
                        <span class="n">trajectory</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">intersection_ids</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                        <span class="k">break</span>

        <span class="c1"># Rest of the method for creating segments</span>
        <span class="n">prev_seg_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">segment_idx</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">trajectory</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">prev_seg_id</span> <span class="o">==</span> <span class="n">segment_idx</span><span class="p">:</span>
                <span class="n">current_segment</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">frame</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">current_segment</span><span class="p">:</span>
                    <span class="n">segments</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">current_segment</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">[</span><span class="n">prev_seg_id</span><span class="p">]))</span>
                <span class="n">current_segment</span> <span class="o">=</span> <span class="p">[(</span><span class="n">frame</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)]</span>
                <span class="n">prev_seg_id</span> <span class="o">=</span> <span class="n">segment_idx</span>

        <span class="k">if</span> <span class="n">current_segment</span><span class="p">:</span>
            <span class="n">segments</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">current_segment</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">[</span><span class="n">prev_seg_id</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">segments</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_intersecting_lanes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dictionary mapping each lane&#39;s lane_id to an array of lane ids it intersects with.</span>

<span class="sd">        Args:</span>
<span class="sd">            lanes (list): Array of lane objects, each with an `idx` and `centerline` attribute.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary where keys are lane ids and values are arrays of intersecting lane ids.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">buffer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_buffer</span>

        <span class="c1"># Create spatial index directly from centerlines</span>
        <span class="n">lane_centerlines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lane_ids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">lane_centerlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="p">)</span>
            <span class="n">lane_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">lane_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">lane_centerlines</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">intersecting_lanes_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="n">STRtree</span><span class="p">(</span><span class="n">lane_centerlines</span><span class="p">)</span>

        <span class="c1"># Pre-compute lane relationships for faster lookup</span>
        <span class="n">successors_set</span> <span class="o">=</span> <span class="p">{</span><span class="n">lane_id</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">successors</span><span class="p">)</span> <span class="k">for</span> <span class="n">lane_id</span><span class="p">,</span> <span class="n">successors</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_successors_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">predecessors_set</span> <span class="o">=</span> <span class="p">{</span><span class="n">lane_id</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">predecessors</span><span class="p">)</span> <span class="k">for</span> <span class="n">lane_id</span><span class="p">,</span> <span class="n">predecessors</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_predecessors_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">parallel_set</span> <span class="o">=</span> <span class="p">{</span><span class="n">lane_id</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">parallel</span><span class="p">)</span> <span class="k">for</span> <span class="n">lane_id</span><span class="p">,</span> <span class="n">parallel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel_lane_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="n">intersecting_lanes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lane</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">lane_id</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">lane_id</span>

            <span class="c1"># Query spatial index with buffered geometry</span>
            <span class="n">buffered_centerline</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
            <span class="n">candidates</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">buffered_centerline</span><span class="p">)</span>

            <span class="n">intersecting_lanes</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
                <span class="n">candidate_id</span> <span class="o">=</span> <span class="n">lane_ids</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">candidate_id</span> <span class="o">!=</span> <span class="n">lane_id</span>
                    <span class="ow">and</span> <span class="n">candidate_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">successors_set</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]</span>
                    <span class="ow">and</span> <span class="n">candidate_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">predecessors_set</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]</span>
                    <span class="ow">and</span> <span class="n">candidate_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parallel_set</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]</span>
                    <span class="ow">and</span> <span class="n">buffered_centerline</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">lane_centerlines</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
                <span class="p">):</span>
                    <span class="c1"># Only buffer and test intersection for valid candidates</span>
                    <span class="n">intersecting_lanes</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">candidate_id</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">intersecting_lanes_dict</span> <span class="o">=</span> <span class="n">intersecting_lanes</span>
        <span class="k">return</span> <span class="n">intersecting_lanes</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">graph_intersection_detection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Detects intersections in a graph of lanes based on their intersections, successors, and predecessors.</span>

<span class="sd">        Args:</span>
<span class="sd">            lane_dict (dict): A dictionary where keys are lane indices and values are arrays of intersecting lane indices.</span>
<span class="sd">            lane_successors (dict): A dictionary where keys are lane indices and values are arrays of successor lane indices.</span>
<span class="sd">            lane_predecessors (dict): A dictionary where keys are lane indices and values are arrays of predecessor lane indices.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of intersections, where each intersection is a set of lane indices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create a Graph using networkx</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>

        <span class="c1"># Add nodes and edges to the graph. If a lane has a intersection, add the lanes as nodes and the intersection as an edge</span>
        <span class="c1"># Add edges directly (nodes are added automatically)</span>
        <span class="k">for</span> <span class="n">lane_id</span><span class="p">,</span> <span class="n">intersecting_lanes</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersecting_lanes_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">G</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">((</span><span class="n">lane_id</span><span class="p">,</span> <span class="n">other_lane</span><span class="p">)</span> <span class="k">for</span> <span class="n">other_lane</span> <span class="ow">in</span> <span class="n">intersecting_lanes</span><span class="p">)</span>

        <span class="n">intersections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">inter</span> <span class="ow">in</span> <span class="n">nx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">G</span><span class="p">):</span>
            <span class="c1"># Convert lane_ids back to lane objects</span>
            <span class="n">intersection_lanes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lane_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">inter</span><span class="p">]</span>
            <span class="n">intersection</span> <span class="o">=</span> <span class="n">Intersection</span><span class="p">(</span><span class="n">intersection_lanes</span><span class="p">,</span> <span class="n">concave_hull_ratio</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">concave_hull_ratio</span><span class="p">)</span>
            <span class="n">intersections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intersection</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">intersections</span> <span class="o">=</span> <span class="n">intersections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="n">G</span>
        <span class="k">return</span> <span class="n">intersections</span><span class="p">,</span> <span class="n">G</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">combine_intersections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A function that revieves a list with idx [[1,2] , [4,5,6] , ...] of intersections that need to be combined.</span>
<span class="sd">        It will combine all those intersections and will then update all intersections in the map_segmentation class.</span>

<span class="sd">        Args:</span>
<span class="sd">            intersection_list (list): A list of lists, where each inner list contains the indices of intersections to be combined.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Check for intersections that can be combined:</span>
        <span class="n">combined_intersections</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Create spatial index of all intersection polygons</span>
        <span class="k">for</span> <span class="n">intersection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersections</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">intersection</span><span class="p">,</span> <span class="s2">&quot;_buffered_polygon&quot;</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">intersection</span><span class="o">.</span><span class="n">_buffer_value</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersection_overlap_buffer</span>
            <span class="p">):</span>
                <span class="n">intersection</span><span class="o">.</span><span class="n">_buffered_polygon</span> <span class="o">=</span> <span class="n">intersection</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intersection_overlap_buffer</span><span class="p">)</span>
                <span class="n">intersection</span><span class="o">.</span><span class="n">_buffer_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersection_overlap_buffer</span>

        <span class="n">polygons</span> <span class="o">=</span> <span class="p">[</span><span class="n">intersection</span><span class="o">.</span><span class="n">_buffered_polygon</span> <span class="k">for</span> <span class="n">intersection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersections</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">polygons</span><span class="p">:</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="n">STRtree</span><span class="p">(</span><span class="n">polygons</span><span class="p">)</span>

            <span class="c1"># Find overlapping intersections efficiently</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">intersection</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intersections</span><span class="p">):</span>
                <span class="n">buffered_poly</span> <span class="o">=</span> <span class="n">polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">candidates</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">buffered_poly</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">j</span> <span class="ow">and</span> <span class="n">buffered_poly</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">polygons</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
                        <span class="n">combined_intersections</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
        <span class="n">final_combined</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_resulting_intersections</span><span class="p">(</span><span class="n">combined_intersections</span><span class="p">)</span>
        <span class="n">new_intersections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">combination</span> <span class="ow">in</span> <span class="n">final_combined</span><span class="p">:</span>
            <span class="n">combined_lanes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">combination</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                    <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                    <span class="n">combined_lanes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intersections</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">lanes</span><span class="p">)</span>

            <span class="n">new_intersections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Intersection</span><span class="p">(</span><span class="n">combined_lanes</span><span class="p">,</span> <span class="n">concave_hull_ratio</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">concave_hull_ratio</span><span class="p">))</span>

        <span class="c1"># Add unvisited intersections</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">intersection</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intersections</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                <span class="n">new_intersections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intersection</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">intersections</span> <span class="o">=</span> <span class="n">new_intersections</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">intersections_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intersection1</span><span class="p">,</span> <span class="n">intersection2</span><span class="p">,</span> <span class="n">buffer</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if two intersections overlap.</span>

<span class="sd">        Args:</span>
<span class="sd">            intersection1 (Intersection): The first intersection object.</span>
<span class="sd">            intersection2 (Intersection): The second intersection object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the intersections overlap, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">buffer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersection_overlap_buffer</span>

        <span class="c1"># Use cached buffers if available</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">intersection1</span><span class="p">,</span> <span class="s2">&quot;_buffered_polygon&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">intersection1</span><span class="o">.</span><span class="n">_buffer_value</span> <span class="o">!=</span> <span class="n">buffer</span><span class="p">:</span>
            <span class="n">intersection1</span><span class="o">.</span><span class="n">_buffered_polygon</span> <span class="o">=</span> <span class="n">intersection1</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
            <span class="n">intersection1</span><span class="o">.</span><span class="n">_buffer_value</span> <span class="o">=</span> <span class="n">buffer</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">intersection2</span><span class="p">,</span> <span class="s2">&quot;_buffered_polygon&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">intersection2</span><span class="o">.</span><span class="n">_buffer_value</span> <span class="o">!=</span> <span class="n">buffer</span><span class="p">:</span>
            <span class="n">intersection2</span><span class="o">.</span><span class="n">_buffered_polygon</span> <span class="o">=</span> <span class="n">intersection2</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
            <span class="n">intersection2</span><span class="o">.</span><span class="n">_buffer_value</span> <span class="o">=</span> <span class="n">buffer</span>

        <span class="k">return</span> <span class="n">intersection1</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">intersection2</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">combine_intersection_on_polygon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intersection1</span><span class="p">,</span> <span class="n">intersection2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Combine two intersections into one if they overlap.</span>
<span class="sd">        Args:</span>
<span class="sd">            intersection1 (Intersection): The first intersection object.</span>
<span class="sd">            intersection2 (Intersection): The second intersection object.</span>
<span class="sd">        Returns:</span>
<span class="sd">            Intersection: The combined intersection object if they overlap, None otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersections_overlap</span><span class="p">(</span><span class="n">intersection1</span><span class="p">,</span> <span class="n">intersection2</span><span class="p">):</span>
            <span class="c1"># Create a new intersection object with the lanes from both intersections</span>
            <span class="n">combined_intersection</span> <span class="o">=</span> <span class="n">Intersection</span><span class="p">(</span>
                <span class="n">intersection1</span><span class="o">.</span><span class="n">lanes</span> <span class="o">+</span> <span class="n">intersection2</span><span class="o">.</span><span class="n">lanes</span><span class="p">,</span> <span class="n">concave_hull_ratio</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">concave_hull_ratio</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">combined_intersection</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">find_resulting_intersections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intersection_pairs</span><span class="p">):</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span><span class="n">intersection_pairs</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">component</span><span class="p">)</span> <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">nx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">G</span><span class="p">)]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_intersection_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the index for each intersection in the list of intersections.</span>
<span class="sd">        Args:</span>
<span class="sd">            None</span>
<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">intersection</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intersections</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">isolated_connections</span><span class="p">):</span>
            <span class="n">intersection</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">i</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_intersection_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creats a dictionary where the key is the intersection id and the value is the intersection object.</span>
<span class="sd">        Args:</span>
<span class="sd">            None</span>
<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">intersection_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">intersection</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intersections</span><span class="p">):</span>
            <span class="n">intersection_dict</span><span class="p">[</span><span class="n">intersection</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">intersection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intersection_dict</span> <span class="o">=</span> <span class="n">intersection_dict</span>
        <span class="k">return</span> <span class="n">intersection_dict</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_non_intersecting_lanes_to_intersection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add all lanes that are within the intersection polygon to the intersection object.</span>
<span class="sd">        Args:</span>
<span class="sd">            None</span>
<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">intersection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersections</span><span class="p">:</span>
            <span class="n">intersection</span><span class="o">.</span><span class="n">update_polygon</span><span class="p">()</span>

            <span class="c1"># Collect all lanes to add before modifying the intersection</span>
            <span class="n">lanes_to_add</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">buffered_polygon</span> <span class="o">=</span> <span class="n">intersection</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lane_buffer</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">lane_id</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">lane_id</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">lane_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">intersection</span><span class="o">.</span><span class="n">lane_ids</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]</span><span class="o">.</span><span class="n">segment</span> <span class="ow">is</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="n">buffered_polygon</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">lanes_to_add</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span>

            <span class="c1"># Add all lanes at once and update polygon only once</span>
            <span class="k">if</span> <span class="n">lanes_to_add</span><span class="p">:</span>
                <span class="n">intersection</span><span class="o">.</span><span class="n">add_lane</span><span class="p">(</span><span class="n">lanes</span><span class="o">=</span><span class="n">lanes_to_add</span><span class="p">,</span> <span class="n">update_polygon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Assuming bulk add method</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_lane_segment_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a dictionary mapping lane IDs to their segment information.</span>
<span class="sd">        Args:</span>
<span class="sd">            None</span>
<span class="sd">        Returns:</span>
<span class="sd">            lane_segment_dict (dict): A dictionary mapping lane IDs to their segment information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">segment_name</span> <span class="o">=</span> <span class="n">nt</span><span class="p">(</span><span class="s2">&quot;SegmentName&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;lane_id&quot;</span><span class="p">,</span> <span class="s2">&quot;segment_idx&quot;</span><span class="p">,</span> <span class="s2">&quot;segment&quot;</span><span class="p">])</span>
        <span class="n">segment_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersections</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">isolated_connections</span>

        <span class="c1"># Initialize with None values more efficiently</span>
        <span class="n">lane_segment_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">lane_id</span><span class="p">:</span> <span class="n">segment_name</span><span class="p">(</span><span class="n">lane_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">lane_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>

        <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">segment_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="n">segment</span><span class="o">.</span><span class="n">lanes</span><span class="p">:</span>
                <span class="n">lane_id</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">lane_id</span>

                <span class="c1"># Single lookup with caching</span>
                <span class="n">current_entry</span> <span class="o">=</span> <span class="n">lane_segment_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lane_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">current_entry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">current_entry</span><span class="o">.</span><span class="n">segment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Lane not assigned to any segment yet</span>
                    <span class="n">lane_segment_dict</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">segment_name</span><span class="p">(</span><span class="n">lane_id</span><span class="p">,</span> <span class="n">segment</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">segment</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">current_entry</span><span class="o">.</span><span class="n">segment_idx</span> <span class="o">!=</span> <span class="n">segment</span><span class="o">.</span><span class="n">idx</span><span class="p">:</span>
                    <span class="c1"># Conflict: lane already assigned to different segment</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Lane </span><span class="si">{</span><span class="n">lane_id</span><span class="si">}</span><span class="s2"> already in segment </span><span class="si">{</span><span class="n">current_entry</span><span class="o">.</span><span class="n">segment_idx</span><span class="si">}</span><span class="s2">, &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;cannot assign to segment </span><span class="si">{</span><span class="n">segment</span><span class="o">.</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span> <span class="o">=</span> <span class="n">lane_segment_dict</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_non_intersecting_lane_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a graph with each lane which is not part of a intersection as a node and the edges are the successors and predecessors of the lanes.</span>
<span class="sd">        Args:</span>
<span class="sd">            None</span>
<span class="sd">        Returns:</span>
<span class="sd">            G (networkx.Graph): A graph with each lane as a node and the edges are the successors and predecessors of the lanes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">lane_id</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">lane_id</span>
            <span class="k">if</span> <span class="n">lane_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]</span><span class="o">.</span><span class="n">segment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">lane_id</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">successor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_successors_dict</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">successor</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span><span class="p">[</span><span class="n">successor</span><span class="p">]</span><span class="o">.</span><span class="n">segment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">lane_id</span><span class="p">,</span> <span class="n">successor</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">predecessor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_predecessors_dict</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">predecessor</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span><span class="p">[</span><span class="n">predecessor</span><span class="p">]</span><span class="o">.</span><span class="n">segment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">lane_id</span><span class="p">,</span> <span class="n">predecessor</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">G</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">find_isolated_connections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find all isolated strings of connections in the graph. Then Check if any of those lanes would be part of an intersection.</span>
<span class="sd">        Args:</span>
<span class="sd">            None</span>
<span class="sd">        Returns:</span>
<span class="sd">            isolated_connections (list): A list of lists, where each inner list contains the indices of lanes that are part of an isolated connection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_non_intersecting_lane_graph</span><span class="p">()</span>
        <span class="n">isolated_connections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">new_connections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">nx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">G</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">component</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">isolated_connections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ConnectionSegment</span><span class="p">(</span>
                        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lane_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">component</span><span class="p">],</span> <span class="n">concave_hull_ratio</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">concave_hull_ratio</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="c1"># Check if any of the lanes in the isolated connections are part of an intersection</span>
        <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="n">isolated_connections</span><span class="p">:</span>
            <span class="n">pre</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">suc</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">lane_id</span> <span class="ow">in</span> <span class="n">connection</span><span class="o">.</span><span class="n">lane_ids</span><span class="p">:</span>
                <span class="c1"># Check if the lane has a predecessor or successor that is part of an intersection</span>
                <span class="k">for</span> <span class="n">successor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_successors_dict</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">successor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span><span class="p">[</span><span class="n">successor</span><span class="p">]</span><span class="o">.</span><span class="n">segment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">connection</span><span class="o">.</span><span class="n">intersection_idxs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span><span class="p">[</span><span class="n">successor</span><span class="p">]</span><span class="o">.</span><span class="n">segment_idx</span><span class="p">)</span>
                        <span class="n">suc</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">predecessor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_predecessors_dict</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">predecessor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span>
                        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span><span class="p">[</span><span class="n">predecessor</span><span class="p">]</span><span class="o">.</span><span class="n">segment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="p">):</span>
                        <span class="n">connection</span><span class="o">.</span><span class="n">intersection_idxs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span><span class="p">[</span><span class="n">predecessor</span><span class="p">]</span><span class="o">.</span><span class="n">segment_idx</span><span class="p">)</span>
                        <span class="n">pre</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">intersection_idxs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">pre</span> <span class="ow">and</span> <span class="n">suc</span><span class="p">:</span>
                <span class="c1"># There is a predecessor and a successor that are part of an intersection so the connection is part of the intersection:</span>
                <span class="c1"># Add all the lanes to the intersection:</span>
                <span class="k">for</span> <span class="n">lane_id</span> <span class="ow">in</span> <span class="n">connection</span><span class="o">.</span><span class="n">lane_ids</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">intersection_dict</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">intersection_idxs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lane_dict</span><span class="p">[</span><span class="n">lane_id</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">intersection_dict</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">intersection_idxs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">lane_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lane_id</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">intersection_dict</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">intersection_idxs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">update_polygon</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_connections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>

        <span class="n">isolated_connections</span> <span class="o">=</span> <span class="n">new_connections</span>
        <span class="c1"># Create ConnectionSegment for all lanes, that are on multiple intersections:</span>

        <span class="n">isolated_connections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_isolated_connections</span><span class="p">(</span><span class="n">isolated_connections</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">isolated_connections</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">combine_isolated_connections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isolated_connections</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if any of the isolated connections are connecting the same intersections.</span>
<span class="sd">        If yes, then combine them into one connection.</span>
<span class="sd">        Args:</span>
<span class="sd">            isolated_connections (list): A list of ConnectionSegment objects representing isolated connections.</span>
<span class="sd">        Returns:</span>
<span class="sd">            isolated_connections (list): A list of ConnectionSegment objects representing the combined isolated connections.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isolated_connections</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># Group connections by their intersection indices for efficient comparison</span>
        <span class="n">connections_by_intersections</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">connection</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">isolated_connections</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">intersection_idxs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">connections_by_intersections</span><span class="p">:</span>
                <span class="n">connections_by_intersections</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">connections_by_intersections</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="n">combined_connections</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Process each group of connections with same intersection indices</span>
        <span class="k">for</span> <span class="n">intersection_set</span><span class="p">,</span> <span class="n">connection_indices</span> <span class="ow">in</span> <span class="n">connections_by_intersections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">connection_indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersection_set</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Multiple intersections: combine all connections</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">connection_indices</span><span class="p">)):</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">connection_indices</span><span class="p">)):</span>
                            <span class="n">combined_connections</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">connection_indices</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">connection_indices</span><span class="p">[</span><span class="n">j</span><span class="p">]])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Single intersection: check distance</span>
                    <span class="n">connections_to_check</span> <span class="o">=</span> <span class="p">[</span><span class="n">isolated_connections</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">connection_indices</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">connections_to_check</span><span class="p">)):</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">connections_to_check</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">connections_to_check</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">connections_to_check</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">polygon</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                                <span class="n">combined_connections</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">connection_indices</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">connection_indices</span><span class="p">[</span><span class="n">j</span><span class="p">]])</span>

        <span class="c1"># Rest of the method remains the same</span>
        <span class="n">final_combined</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_resulting_intersections</span><span class="p">(</span><span class="n">combined_connections</span><span class="p">)</span>
        <span class="n">new_connections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">combination</span> <span class="ow">in</span> <span class="n">final_combined</span><span class="p">:</span>
            <span class="n">combined_lanes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">combination</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                    <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                    <span class="n">combined_lanes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">isolated_connections</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">lanes</span><span class="p">)</span>
            <span class="n">new_connections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ConnectionSegment</span><span class="p">(</span><span class="n">combined_lanes</span><span class="p">,</span> <span class="n">concave_hull_ratio</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">concave_hull_ratio</span><span class="p">))</span>

        <span class="c1"># Add unvisited connections</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">connection</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">isolated_connections</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                <span class="n">new_connections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">isolated_connections</span> <span class="o">=</span> <span class="n">new_connections</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">isolated_connections</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_lane_intersection_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the attribute lane.is_approaching true if the lane is connecting to an intersection.</span>
<span class="sd">        Sets the attribute lane.on_intersection true if the lane is part of an intersection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_lane_on_intersection</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_lane_is_approaching</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Process intersection lanes and their predecessors efficiently</span>
        <span class="k">for</span> <span class="n">intersection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersections</span><span class="p">:</span>
            <span class="c1"># Mark intersection lanes</span>
            <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="n">intersection</span><span class="o">.</span><span class="n">lanes</span><span class="p">:</span>
                <span class="n">lane_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lane_id</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">lane_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_set_lane_on_intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="p">[</span><span class="n">lane_id</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Process predecessors for each lane in the intersection</span>
                <span class="k">for</span> <span class="n">predecessor_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lane_predecessors</span><span class="p">(</span><span class="n">lane</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">predecessor_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_dict</span><span class="p">:</span>
                        <span class="n">predecessor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_dict</span><span class="p">[</span><span class="n">predecessor_id</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lane_on_intersection</span><span class="p">(</span><span class="n">predecessor</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_set_lane_is_approaching</span><span class="p">(</span><span class="n">predecessor</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_lane_trafficlights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the traffic lights for each lane of the map.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create spatial index for lane centerlines</span>
        <span class="n">lane_centerlines</span> <span class="o">=</span> <span class="p">[</span><span class="n">lane</span><span class="o">.</span><span class="n">centerline</span> <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="n">lane_objects</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="n">STRtree</span><span class="p">(</span><span class="n">lane_centerlines</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">tl_idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trafficlight</span><span class="p">:</span>
            <span class="n">traffic_light_found</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Create traffic light position point</span>
            <span class="n">tl_point</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trafficlight</span><span class="p">[</span><span class="n">tl_idx</span><span class="p">]</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trafficlight</span><span class="p">[</span><span class="n">tl_idx</span><span class="p">]</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

            <span class="c1"># Use spatial index to find candidate lanes</span>
            <span class="n">candidates</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">nearest</span><span class="p">(</span><span class="n">tl_point</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">candidates</span><span class="p">:</span>
                <span class="n">lane</span> <span class="o">=</span> <span class="n">lane_objects</span><span class="p">[</span><span class="n">candidates</span><span class="p">]</span>
                <span class="n">lane</span><span class="o">.</span><span class="n">traffic_light</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trafficlight</span><span class="p">[</span><span class="n">tl_idx</span><span class="p">]</span>
                <span class="n">traffic_light_found</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">traffic_light_found</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Traffic light </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">trafficlight</span><span class="p">[</span><span class="n">tl_idx</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> not found in any lane&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">output_plot</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">trajectory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">plot_lane_ids</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">plot_intersection_polygons</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">plot_connection_polygons</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the intersections and saves the plot to the specified output path.</span>
<span class="sd">        A Trajectory can be given to plot it on the map. The Trajectory should be a numpy array of shape (n,3) where each row is (frame, x, y)</span>
<span class="sd">        Args:</span>
<span class="sd">            output_plot (Path): Path to a folder where the plot will be saved. If None, the plot will be shown instead.</span>
<span class="sd">            trajectory (numpy.ndarray): The trajectory to be plotted. If None, no trajectory will be plotted.</span>
<span class="sd">            plot_lane_ids (bool): Whether to plot lane IDs on the map.</span>
<span class="sd">            plot_intersection_polygons (bool): Whether to plot intersection polygons.</span>
<span class="sd">            plot_connection_polygons (bool): Whether to plot connection polygons.</span>
<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Plot the map by plotting all the centerlines:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">c</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span>
            <span class="k">if</span> <span class="n">lane</span><span class="o">.</span><span class="n">on_intersection</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span>
            <span class="k">elif</span> <span class="n">lane</span><span class="o">.</span><span class="n">is_approaching</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="s2">&quot;orange&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot_lane_ids</span><span class="p">:</span>
            <span class="n">lane_midpoints</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">normalized</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">lane_id</span><span class="p">,</span> <span class="n">midpoint</span> <span class="ow">in</span> <span class="n">lane_midpoints</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">lane_id</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">midpoint</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">midpoint</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">inter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersections</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">inter</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="n">inter</span><span class="o">.</span><span class="n">get_center_point</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">plot_intersection_polygons</span><span class="p">:</span>
                <span class="c1"># Plot the polygon into the intersection</span>
                <span class="n">inter</span><span class="o">.</span><span class="n">update_polygon</span><span class="p">()</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">inter</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">combi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">isolated_connections</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">combi</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="n">combi</span><span class="o">.</span><span class="n">get_center_point</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
            <span class="c1"># Plot the polygon into the intersection</span>
            <span class="k">if</span> <span class="n">plot_connection_polygons</span><span class="p">:</span>
                <span class="n">combi</span><span class="o">.</span><span class="n">update_polygon</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">combi</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection </span><span class="si">{</span><span class="n">combi</span><span class="o">.</span><span class="n">idx</span><span class="si">}</span><span class="s2"> has no polygon&quot;</span><span class="p">)</span>
                    <span class="k">pass</span>

        <span class="k">for</span> <span class="n">tl_idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trafficlight</span><span class="p">:</span>
            <span class="n">position</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trafficlight</span><span class="p">[</span><span class="n">tl_idx</span><span class="p">]</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trafficlight</span><span class="p">[</span><span class="n">tl_idx</span><span class="p">]</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                <span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
                <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Traffic Light </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">trafficlight</span><span class="p">[</span><span class="n">tl_idx</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Plot the trajectory if it is given</span>
        <span class="k">if</span> <span class="n">trajectory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">trajectory</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">trajectory</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;yellow&quot;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Host Vehicle Trajectory&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Mark start and end points</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">trajectory</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">trajectory</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;go&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Start&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">trajectory</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">trajectory</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;ro&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;End&quot;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">*</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">())</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">*</span><span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">())</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Map with Intersections&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;X Coordinate (m)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Y Coordinate (m)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output_plot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output_plot</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
                <span class="n">output_plot</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_plot</span> <span class="o">/</span> <span class="s2">&quot;Map_with_Intersection.pdf&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">output_plot</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                <span class="n">output_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_plot</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">output_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                    <span class="n">output_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_path</span> <span class="o">/</span> <span class="s2">&quot;Map_with_Intersection.pdf&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">output_path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">:</span>
                    <span class="n">output_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_intersections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_plot</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots all intersections and saves them to the output path.</span>
<span class="sd">        Args:</span>
<span class="sd">            output_plot (Path): Path to a folder where the plots will be saved.</span>
<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">intersection</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intersections</span><span class="p">):</span>
            <span class="n">intersection</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">output_plot</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">connection</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">isolated_connections</span><span class="p">):</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">output_plot</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.add_non_intersecting_lanes_to_intersection" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_non_intersecting_lanes_to_intersection</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add all lanes that are within the intersection polygon to the intersection object.
Args:
    None
Returns:
    None</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/maposicenterlinesegmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_non_intersecting_lanes_to_intersection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add all lanes that are within the intersection polygon to the intersection object.</span>
<span class="sd">    Args:</span>
<span class="sd">        None</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">intersection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersections</span><span class="p">:</span>
        <span class="n">intersection</span><span class="o">.</span><span class="n">update_polygon</span><span class="p">()</span>

        <span class="c1"># Collect all lanes to add before modifying the intersection</span>
        <span class="n">lanes_to_add</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">buffered_polygon</span> <span class="o">=</span> <span class="n">intersection</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lane_buffer</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">lane_id</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">lane_id</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">lane_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">intersection</span><span class="o">.</span><span class="n">lane_ids</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]</span><span class="o">.</span><span class="n">segment</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">buffered_polygon</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">lanes_to_add</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span>

        <span class="c1"># Add all lanes at once and update polygon only once</span>
        <span class="k">if</span> <span class="n">lanes_to_add</span><span class="p">:</span>
            <span class="n">intersection</span><span class="o">.</span><span class="n">add_lane</span><span class="p">(</span><span class="n">lanes</span><span class="o">=</span><span class="n">lanes_to_add</span><span class="p">,</span> <span class="n">update_polygon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Assuming bulk add method</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.combine_intersection_on_polygon" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">combine_intersection_on_polygon</span><span class="p">(</span><span class="n">intersection1</span><span class="p">,</span> <span class="n">intersection2</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Combine two intersections into one if they overlap.
Args:
    intersection1 (Intersection): The first intersection object.
    intersection2 (Intersection): The second intersection object.
Returns:
    Intersection: The combined intersection object if they overlap, None otherwise.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/maposicenterlinesegmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">combine_intersection_on_polygon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intersection1</span><span class="p">,</span> <span class="n">intersection2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combine two intersections into one if they overlap.</span>
<span class="sd">    Args:</span>
<span class="sd">        intersection1 (Intersection): The first intersection object.</span>
<span class="sd">        intersection2 (Intersection): The second intersection object.</span>
<span class="sd">    Returns:</span>
<span class="sd">        Intersection: The combined intersection object if they overlap, None otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersections_overlap</span><span class="p">(</span><span class="n">intersection1</span><span class="p">,</span> <span class="n">intersection2</span><span class="p">):</span>
        <span class="c1"># Create a new intersection object with the lanes from both intersections</span>
        <span class="n">combined_intersection</span> <span class="o">=</span> <span class="n">Intersection</span><span class="p">(</span>
            <span class="n">intersection1</span><span class="o">.</span><span class="n">lanes</span> <span class="o">+</span> <span class="n">intersection2</span><span class="o">.</span><span class="n">lanes</span><span class="p">,</span> <span class="n">concave_hull_ratio</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">concave_hull_ratio</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">combined_intersection</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.combine_intersections" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">combine_intersections</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>A function that revieves a list with idx [[1,2] , [4,5,6] , ...] of intersections that need to be combined.
It will combine all those intersections and will then update all intersections in the map_segmentation class.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>intersection_list</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of lists, where each inner list contains the indices of intersections to be combined.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/maposicenterlinesegmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">combine_intersections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A function that revieves a list with idx [[1,2] , [4,5,6] , ...] of intersections that need to be combined.</span>
<span class="sd">    It will combine all those intersections and will then update all intersections in the map_segmentation class.</span>

<span class="sd">    Args:</span>
<span class="sd">        intersection_list (list): A list of lists, where each inner list contains the indices of intersections to be combined.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Check for intersections that can be combined:</span>
    <span class="n">combined_intersections</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Create spatial index of all intersection polygons</span>
    <span class="k">for</span> <span class="n">intersection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersections</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">intersection</span><span class="p">,</span> <span class="s2">&quot;_buffered_polygon&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">intersection</span><span class="o">.</span><span class="n">_buffer_value</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersection_overlap_buffer</span>
        <span class="p">):</span>
            <span class="n">intersection</span><span class="o">.</span><span class="n">_buffered_polygon</span> <span class="o">=</span> <span class="n">intersection</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intersection_overlap_buffer</span><span class="p">)</span>
            <span class="n">intersection</span><span class="o">.</span><span class="n">_buffer_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersection_overlap_buffer</span>

    <span class="n">polygons</span> <span class="o">=</span> <span class="p">[</span><span class="n">intersection</span><span class="o">.</span><span class="n">_buffered_polygon</span> <span class="k">for</span> <span class="n">intersection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersections</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">polygons</span><span class="p">:</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">STRtree</span><span class="p">(</span><span class="n">polygons</span><span class="p">)</span>

        <span class="c1"># Find overlapping intersections efficiently</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">intersection</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intersections</span><span class="p">):</span>
            <span class="n">buffered_poly</span> <span class="o">=</span> <span class="n">polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">candidates</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">buffered_poly</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">j</span> <span class="ow">and</span> <span class="n">buffered_poly</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">polygons</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
                    <span class="n">combined_intersections</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
    <span class="n">final_combined</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_resulting_intersections</span><span class="p">(</span><span class="n">combined_intersections</span><span class="p">)</span>
    <span class="n">new_intersections</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">combination</span> <span class="ow">in</span> <span class="n">final_combined</span><span class="p">:</span>
        <span class="n">combined_lanes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">combination</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="n">combined_lanes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intersections</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">lanes</span><span class="p">)</span>

        <span class="n">new_intersections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Intersection</span><span class="p">(</span><span class="n">combined_lanes</span><span class="p">,</span> <span class="n">concave_hull_ratio</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">concave_hull_ratio</span><span class="p">))</span>

    <span class="c1"># Add unvisited intersections</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">intersection</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intersections</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
            <span class="n">new_intersections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intersection</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">intersections</span> <span class="o">=</span> <span class="n">new_intersections</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.combine_isolated_connections" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">combine_isolated_connections</span><span class="p">(</span><span class="n">isolated_connections</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Check if any of the isolated connections are connecting the same intersections.
If yes, then combine them into one connection.
Args:
    isolated_connections (list): A list of ConnectionSegment objects representing isolated connections.
Returns:
    isolated_connections (list): A list of ConnectionSegment objects representing the combined isolated connections.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/maposicenterlinesegmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">combine_isolated_connections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isolated_connections</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if any of the isolated connections are connecting the same intersections.</span>
<span class="sd">    If yes, then combine them into one connection.</span>
<span class="sd">    Args:</span>
<span class="sd">        isolated_connections (list): A list of ConnectionSegment objects representing isolated connections.</span>
<span class="sd">    Returns:</span>
<span class="sd">        isolated_connections (list): A list of ConnectionSegment objects representing the combined isolated connections.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">isolated_connections</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="c1"># Group connections by their intersection indices for efficient comparison</span>
    <span class="n">connections_by_intersections</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">connection</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">isolated_connections</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">intersection_idxs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">connections_by_intersections</span><span class="p">:</span>
            <span class="n">connections_by_intersections</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">connections_by_intersections</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="n">combined_connections</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Process each group of connections with same intersection indices</span>
    <span class="k">for</span> <span class="n">intersection_set</span><span class="p">,</span> <span class="n">connection_indices</span> <span class="ow">in</span> <span class="n">connections_by_intersections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">connection_indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersection_set</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Multiple intersections: combine all connections</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">connection_indices</span><span class="p">)):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">connection_indices</span><span class="p">)):</span>
                        <span class="n">combined_connections</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">connection_indices</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">connection_indices</span><span class="p">[</span><span class="n">j</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Single intersection: check distance</span>
                <span class="n">connections_to_check</span> <span class="o">=</span> <span class="p">[</span><span class="n">isolated_connections</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">connection_indices</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">connections_to_check</span><span class="p">)):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">connections_to_check</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="n">connections_to_check</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">connections_to_check</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">polygon</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                            <span class="n">combined_connections</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">connection_indices</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">connection_indices</span><span class="p">[</span><span class="n">j</span><span class="p">]])</span>

    <span class="c1"># Rest of the method remains the same</span>
    <span class="n">final_combined</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_resulting_intersections</span><span class="p">(</span><span class="n">combined_connections</span><span class="p">)</span>
    <span class="n">new_connections</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">combination</span> <span class="ow">in</span> <span class="n">final_combined</span><span class="p">:</span>
        <span class="n">combined_lanes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">combination</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="n">combined_lanes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">isolated_connections</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">lanes</span><span class="p">)</span>
        <span class="n">new_connections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ConnectionSegment</span><span class="p">(</span><span class="n">combined_lanes</span><span class="p">,</span> <span class="n">concave_hull_ratio</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">concave_hull_ratio</span><span class="p">))</span>

    <span class="c1"># Add unvisited connections</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">connection</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">isolated_connections</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
            <span class="n">new_connections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">isolated_connections</span> <span class="o">=</span> <span class="n">new_connections</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">isolated_connections</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.create_intersection_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_intersection_dict</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Creats a dictionary where the key is the intersection id and the value is the intersection object.
Args:
    None
Returns:
    None</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/maposicenterlinesegmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_intersection_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creats a dictionary where the key is the intersection id and the value is the intersection object.</span>
<span class="sd">    Args:</span>
<span class="sd">        None</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">intersection_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">intersection</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intersections</span><span class="p">):</span>
        <span class="n">intersection_dict</span><span class="p">[</span><span class="n">intersection</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">intersection</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">intersection_dict</span> <span class="o">=</span> <span class="n">intersection_dict</span>
    <span class="k">return</span> <span class="n">intersection_dict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.create_lane_segment_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_lane_segment_dict</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Create a dictionary mapping lane IDs to their segment information.
Args:
    None
Returns:
    lane_segment_dict (dict): A dictionary mapping lane IDs to their segment information.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/maposicenterlinesegmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_lane_segment_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a dictionary mapping lane IDs to their segment information.</span>
<span class="sd">    Args:</span>
<span class="sd">        None</span>
<span class="sd">    Returns:</span>
<span class="sd">        lane_segment_dict (dict): A dictionary mapping lane IDs to their segment information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">segment_name</span> <span class="o">=</span> <span class="n">nt</span><span class="p">(</span><span class="s2">&quot;SegmentName&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;lane_id&quot;</span><span class="p">,</span> <span class="s2">&quot;segment_idx&quot;</span><span class="p">,</span> <span class="s2">&quot;segment&quot;</span><span class="p">])</span>
    <span class="n">segment_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersections</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">isolated_connections</span>

    <span class="c1"># Initialize with None values more efficiently</span>
    <span class="n">lane_segment_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">lane_id</span><span class="p">:</span> <span class="n">segment_name</span><span class="p">(</span><span class="n">lane_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">lane_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>

    <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">segment_list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="n">segment</span><span class="o">.</span><span class="n">lanes</span><span class="p">:</span>
            <span class="n">lane_id</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">lane_id</span>

            <span class="c1"># Single lookup with caching</span>
            <span class="n">current_entry</span> <span class="o">=</span> <span class="n">lane_segment_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lane_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">current_entry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">current_entry</span><span class="o">.</span><span class="n">segment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Lane not assigned to any segment yet</span>
                <span class="n">lane_segment_dict</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">segment_name</span><span class="p">(</span><span class="n">lane_id</span><span class="p">,</span> <span class="n">segment</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">segment</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">current_entry</span><span class="o">.</span><span class="n">segment_idx</span> <span class="o">!=</span> <span class="n">segment</span><span class="o">.</span><span class="n">idx</span><span class="p">:</span>
                <span class="c1"># Conflict: lane already assigned to different segment</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Lane </span><span class="si">{</span><span class="n">lane_id</span><span class="si">}</span><span class="s2"> already in segment </span><span class="si">{</span><span class="n">current_entry</span><span class="o">.</span><span class="n">segment_idx</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;cannot assign to segment </span><span class="si">{</span><span class="n">segment</span><span class="o">.</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span> <span class="o">=</span> <span class="n">lane_segment_dict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.create_non_intersecting_lane_graph" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_non_intersecting_lane_graph</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Create a graph with each lane which is not part of a intersection as a node and the edges are the successors and predecessors of the lanes.
Args:
    None
Returns:
    G (networkx.Graph): A graph with each lane as a node and the edges are the successors and predecessors of the lanes.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/maposicenterlinesegmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_non_intersecting_lane_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a graph with each lane which is not part of a intersection as a node and the edges are the successors and predecessors of the lanes.</span>
<span class="sd">    Args:</span>
<span class="sd">        None</span>
<span class="sd">    Returns:</span>
<span class="sd">        G (networkx.Graph): A graph with each lane as a node and the edges are the successors and predecessors of the lanes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">lane_id</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">lane_id</span>
        <span class="k">if</span> <span class="n">lane_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]</span><span class="o">.</span><span class="n">segment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">lane_id</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">successor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_successors_dict</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">successor</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span><span class="p">[</span><span class="n">successor</span><span class="p">]</span><span class="o">.</span><span class="n">segment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">lane_id</span><span class="p">,</span> <span class="n">successor</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">predecessor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_predecessors_dict</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">predecessor</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span><span class="p">[</span><span class="n">predecessor</span><span class="p">]</span><span class="o">.</span><span class="n">segment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">lane_id</span><span class="p">,</span> <span class="n">predecessor</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">G</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.create_parallel_lane_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_parallel_lane_dict</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Creates a dictionary mapping each lane's lane_id to the lane ids which are parallel to it
Args:
    None
Returns:
    dict: A dictionary mapping each lane's lane_id to the lane ids which are parallel to it.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/maposicenterlinesegmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_parallel_lane_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a dictionary mapping each lane&#39;s lane_id to the lane ids which are parallel to it</span>
<span class="sd">    Args:</span>
<span class="sd">        None</span>
<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary mapping each lane&#39;s lane_id to the lane ids which are parallel to it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lane_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">lane_id</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">()}</span>

    <span class="c1"># Precompute lane directions for faster comparisons</span>
    <span class="n">lane_directions</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">lane_centerlines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lane_ids</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lane_directions</span><span class="p">[</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">lane_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">direction</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>
        <span class="n">lane_centerlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="p">)</span>
        <span class="n">lane_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">lane_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">lane_centerlines</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">lane_dict</span>

    <span class="c1"># Use original centerlines for spatial index, buffer only when needed</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">STRtree</span><span class="p">(</span><span class="n">lane_centerlines</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lane</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
        <span class="n">lane_id</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">lane_id</span>

        <span class="c1"># Create buffer only when querying, not storing it</span>
        <span class="n">buffer_geom</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">buffer_geom</span><span class="p">)</span>

        <span class="c1"># Clear the buffer immediately after use</span>
        <span class="k">del</span> <span class="n">buffer_geom</span>

        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
            <span class="n">other_lane_id</span> <span class="o">=</span> <span class="n">lane_ids</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">other_lane_id</span> <span class="o">==</span> <span class="n">lane_id</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Compare directions using dot product</span>
            <span class="n">dir1</span> <span class="o">=</span> <span class="n">lane_directions</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]</span>
            <span class="n">dir2</span> <span class="o">=</span> <span class="n">lane_directions</span><span class="p">[</span><span class="n">other_lane_id</span><span class="p">]</span>
            <span class="n">dot_product</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dir1</span><span class="p">,</span> <span class="n">dir2</span><span class="p">)),</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">angle_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">dot_product</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">angle_deg</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">lane_dict</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">other_lane_id</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">lane_dict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.find_isolated_connections" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">find_isolated_connections</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Find all isolated strings of connections in the graph. Then Check if any of those lanes would be part of an intersection.
Args:
    None
Returns:
    isolated_connections (list): A list of lists, where each inner list contains the indices of lanes that are part of an isolated connection.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/maposicenterlinesegmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find_isolated_connections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find all isolated strings of connections in the graph. Then Check if any of those lanes would be part of an intersection.</span>
<span class="sd">    Args:</span>
<span class="sd">        None</span>
<span class="sd">    Returns:</span>
<span class="sd">        isolated_connections (list): A list of lists, where each inner list contains the indices of lanes that are part of an isolated connection.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_non_intersecting_lane_graph</span><span class="p">()</span>
    <span class="n">isolated_connections</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">new_connections</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">nx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">G</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">component</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">isolated_connections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">ConnectionSegment</span><span class="p">(</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lane_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">component</span><span class="p">],</span> <span class="n">concave_hull_ratio</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">concave_hull_ratio</span>
                <span class="p">)</span>
            <span class="p">)</span>
    <span class="c1"># Check if any of the lanes in the isolated connections are part of an intersection</span>
    <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="n">isolated_connections</span><span class="p">:</span>
        <span class="n">pre</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">suc</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">lane_id</span> <span class="ow">in</span> <span class="n">connection</span><span class="o">.</span><span class="n">lane_ids</span><span class="p">:</span>
            <span class="c1"># Check if the lane has a predecessor or successor that is part of an intersection</span>
            <span class="k">for</span> <span class="n">successor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_successors_dict</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">successor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span><span class="p">[</span><span class="n">successor</span><span class="p">]</span><span class="o">.</span><span class="n">segment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">connection</span><span class="o">.</span><span class="n">intersection_idxs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span><span class="p">[</span><span class="n">successor</span><span class="p">]</span><span class="o">.</span><span class="n">segment_idx</span><span class="p">)</span>
                    <span class="n">suc</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">predecessor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_predecessors_dict</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">predecessor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span><span class="p">[</span><span class="n">predecessor</span><span class="p">]</span><span class="o">.</span><span class="n">segment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="p">):</span>
                    <span class="n">connection</span><span class="o">.</span><span class="n">intersection_idxs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span><span class="p">[</span><span class="n">predecessor</span><span class="p">]</span><span class="o">.</span><span class="n">segment_idx</span><span class="p">)</span>
                    <span class="n">pre</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">intersection_idxs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">pre</span> <span class="ow">and</span> <span class="n">suc</span><span class="p">:</span>
            <span class="c1"># There is a predecessor and a successor that are part of an intersection so the connection is part of the intersection:</span>
            <span class="c1"># Add all the lanes to the intersection:</span>
            <span class="k">for</span> <span class="n">lane_id</span> <span class="ow">in</span> <span class="n">connection</span><span class="o">.</span><span class="n">lane_ids</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">intersection_dict</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">intersection_idxs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lane_dict</span><span class="p">[</span><span class="n">lane_id</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">intersection_dict</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">intersection_idxs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">lane_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lane_id</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">intersection_dict</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">intersection_idxs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">update_polygon</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_connections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>

    <span class="n">isolated_connections</span> <span class="o">=</span> <span class="n">new_connections</span>
    <span class="c1"># Create ConnectionSegment for all lanes, that are on multiple intersections:</span>

    <span class="n">isolated_connections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_isolated_connections</span><span class="p">(</span><span class="n">isolated_connections</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">isolated_connections</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.get_intersecting_lanes" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_intersecting_lanes</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Returns a dictionary mapping each lane's lane_id to an array of lane ids it intersects with.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>lanes</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Array of lane objects, each with an <code>idx</code> and <code>centerline</code> attribute.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary where keys are lane ids and values are arrays of intersecting lane ids.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/maposicenterlinesegmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_intersecting_lanes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a dictionary mapping each lane&#39;s lane_id to an array of lane ids it intersects with.</span>

<span class="sd">    Args:</span>
<span class="sd">        lanes (list): Array of lane objects, each with an `idx` and `centerline` attribute.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary where keys are lane ids and values are arrays of intersecting lane ids.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">buffer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_buffer</span>

    <span class="c1"># Create spatial index directly from centerlines</span>
    <span class="n">lane_centerlines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lane_ids</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">lane_centerlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="p">)</span>
        <span class="n">lane_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">lane_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">lane_centerlines</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intersecting_lanes_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">tree</span> <span class="o">=</span> <span class="n">STRtree</span><span class="p">(</span><span class="n">lane_centerlines</span><span class="p">)</span>

    <span class="c1"># Pre-compute lane relationships for faster lookup</span>
    <span class="n">successors_set</span> <span class="o">=</span> <span class="p">{</span><span class="n">lane_id</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">successors</span><span class="p">)</span> <span class="k">for</span> <span class="n">lane_id</span><span class="p">,</span> <span class="n">successors</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_successors_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">predecessors_set</span> <span class="o">=</span> <span class="p">{</span><span class="n">lane_id</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">predecessors</span><span class="p">)</span> <span class="k">for</span> <span class="n">lane_id</span><span class="p">,</span> <span class="n">predecessors</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_predecessors_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">parallel_set</span> <span class="o">=</span> <span class="p">{</span><span class="n">lane_id</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">parallel</span><span class="p">)</span> <span class="k">for</span> <span class="n">lane_id</span><span class="p">,</span> <span class="n">parallel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel_lane_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="n">intersecting_lanes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lane</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
        <span class="n">lane_id</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">lane_id</span>

        <span class="c1"># Query spatial index with buffered geometry</span>
        <span class="n">buffered_centerline</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">buffered_centerline</span><span class="p">)</span>

        <span class="n">intersecting_lanes</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
            <span class="n">candidate_id</span> <span class="o">=</span> <span class="n">lane_ids</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">candidate_id</span> <span class="o">!=</span> <span class="n">lane_id</span>
                <span class="ow">and</span> <span class="n">candidate_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">successors_set</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]</span>
                <span class="ow">and</span> <span class="n">candidate_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">predecessors_set</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]</span>
                <span class="ow">and</span> <span class="n">candidate_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parallel_set</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]</span>
                <span class="ow">and</span> <span class="n">buffered_centerline</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">lane_centerlines</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
            <span class="p">):</span>
                <span class="c1"># Only buffer and test intersection for valid candidates</span>
                <span class="n">intersecting_lanes</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">candidate_id</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">intersecting_lanes_dict</span> <span class="o">=</span> <span class="n">intersecting_lanes</span>
    <span class="k">return</span> <span class="n">intersecting_lanes</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.graph_intersection_detection" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">graph_intersection_detection</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Detects intersections in a graph of lanes based on their intersections, successors, and predecessors.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>lane_dict</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary where keys are lane indices and values are arrays of intersecting lane indices.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>lane_successors</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary where keys are lane indices and values are arrays of successor lane indices.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>lane_predecessors</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary where keys are lane indices and values are arrays of predecessor lane indices.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>list</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of intersections, where each intersection is a set of lane indices.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/maposicenterlinesegmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">graph_intersection_detection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detects intersections in a graph of lanes based on their intersections, successors, and predecessors.</span>

<span class="sd">    Args:</span>
<span class="sd">        lane_dict (dict): A dictionary where keys are lane indices and values are arrays of intersecting lane indices.</span>
<span class="sd">        lane_successors (dict): A dictionary where keys are lane indices and values are arrays of successor lane indices.</span>
<span class="sd">        lane_predecessors (dict): A dictionary where keys are lane indices and values are arrays of predecessor lane indices.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: A list of intersections, where each intersection is a set of lane indices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create a Graph using networkx</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>

    <span class="c1"># Add nodes and edges to the graph. If a lane has a intersection, add the lanes as nodes and the intersection as an edge</span>
    <span class="c1"># Add edges directly (nodes are added automatically)</span>
    <span class="k">for</span> <span class="n">lane_id</span><span class="p">,</span> <span class="n">intersecting_lanes</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersecting_lanes_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">((</span><span class="n">lane_id</span><span class="p">,</span> <span class="n">other_lane</span><span class="p">)</span> <span class="k">for</span> <span class="n">other_lane</span> <span class="ow">in</span> <span class="n">intersecting_lanes</span><span class="p">)</span>

    <span class="n">intersections</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">inter</span> <span class="ow">in</span> <span class="n">nx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">G</span><span class="p">):</span>
        <span class="c1"># Convert lane_ids back to lane objects</span>
        <span class="n">intersection_lanes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lane_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">inter</span><span class="p">]</span>
        <span class="n">intersection</span> <span class="o">=</span> <span class="n">Intersection</span><span class="p">(</span><span class="n">intersection_lanes</span><span class="p">,</span> <span class="n">concave_hull_ratio</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">concave_hull_ratio</span><span class="p">)</span>
        <span class="n">intersections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intersection</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">intersections</span> <span class="o">=</span> <span class="n">intersections</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="n">G</span>
    <span class="k">return</span> <span class="n">intersections</span><span class="p">,</span> <span class="n">G</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.init_intersections" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">init_intersections</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initializes the intersections in the map.
Args:
    None
Returns:
    None</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/maposicenterlinesegmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">init_intersections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes the intersections in the map.</span>
<span class="sd">    Args:</span>
<span class="sd">        None</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">create_lane_dict</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">get_lane_successors_and_predecessors</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">parallel_lane_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_parallel_lane_dict</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">get_intersecting_lanes</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">set_lane_trafficlights</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">graph_intersection_detection</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="n">add_lanexy_to_graph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">set_intersection_idx</span><span class="p">()</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_combine_intersections</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_non_intersecting_lanes_to_intersection</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combine_intersections</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_intersection_idx</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_intersection_dict</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">create_lane_segment_dict</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">find_isolated_connections</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">create_lane_segment_dict</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check_if_all_lanes_are_on_segment</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update_segment_ids</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">create_lane_segment_dict</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update_road_ids</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">set_lane_intersection_relation</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.intersections_overlap" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">intersections_overlap</span><span class="p">(</span><span class="n">intersection1</span><span class="p">,</span> <span class="n">intersection2</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Check if two intersections overlap.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>intersection1</code>
            </td>
            <td>
                  <code><span title="omega_prime.maposicenterlinesegmentation.Intersection">Intersection</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The first intersection object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>intersection2</code>
            </td>
            <td>
                  <code><span title="omega_prime.maposicenterlinesegmentation.Intersection">Intersection</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The second intersection object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if the intersections overlap, False otherwise.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/maposicenterlinesegmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">intersections_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intersection1</span><span class="p">,</span> <span class="n">intersection2</span><span class="p">,</span> <span class="n">buffer</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if two intersections overlap.</span>

<span class="sd">    Args:</span>
<span class="sd">        intersection1 (Intersection): The first intersection object.</span>
<span class="sd">        intersection2 (Intersection): The second intersection object.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True if the intersections overlap, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">buffer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersection_overlap_buffer</span>

    <span class="c1"># Use cached buffers if available</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">intersection1</span><span class="p">,</span> <span class="s2">&quot;_buffered_polygon&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">intersection1</span><span class="o">.</span><span class="n">_buffer_value</span> <span class="o">!=</span> <span class="n">buffer</span><span class="p">:</span>
        <span class="n">intersection1</span><span class="o">.</span><span class="n">_buffered_polygon</span> <span class="o">=</span> <span class="n">intersection1</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
        <span class="n">intersection1</span><span class="o">.</span><span class="n">_buffer_value</span> <span class="o">=</span> <span class="n">buffer</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">intersection2</span><span class="p">,</span> <span class="s2">&quot;_buffered_polygon&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">intersection2</span><span class="o">.</span><span class="n">_buffer_value</span> <span class="o">!=</span> <span class="n">buffer</span><span class="p">:</span>
        <span class="n">intersection2</span><span class="o">.</span><span class="n">_buffered_polygon</span> <span class="o">=</span> <span class="n">intersection2</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
        <span class="n">intersection2</span><span class="o">.</span><span class="n">_buffer_value</span> <span class="o">=</span> <span class="n">buffer</span>

    <span class="k">return</span> <span class="n">intersection1</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">intersection2</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.plot" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot</span><span class="p">(</span><span class="n">output_plot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trajectory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_lane_ids</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_intersection_polygons</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_connection_polygons</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Plots the intersections and saves the plot to the specified output path.
A Trajectory can be given to plot it on the map. The Trajectory should be a numpy array of shape (n,3) where each row is (frame, x, y)
Args:
    output_plot (Path): Path to a folder where the plot will be saved. If None, the plot will be shown instead.
    trajectory (numpy.ndarray): The trajectory to be plotted. If None, no trajectory will be plotted.
    plot_lane_ids (bool): Whether to plot lane IDs on the map.
    plot_intersection_polygons (bool): Whether to plot intersection polygons.
    plot_connection_polygons (bool): Whether to plot connection polygons.
Returns:
    None</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/maposicenterlinesegmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">output_plot</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">trajectory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">plot_lane_ids</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">plot_intersection_polygons</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">plot_connection_polygons</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots the intersections and saves the plot to the specified output path.</span>
<span class="sd">    A Trajectory can be given to plot it on the map. The Trajectory should be a numpy array of shape (n,3) where each row is (frame, x, y)</span>
<span class="sd">    Args:</span>
<span class="sd">        output_plot (Path): Path to a folder where the plot will be saved. If None, the plot will be shown instead.</span>
<span class="sd">        trajectory (numpy.ndarray): The trajectory to be plotted. If None, no trajectory will be plotted.</span>
<span class="sd">        plot_lane_ids (bool): Whether to plot lane IDs on the map.</span>
<span class="sd">        plot_intersection_polygons (bool): Whether to plot intersection polygons.</span>
<span class="sd">        plot_connection_polygons (bool): Whether to plot connection polygons.</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Plot the map by plotting all the centerlines:</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">c</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span>
        <span class="k">if</span> <span class="n">lane</span><span class="o">.</span><span class="n">on_intersection</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span>
        <span class="k">elif</span> <span class="n">lane</span><span class="o">.</span><span class="n">is_approaching</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="s2">&quot;orange&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_lane_ids</span><span class="p">:</span>
        <span class="n">lane_midpoints</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">normalized</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">lane_id</span><span class="p">,</span> <span class="n">midpoint</span> <span class="ow">in</span> <span class="n">lane_midpoints</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">lane_id</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">midpoint</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">midpoint</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">inter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersections</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">inter</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="n">inter</span><span class="o">.</span><span class="n">get_center_point</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot_intersection_polygons</span><span class="p">:</span>
            <span class="c1"># Plot the polygon into the intersection</span>
            <span class="n">inter</span><span class="o">.</span><span class="n">update_polygon</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">inter</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">combi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">isolated_connections</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">combi</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="n">combi</span><span class="o">.</span><span class="n">get_center_point</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
        <span class="c1"># Plot the polygon into the intersection</span>
        <span class="k">if</span> <span class="n">plot_connection_polygons</span><span class="p">:</span>
            <span class="n">combi</span><span class="o">.</span><span class="n">update_polygon</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">combi</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection </span><span class="si">{</span><span class="n">combi</span><span class="o">.</span><span class="n">idx</span><span class="si">}</span><span class="s2"> has no polygon&quot;</span><span class="p">)</span>
                <span class="k">pass</span>

    <span class="k">for</span> <span class="n">tl_idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trafficlight</span><span class="p">:</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trafficlight</span><span class="p">[</span><span class="n">tl_idx</span><span class="p">]</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trafficlight</span><span class="p">[</span><span class="n">tl_idx</span><span class="p">]</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
            <span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
            <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Traffic Light </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">trafficlight</span><span class="p">[</span><span class="n">tl_idx</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Plot the trajectory if it is given</span>
    <span class="k">if</span> <span class="n">trajectory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">trajectory</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">trajectory</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;yellow&quot;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Host Vehicle Trajectory&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Mark start and end points</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">trajectory</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">trajectory</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;go&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Start&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">trajectory</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">trajectory</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;ro&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;End&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">*</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">())</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">*</span><span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">())</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Map with Intersections&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;X Coordinate (m)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Y Coordinate (m)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">output_plot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output_plot</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
            <span class="n">output_plot</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_plot</span> <span class="o">/</span> <span class="s2">&quot;Map_with_Intersection.pdf&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">output_plot</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="n">output_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_plot</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">output_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="n">output_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_path</span> <span class="o">/</span> <span class="s2">&quot;Map_with_Intersection.pdf&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">output_path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">:</span>
                <span class="n">output_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.plot_intersections" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_intersections</span><span class="p">(</span><span class="n">output_plot</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Plots all intersections and saves them to the output path.
Args:
    output_plot (Path): Path to a folder where the plots will be saved.
Returns:
    None</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/maposicenterlinesegmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_intersections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_plot</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots all intersections and saves them to the output path.</span>
<span class="sd">    Args:</span>
<span class="sd">        output_plot (Path): Path to a folder where the plots will be saved.</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">intersection</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intersections</span><span class="p">):</span>
        <span class="n">intersection</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">output_plot</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">connection</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">isolated_connections</span><span class="p">):</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">output_plot</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.set_intersection_idx" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_intersection_idx</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Sets the index for each intersection in the list of intersections.
Args:
    None
Returns:
    None</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/maposicenterlinesegmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_intersection_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets the index for each intersection in the list of intersections.</span>
<span class="sd">    Args:</span>
<span class="sd">        None</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">intersection</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intersections</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">isolated_connections</span><span class="p">):</span>
        <span class="n">intersection</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">i</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.set_lane_intersection_relation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_lane_intersection_relation</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Sets the attribute lane.is_approaching true if the lane is connecting to an intersection.
Sets the attribute lane.on_intersection true if the lane is part of an intersection.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/maposicenterlinesegmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_lane_intersection_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets the attribute lane.is_approaching true if the lane is connecting to an intersection.</span>
<span class="sd">    Sets the attribute lane.on_intersection true if the lane is part of an intersection.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_lane_on_intersection</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_lane_is_approaching</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Process intersection lanes and their predecessors efficiently</span>
    <span class="k">for</span> <span class="n">intersection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersections</span><span class="p">:</span>
        <span class="c1"># Mark intersection lanes</span>
        <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="n">intersection</span><span class="o">.</span><span class="n">lanes</span><span class="p">:</span>
            <span class="n">lane_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lane_id</span><span class="p">(</span><span class="n">lane</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lane_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_lane_on_intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="p">[</span><span class="n">lane_id</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Process predecessors for each lane in the intersection</span>
            <span class="k">for</span> <span class="n">predecessor_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lane_predecessors</span><span class="p">(</span><span class="n">lane</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">predecessor_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_dict</span><span class="p">:</span>
                    <span class="n">predecessor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_dict</span><span class="p">[</span><span class="n">predecessor_id</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lane_on_intersection</span><span class="p">(</span><span class="n">predecessor</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_set_lane_is_approaching</span><span class="p">(</span><span class="n">predecessor</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.set_lane_trafficlights" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_lane_trafficlights</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Sets the traffic lights for each lane of the map.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/maposicenterlinesegmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_lane_trafficlights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets the traffic lights for each lane of the map.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create spatial index for lane centerlines</span>
    <span class="n">lane_centerlines</span> <span class="o">=</span> <span class="p">[</span><span class="n">lane</span><span class="o">.</span><span class="n">centerline</span> <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
    <span class="n">lane_objects</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="n">tree</span> <span class="o">=</span> <span class="n">STRtree</span><span class="p">(</span><span class="n">lane_centerlines</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">tl_idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trafficlight</span><span class="p">:</span>
        <span class="n">traffic_light_found</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Create traffic light position point</span>
        <span class="n">tl_point</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trafficlight</span><span class="p">[</span><span class="n">tl_idx</span><span class="p">]</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trafficlight</span><span class="p">[</span><span class="n">tl_idx</span><span class="p">]</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

        <span class="c1"># Use spatial index to find candidate lanes</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">nearest</span><span class="p">(</span><span class="n">tl_point</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">candidates</span><span class="p">:</span>
            <span class="n">lane</span> <span class="o">=</span> <span class="n">lane_objects</span><span class="p">[</span><span class="n">candidates</span><span class="p">]</span>
            <span class="n">lane</span><span class="o">.</span><span class="n">traffic_light</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trafficlight</span><span class="p">[</span><span class="n">tl_idx</span><span class="p">]</span>
            <span class="n">traffic_light_found</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">traffic_light_found</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Traffic light </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">trafficlight</span><span class="p">[</span><span class="n">tl_idx</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> not found in any lane&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.trajectory_segment_detection" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">trajectory_segment_detection</span><span class="p">(</span><span class="n">trajectory</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Splits a trajectory into segments based on the lane it is located on</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>trajectory</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A NumPy array of shape (n, 3) representing the trajectory, where each row is a (frame, x, y) coordinate.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>list</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of tuples, where each tuple contains a segment of the trajectory and the segment it intersects with.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/maposicenterlinesegmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">trajectory_segment_detection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectory</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Splits a trajectory into segments based on the lane it is located on</span>

<span class="sd">    Args:</span>
<span class="sd">        trajectory (np.ndarray): A NumPy array of shape (n, 3) representing the trajectory, where each row is a (frame, x, y) coordinate.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: A list of tuples, where each tuple contains a segment of the trajectory and the segment it intersects with.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">segments</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">current_segment</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">xy</span> <span class="o">=</span> <span class="n">trajectory</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># Extract x and y coordinates</span>
    <span class="n">sts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locator</span><span class="o">.</span><span class="n">xys2sts</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>
    <span class="n">lane_ids</span> <span class="o">=</span> <span class="n">sts</span><span class="p">[</span><span class="s2">&quot;roadlane_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">segment_idx</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span><span class="p">[</span><span class="n">lane_id</span><span class="o">.</span><span class="n">lane_id</span><span class="p">]</span><span class="o">.</span><span class="n">segment</span><span class="o">.</span><span class="n">idx</span> <span class="k">for</span> <span class="n">lane_id</span> <span class="ow">in</span> <span class="n">lane_ids</span><span class="p">]</span>

    <span class="n">trajectory</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">trajectory</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">trajectory</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">trajectory</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">lane_ids</span><span class="p">,</span> <span class="n">segment_idx</span><span class="p">))</span>

    <span class="c1"># Create spatial index for intersection polygons</span>
    <span class="n">intersection_polygons</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">intersection_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="mi">5</span>

    <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">segment</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">MapSegmentType</span><span class="o">.</span><span class="n">JUNCTION</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="s2">&quot;polygon&quot;</span><span class="p">):</span>
            <span class="n">intersection_polygons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">segment</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span>
            <span class="n">intersection_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">segment</span><span class="o">.</span><span class="n">idx</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">intersection_polygons</span><span class="p">:</span>
        <span class="c1"># Use spatial index for efficient intersection queries</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">STRtree</span><span class="p">(</span><span class="n">intersection_polygons</span><span class="p">)</span>

        <span class="c1"># Process points in batches for better performance</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">trajectory</span><span class="p">):</span>
            <span class="n">point</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

            <span class="c1"># Query spatial index instead of checking all polygons</span>
            <span class="n">candidates</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">intersection_polygons</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">point</span><span class="p">):</span>
                    <span class="n">trajectory</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">intersection_ids</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="k">break</span>

    <span class="c1"># Rest of the method for creating segments</span>
    <span class="n">prev_seg_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">segment_idx</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">trajectory</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">prev_seg_id</span> <span class="o">==</span> <span class="n">segment_idx</span><span class="p">:</span>
            <span class="n">current_segment</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">frame</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">current_segment</span><span class="p">:</span>
                <span class="n">segments</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">current_segment</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">[</span><span class="n">prev_seg_id</span><span class="p">]))</span>
            <span class="n">current_segment</span> <span class="o">=</span> <span class="p">[(</span><span class="n">frame</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)]</span>
            <span class="n">prev_seg_id</span> <span class="o">=</span> <span class="n">segment_idx</span>

    <span class="k">if</span> <span class="n">current_segment</span><span class="p">:</span>
        <span class="n">segments</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">current_segment</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">[</span><span class="n">prev_seg_id</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">segments</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.update_road_ids" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_road_ids</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Updates the road_ids of the lane to the segment ID</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/maposicenterlinesegmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_road_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates the road_ids of the lane to the segment ID</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">updates_needed</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">old_to_new_mapping</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># First pass: identify what needs to be updated</span>
    <span class="k">for</span> <span class="n">lane_idx</span><span class="p">,</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">lane_id</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">lane_id</span>
        <span class="k">if</span> <span class="n">lane_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]</span><span class="o">.</span><span class="n">segment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_road_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_segment_dict</span><span class="p">[</span><span class="n">lane_id</span><span class="p">]</span><span class="o">.</span><span class="n">segment</span><span class="o">.</span><span class="n">idx</span>
            <span class="k">if</span> <span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">road_id</span> <span class="o">!=</span> <span class="n">new_road_id</span><span class="p">:</span>
                <span class="n">new_idx</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">road_id</span><span class="o">=</span><span class="n">new_road_id</span><span class="p">)</span>
                <span class="n">updates_needed</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">lane_idx</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">new_idx</span><span class="p">))</span>
                <span class="n">old_to_new_mapping</span><span class="p">[</span><span class="n">lane_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_idx</span>

    <span class="c1"># Second pass: apply updates efficiently</span>
    <span class="k">for</span> <span class="n">old_idx</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">new_idx</span> <span class="ow">in</span> <span class="n">updates_needed</span><span class="p">:</span>
        <span class="c1"># Update the lane object in place</span>
        <span class="n">lane</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">new_idx</span>

        <span class="c1"># Only modify dictionary if the key actually changed</span>
        <span class="k">if</span> <span class="n">old_idx</span> <span class="o">!=</span> <span class="n">new_idx</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="p">[</span><span class="n">new_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">lane</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="p">[</span><span class="n">old_idx</span><span class="p">]</span>

    <span class="c1"># Third pass: update all predecessor and successor references</span>
    <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="c1"># Update predecessor references</span>
        <span class="n">updated_predecessors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pred_id</span> <span class="ow">in</span> <span class="n">lane</span><span class="o">.</span><span class="n">predecessor_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pred_id</span> <span class="ow">in</span> <span class="n">old_to_new_mapping</span><span class="p">:</span>
                <span class="n">updated_predecessors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">old_to_new_mapping</span><span class="p">[</span><span class="n">pred_id</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">updated_predecessors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred_id</span><span class="p">)</span>
        <span class="n">lane</span><span class="o">.</span><span class="n">predecessor_ids</span> <span class="o">=</span> <span class="n">updated_predecessors</span>

        <span class="c1"># Update successor references</span>
        <span class="n">updated_successors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">succ_id</span> <span class="ow">in</span> <span class="n">lane</span><span class="o">.</span><span class="n">successor_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">succ_id</span> <span class="ow">in</span> <span class="n">old_to_new_mapping</span><span class="p">:</span>
                <span class="n">updated_successors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">old_to_new_mapping</span><span class="p">[</span><span class="n">succ_id</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">updated_successors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">succ_id</span><span class="p">)</span>
        <span class="n">lane</span><span class="o">.</span><span class="n">successor_ids</span> <span class="o">=</span> <span class="n">updated_successors</span>

    <span class="c1"># Fourth pass: update internal dictionaries that track relationships</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lane_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">lane_id</span><span class="p">:</span> <span class="n">lane</span> <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">()}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">get_lane_successors_and_predecessors</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="omega_prime.maposicenterlinesegmentation.MapOsiCenterlineSegmentation.update_segment_ids" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_segment_ids</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Updates the segment IDs of the map segmentation</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/maposicenterlinesegmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_segment_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s2">&quot;Updates the segment IDs of the map segmentation&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">segments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersections</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">isolated_connections</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">segment</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">):</span>
        <span class="n">segment</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">i</span>
        <span class="n">segment</span><span class="o">.</span><span class="n">set_trafficlight</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="omega_prime.maposicenterlinesegmentation.SegmentOsiCenterline" class="doc doc-heading">
            <code>SegmentOsiCenterline</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" href="#omega_prime.mapsegment.Segment">Segment</a></code></p>



        <p>Segment implementation for OSI centerline-based maps.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>omega_prime/maposicenterlinesegmentation.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SegmentOsiCenterline</span><span class="p">(</span><span class="n">Segment</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Segment implementation for OSI centerline-based maps.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_lane_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">lane_id</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_lane_geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lane</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">shapely</span><span class="o">.</span><span class="n">LineString</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">lane</span><span class="o">.</span><span class="n">centerline</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_trafficlight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">trafficlight</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanes</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="s2">&quot;trafficlight&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lane</span><span class="o">.</span><span class="n">trafficlight</span><span class="p">:</span>
                <span class="n">trafficlight</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">trafficlight</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trafficlights</span> <span class="o">=</span> <span class="n">trafficlight</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="omega_prime.maposicenterlinesegmentation.add_lanexy_to_graph" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_lanexy_to_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">lanes</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Adds lane coordinates to the graph as node attributes.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>G</code>
            </td>
            <td>
                  <code><span title="networkx.Graph">Graph</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The graph to which lane coordinates will be added.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>lanes</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary of lane objects.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>networkx.Graph: The updated graph with lane coordinates as node attributes.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/maposicenterlinesegmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_lanexy_to_graph</span><span class="p">(</span><span class="n">G</span><span class="p">:</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">,</span> <span class="n">lanes</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds lane coordinates to the graph as node attributes.</span>

<span class="sd">    Args:</span>
<span class="sd">        G (networkx.Graph): The graph to which lane coordinates will be added.</span>
<span class="sd">        lanes (dict): A dictionary of lane objects.</span>

<span class="sd">    Returns:</span>
<span class="sd">        networkx.Graph: The updated graph with lane coordinates as node attributes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">lane</span> <span class="ow">in</span> <span class="n">lanes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">lane_id</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">lane_id</span><span class="p">][</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">centroid</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="p">)</span><span class="o">.</span><span class="n">x</span>
            <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">lane</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">lane_id</span><span class="p">][</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">centroid</span><span class="p">(</span><span class="n">lane</span><span class="o">.</span><span class="n">centerline</span><span class="p">)</span><span class="o">.</span><span class="n">y</span>
    <span class="k">return</span> <span class="n">G</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="omega_prime.maposicenterlinesegmentation.plot_graph" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Plots the graph with lane coordinates.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>G</code>
            </td>
            <td>
                  <code><span title="networkx.Graph">Graph</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The graph to be plotted.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Path</code>
            </td>
            <td>
                  <code><span title="str">str</span> or <span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The file path to save the plot.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>omega_prime/maposicenterlinesegmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_graph</span><span class="p">(</span><span class="n">G</span><span class="p">:</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots the graph with lane coordinates.</span>

<span class="sd">    Args:</span>
<span class="sd">        G (networkx.Graph): The graph to be plotted.</span>
<span class="sd">        Path (str or Path): The file path to save the plot.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="p">{</span><span class="n">node</span><span class="p">:</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">)}</span>
    <span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Intersection Graph&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;X Coordinate&quot;</span><span class="p">)</span>  <span class="c1"># Add label for the x-axis</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Y Coordinate&quot;</span><span class="p">)</span>  <span class="c1"># Add label for the y-axis</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Optional: Add a grid for better visualization</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">Path</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># Close the plot to free memory</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": ["navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.instant.preview", "toc.follow", "search.suggest", "search.highlight", "navigation.tracking", "navigation.sections"], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>